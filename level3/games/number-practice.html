<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f5576c">
    <link rel="manifest" href="../../manifest.json">
    <title>ğŸ”¢ æ•¸å­—ç·´ç¿’ (0-99)</title>
    <script src="../../js/config.js"></script>
    <script src="../../js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }

        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            margin: 10px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        .score-display {
            font-size: 1rem;
            color: #f5576c;
            font-weight: bold;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 5px 15px 10px;
            gap: 8px;
            overflow: hidden;
            min-height: 0;
        }

        .container {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
            height: 100%;
        }

        .title {
            flex-shrink: 0;
            text-align: center;
            color: white;
            font-size: 1.3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .progress-section {
            flex-shrink: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px;
        }
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s;
        }
        .progress-text {
            color: white;
            text-align: center;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .number-display {
            flex-shrink: 0;
            background: white;
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .number {
            font-size: 5rem;
            color: #f5576c;
            font-weight: bold;
            line-height: 1;
        }
        .number-zhuyin {
            font-size: 1.3rem;
            color: #f093fb;
            margin-top: 5px;
        }

        .mode-section {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .mode-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn.active {
            background: white;
            color: #f5576c;
        }

        /* ç¯„åœé¸æ“‡ */
        .range-section {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .range-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: white;
            cursor: pointer;
        }
        .range-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }

        .options-grid {
            flex-shrink: 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .option-btn {
            background: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
            min-height: 70px;
        }

        /* æŒ‰éˆ•é–ƒçˆæç¤ºå‹•ç•« */
        .highlight-btn {
            animation: btn-glow 1.5s ease-in-out infinite;
        }
        @keyframes btn-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 0 25px 8px rgba(240, 147, 251, 0.7), 0 0 50px 15px rgba(245, 87, 108, 0.4); }
        }

        /* éº¥å…‹é¢¨æŒ‰éˆ•ç‰¹åˆ¥é–ƒçˆ */
        .mic-highlight {
            animation: mic-glow 1.2s ease-in-out infinite;
        }
        @keyframes mic-glow {
            0%, 100% { box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
            50% { box-shadow: 0 0 30px 10px rgba(240, 147, 251, 0.8), 0 0 60px 20px rgba(245, 87, 108, 0.5); }
        }
        .option-btn:hover { transform: scale(1.05); }
        .option-btn.correct { background: #4caf50; color: white; }
        .option-btn.wrong { background: #f44336; color: white; }

        .action-buttons {
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .action-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            padding: 18px 32px;
            border-radius: 20px;
            font-size: 1.3rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            min-height: 65px;
            min-width: 140px;
        }
        .action-btn:active { transform: scale(0.95); }

        .result-message {
            flex-shrink: 0;
            text-align: center;
            font-size: 1.2rem;
            color: white;
            min-height: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* Responsive adjustments */
        @media (max-height: 600px) {
            .nav-bar { padding: 8px 12px; margin: 5px; }
            .game-area { padding: 3px 10px 5px; gap: 5px; }
            .title { font-size: 1.1rem; }
            .number-display { padding: 10px; }
            .number { font-size: 4rem; }
            .number-zhuyin { font-size: 1.1rem; }
            .mode-btn { padding: 5px 10px; font-size: 0.8rem; }
            .range-btn { padding: 4px 8px; font-size: 0.7rem; }
            .option-btn { padding: 12px; font-size: 1.3rem; }
            .action-btn { padding: 8px 14px; font-size: 0.9rem; }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .nav-bar { padding: 5px 10px; margin: 3px; }
            .game-area { padding: 3px 5px; gap: 4px; }
            .container { flex-direction: row; flex-wrap: wrap; max-width: none; gap: 5px; }
            .title { width: 100%; font-size: 1rem; }
            .mode-section { width: 100%; gap: 4px; }
            .range-section { width: 100%; gap: 4px; }
            .progress-section { width: 100%; padding: 5px; }
            .number-display { flex: 1; min-width: 150px; padding: 8px; }
            .number { font-size: 3rem; }
            .number-zhuyin { font-size: 1rem; margin-top: 3px; }
            .options-grid { flex: 1; min-width: 200px; gap: 6px; }
            .option-btn { padding: 10px; font-size: 1.2rem; }
            .action-buttons { width: 100%; gap: 5px; }
            .action-btn { padding: 6px 12px; font-size: 0.85rem; }
            .result-message { width: 100%; font-size: 1rem; }
        }

        .fireworks {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .firework {
            position: absolute;
            animation: firework-explode 1s ease-out forwards;
        }
        @keyframes firework-explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .complete-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .complete-overlay.show { display: flex; }
        .complete-content {
            background: white;
            padding: 50px;
            border-radius: 30px;
            text-align: center;
            max-width: 400px;
        }
        .complete-icon { font-size: 5rem; margin-bottom: 20px; }
        .complete-title { font-size: 2rem; color: #f5576c; margin-bottom: 15px; }
        .complete-score { font-size: 1.5rem; color: #666; margin-bottom: 25px; }
        .complete-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            border: none;
            padding: 18px 32px;
            border-radius: 30px;
            font-size: 1.3rem;
            color: white;
            cursor: pointer;
            margin: 5px;
            min-height: 65px;
            min-width: 140px;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 8px;
            margin-top: 20px;
        }
        .number-card {
            background: rgba(255,255,255,0.2);
            padding: 8px 4px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .number-card:hover {
            background: rgba(255,255,255,0.4);
            transform: scale(1.1);
        }
        .number-card.mastered {
            background: rgba(76, 175, 80, 0.5);
            border: 2px solid #4caf50;
        }
        .number-card .num {
            font-size: 1.1rem;
            color: white;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .number { font-size: 4rem; }
            .option-btn { font-size: 1.3rem; padding: 15px; }
            .number-grid { grid-template-columns: repeat(5, 1fr); }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="score-display">å¾—åˆ†ï¼š<span id="score">0</span></div>
    </nav>

    <div class="game-area">
        <div class="container">
            <h1 class="title">ğŸ”¢ æ•¸å­—ç·´ç¿’ (0-99)</h1>

            <div class="mode-section">
                <button class="mode-btn active" onclick="setMode('learn')">ğŸ“– å­¸ç¿’</button>
                <button class="mode-btn" onclick="setMode('listen')">ğŸ‘‚ è½éŸ³é¸æ•¸</button>
                <button class="mode-btn" onclick="setMode('speak')">ğŸ¤ çœ‹æ•¸å”¸å‡º</button>
            </div>

            <div class="range-section" id="rangeSection">
                <button class="range-btn active" onclick="setRange(0, 9)">0-9</button>
                <button class="range-btn" onclick="setRange(10, 30)">10-30</button>
                <button class="range-btn" onclick="setRange(31, 50)">31-50</button>
                <button class="range-btn" onclick="setRange(51, 70)">51-70</button>
                <button class="range-btn" onclick="setRange(71, 99)">71-99</button>
                <button class="range-btn" onclick="setRange(0, 99)">å…¨éƒ¨</button>
            </div>

            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text">ç¬¬ <span id="currentRound">1</span> / <span id="totalRounds">10</span> é¡Œ</div>
            </div>

            <div class="number-display">
                <div class="number" id="numberDisplay">0</div>
                <div class="number-zhuyin" id="zhuyinDisplay">ã„Œã„§ã„¥ËŠ</div>
            </div>

            <div class="options-grid" id="optionsGrid" style="display: none;"></div>

            <div class="action-buttons" id="actionButtons">
                <button class="action-btn highlight-btn" onclick="playSound()">ğŸ”Š è½ç™¼éŸ³</button>
                <button class="action-btn highlight-btn" onclick="nextNumber()">âš¡ æ›ä¸€å€‹</button>
                <button class="action-btn mic-highlight" id="speakBtn" onclick="startSpeaking()" style="display: none;">ğŸ¤ æˆ‘ä¾†å”¸</button>
                <button class="action-btn" id="manualSpeakBtn" onclick="manualSpeakConfirm()" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);">âœ… æˆ‘æœƒå”¸</button>
            </div>

            <div class="result-message" id="resultMessage"></div>

            <div class="number-grid" id="numberGrid"></div>
        </div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <div class="complete-overlay" id="completeOverlay">
        <div class="complete-content">
            <div class="complete-icon">ğŸ‰</div>
            <div class="complete-title">å¤ªæ£’äº†ï¼</div>
            <div class="complete-score" id="completeScore">å¾—åˆ†ï¼š100 åˆ†</div>
            <button class="complete-btn highlight-btn" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="complete-btn highlight-btn" onclick="location.href='../index.html'" style="background: linear-gradient(135deg, #f093fb, #f5576c);">ğŸ  è¿”å›é¸å–®</button>
        </div>
    </div>

    <script>
        // ç”Ÿæˆæ•¸å­—è³‡æ–™ (0-99)
        const DIGIT_TEXT = ['é›¶', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹'];
        const DIGIT_ZHUYIN = ['ã„Œã„§ã„¥ËŠ', 'ã„§', 'ã„¦Ë‹', 'ã„™ã„¢', 'ã„™Ë‹', 'ã„¨Ë‡', 'ã„Œã„§ã„¡Ë‹', 'ã„‘ã„§', 'ã„…ã„š', 'ã„ã„§ã„¡Ë‡'];

        function generateNumberData(num) {
            let text, zhuyin;
            if (num === 0) {
                text = 'é›¶';
                zhuyin = 'ã„Œã„§ã„¥ËŠ';
            } else if (num < 10) {
                text = DIGIT_TEXT[num];
                zhuyin = DIGIT_ZHUYIN[num];
            } else if (num === 10) {
                text = 'å';
                zhuyin = 'ã„•ËŠ';
            } else if (num < 20) {
                text = 'å' + DIGIT_TEXT[num - 10];
                zhuyin = 'ã„•ËŠ' + DIGIT_ZHUYIN[num - 10];
            } else {
                const tens = Math.floor(num / 10);
                const ones = num % 10;
                if (ones === 0) {
                    text = DIGIT_TEXT[tens] + 'å';
                    zhuyin = DIGIT_ZHUYIN[tens] + 'ã„•ËŠ';
                } else {
                    text = DIGIT_TEXT[tens] + 'å' + DIGIT_TEXT[ones];
                    zhuyin = DIGIT_ZHUYIN[tens] + 'ã„•ËŠ' + DIGIT_ZHUYIN[ones];
                }
            }
            return { num, text, zhuyin };
        }

        const ALL_NUMBERS = [];
        for (let i = 0; i <= 99; i++) {
            ALL_NUMBERS.push(generateNumberData(i));
        }

        const ENCOURAGEMENTS = ['å¤ªæ£’äº†ï¼', 'å¥½å²å®³ï¼', 'ç­”å°äº†ï¼', 'çœŸè°æ˜ï¼', 'å¾ˆæ£’å–”ï¼', 'è¶…ç´šå²å®³ï¼'];

        // å–å¾—ä½¿ç”¨è€…åç¨±
        function getUserName() {
            return localStorage.getItem('userName') || '';
        }

        // å–å¾—å¸¶åå­—çš„é¼“å‹µèª
        function getEncouragement() {
            const name = getUserName();
            const base = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
            return name ? `${name}ï¼Œ${base}` : base;
        }

        let currentMode = 'learn';
        let currentNumber = null;
        let currentRound = 0;
        let totalRounds = 10;
        let score = 0;
        let questionQueue = [];
        let recognition = null;
        let isListening = false;
        let rangeStart = 0;
        let rangeEnd = 9;
        let masteredNumbers = new Set(JSON.parse(localStorage.getItem('masteredNumbers_0_99') || '[]'));

        function getNumbersInRange() {
            return ALL_NUMBERS.filter(n => n.num >= rangeStart && n.num <= rangeEnd);
        }

        function speak(text, callback) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.85;
                utterance.pitch = 1.1;
                if (callback) {
                    utterance.onend = callback;
                    setTimeout(() => { if (callback) callback(); }, 5000);
                }
                utterance.onerror = () => { if (callback) callback(); };
                window.speechSynthesis.speak(utterance);
            } else if (callback) {
                callback();
            }
        }

        // å¿«é€ŸçŸ­èªéŸ³æç¤º
        function speakShort(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.volume = 0.7;
                window.speechSynthesis.speak(utterance);
            }
        }

        function playSound() {
            speak(currentNumber.text);
        }

        function setRange(start, end) {
            rangeStart = start;
            rangeEnd = end;
            document.querySelectorAll('.range-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (currentMode === 'learn') {
                renderNumberGrid();
                nextNumber();
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('optionsGrid').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('numberGrid').style.display = mode === 'learn' ? 'grid' : 'none';
            document.getElementById('speakBtn').style.display = 'none';
            document.getElementById('resultMessage').textContent = '';
            document.getElementById('rangeSection').style.display = 'flex';

            if (mode === 'learn') {
                document.getElementById('actionButtons').style.display = 'flex';
                renderNumberGrid();
                nextNumber();
                speak('å­¸ç¿’æ¨¡å¼ï¼é»æ“Šæ•¸å­—è½ç™¼éŸ³ï¼');
            } else if (mode === 'listen') {
                startListenMode();
            } else if (mode === 'speak') {
                startSpeakMode();
            }
        }

        function renderNumberGrid() {
            const grid = document.getElementById('numberGrid');
            grid.innerHTML = '';

            getNumbersInRange().forEach(num => {
                const card = document.createElement('div');
                card.className = 'number-card';
                if (masteredNumbers.has(num.num)) card.classList.add('mastered');
                card.innerHTML = `<div class="num">${num.num}</div>`;
                card.onclick = () => {
                    currentNumber = num;
                    displayNumber();
                    playSound();
                };
                grid.appendChild(card);
            });
        }

        function nextNumber() {
            const numbers = getNumbersInRange();
            currentNumber = numbers[Math.floor(Math.random() * numbers.length)];
            displayNumber();
            setTimeout(playSound, 300);
        }

        function displayNumber() {
            document.getElementById('numberDisplay').textContent = currentNumber.num;
            document.getElementById('zhuyinDisplay').textContent = currentNumber.zhuyin;
        }

        function startListenMode() {
            // å…ˆèªªæ˜ç©æ³•ï¼Œç­‰ç”¨æˆ¶æº–å‚™å¥½å†é–‹å§‹
            speak('è½éŸ³é¸æ•¸æ¨¡å¼ï¼', () => {
                setTimeout(() => {
                    speak('è½åˆ°æ•¸å­—ç™¼éŸ³å¾Œï¼Œé¸å‡ºæ­£ç¢ºçš„æ•¸å­—ï¼æº–å‚™å¥½è«‹é»ã€Œç¢ºå®šã€', () => {
                        if (confirm('ğŸ® è½éŸ³é¸æ•¸æ¨¡å¼\n\nç©æ³•ï¼šè½åˆ°æ•¸å­—ç™¼éŸ³å¾Œï¼Œé¸å‡ºæ­£ç¢ºçš„æ•¸å­—\n\næº–å‚™å¥½äº†å—ï¼Ÿ')) {
                            actuallyStartListenMode();
                        } else {
                            setMode('learn');
                        }
                    });
                }, 300);
            });
        }

        function actuallyStartListenMode() {
            currentRound = 0;
            score = 0;
            const numbers = getNumbersInRange();
            questionQueue = shuffle([...numbers]).slice(0, Math.min(totalRounds, numbers.length));

            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('optionsGrid').style.display = 'grid';
            document.getElementById('actionButtons').style.display = 'none';
            document.getElementById('numberGrid').style.display = 'none';

            updateScore();
            speak('é–‹å§‹å›‰ï¼', () => {
                nextListenQuestion();
            });
        }

        function nextListenQuestion() {
            if (currentRound >= questionQueue.length) {
                endGame();
                return;
            }

            currentNumber = questionQueue[currentRound];
            currentRound++;

            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('totalRounds').textContent = questionQueue.length;
            document.getElementById('progressFill').style.width = ((currentRound - 1) / questionQueue.length * 100) + '%';
            document.getElementById('numberDisplay').textContent = '?';
            document.getElementById('zhuyinDisplay').textContent = 'è½ç™¼éŸ³é¸æ“‡';
            document.getElementById('resultMessage').textContent = '';

            generateOptions();
            setTimeout(() => speak(currentNumber.text), 500);
        }

        function generateOptions() {
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';

            const numbers = getNumbersInRange();
            let options = [currentNumber];
            while (options.length < 4 && options.length < numbers.length) {
                const rand = numbers[Math.floor(Math.random() * numbers.length)];
                if (!options.find(o => o.num === rand.num)) {
                    options.push(rand);
                }
            }
            options = shuffle(options);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn highlight-btn';
                btn.textContent = opt.num;
                btn.onclick = () => checkAnswer(btn, opt);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected) {
            const isCorrect = selected.num === currentNumber.num;
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

            if (isCorrect) {
                btn.classList.add('correct');
                score += 10;
                updateScore();
                saveMastered(currentNumber.num);

                const encouragement = getEncouragement();
                document.getElementById('resultMessage').textContent = 'âœ¨ ' + encouragement + ' âœ¨';
                document.getElementById('numberDisplay').textContent = currentNumber.num;
                document.getElementById('zhuyinDisplay').textContent = currentNumber.zhuyin;

                setTimeout(() => speak(encouragement), 500);
                createFireworks(20);
                setTimeout(nextListenQuestion, 2500);
            } else {
                btn.classList.add('wrong');
                document.getElementById('resultMessage').textContent = 'å†è©¦ä¸€æ¬¡ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ' + currentNumber.num;
                speak('å†è©¦ä¸€æ¬¡ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯' + currentNumber.text);

                setTimeout(() => {
                    document.querySelectorAll('.option-btn').forEach(b => {
                        b.disabled = false;
                        b.classList.remove('wrong');
                    });
                }, 1500);
            }
        }

        function startSpeakMode() {
            // å…ˆèªªæ˜ç©æ³•ï¼Œç­‰ç”¨æˆ¶æº–å‚™å¥½å†é–‹å§‹
            speak('çœ‹æ•¸å”¸å‡ºæ¨¡å¼ï¼', () => {
                setTimeout(() => {
                    speak('çœ‹åˆ°æ•¸å­—å¾Œï¼Œå¤§è²å”¸å‡ºä¾†ï¼æº–å‚™å¥½è«‹é»ã€Œç¢ºå®šã€', () => {
                        if (confirm('ğŸ¤ çœ‹æ•¸å”¸å‡ºæ¨¡å¼\n\nç©æ³•ï¼šçœ‹åˆ°æ•¸å­—å¾Œï¼Œé»éº¥å…‹é¢¨å¤§è²å”¸å‡ºä¾†\n\næº–å‚™å¥½äº†å—ï¼Ÿ')) {
                            actuallyStartSpeakMode();
                        } else {
                            setMode('learn');
                        }
                    });
                }, 300);
            });
        }

        function actuallyStartSpeakMode() {
            currentRound = 0;
            score = 0;
            const numbers = getNumbersInRange();
            questionQueue = shuffle([...numbers]).slice(0, Math.min(totalRounds, numbers.length));

            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('optionsGrid').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'flex';
            document.getElementById('speakBtn').style.display = 'inline-block';
            document.getElementById('numberGrid').style.display = 'none';

            initSpeechRecognition();
            updateScore();
            speak('é–‹å§‹å›‰ï¼', () => {
                nextSpeakQuestion();
            });
        }

        function nextSpeakQuestion() {
            if (currentRound >= questionQueue.length) {
                endGame();
                return;
            }

            currentNumber = questionQueue[currentRound];
            currentRound++;

            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('totalRounds').textContent = questionQueue.length;
            document.getElementById('progressFill').style.width = ((currentRound - 1) / questionQueue.length * 100) + '%';
            displayNumber();
            document.getElementById('resultMessage').textContent = 'çœ‹åˆ°é€™å€‹æ•¸å­—äº†å—ï¼Ÿé»æ“Šéº¥å…‹é¢¨å”¸å‡ºä¾†ï¼';
        }

        let recognitionFailed = false;
        let recognitionTimeout = null;
        let hasReceivedResult = false;
        let lastTranscript = '';

        // VAD ç›¸é—œè®Šæ•¸
        let audioContext = null;
        let analyser = null;
        let vadStream = null;
        let vadInterval = null;
        let hasDetectedVoice = false;
        const VAD_THRESHOLD = 50;
        const MIN_VOICE_DURATION = 300;
        let voiceStartTime = null;
        let totalVoiceDuration = 0;

        // éŒ„éŸ³ç›¸é—œè®Šæ•¸
        let mediaRecorder = null;
        let audioChunks = [];
        let lastRecordedAudioUrl = null;

        async function initVAD() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                vadStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const microphone = audioContext.createMediaStreamSource(vadStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.5;
                microphone.connect(analyser);

                // åˆå§‹åŒ–éŒ„éŸ³å™¨
                initRecorder(vadStream);

                console.log('âœ… VAD å’ŒéŒ„éŸ³åŠŸèƒ½åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('VAD åˆå§‹åŒ–å¤±æ•—:', error);
            }
        }

        // åˆå§‹åŒ–éŒ„éŸ³å™¨
        function initRecorder(stream) {
            try {
                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' :
                                MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
                mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                        if (lastRecordedAudioUrl) URL.revokeObjectURL(lastRecordedAudioUrl);
                        lastRecordedAudioUrl = URL.createObjectURL(audioBlob);
                    }
                };
            } catch (error) {
                console.error('éŒ„éŸ³å™¨åˆå§‹åŒ–å¤±æ•—:', error);
            }
        }

        // é–‹å§‹éŒ„éŸ³
        function startRecording() {
            if (!mediaRecorder) return;
            audioChunks = [];
            if (mediaRecorder.state === 'inactive') {
                try { mediaRecorder.start(); } catch (e) {}
            }
        }

        // åœæ­¢éŒ„éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                try { mediaRecorder.stop(); } catch (e) {}
            }
        }

        // å›æ”¾éŒ„éŸ³
        function playbackRecording() {
            return new Promise((resolve) => {
                if (!lastRecordedAudioUrl) { resolve(); return; }
                const audio = new Audio(lastRecordedAudioUrl);
                audio.onended = () => resolve();
                audio.onerror = () => resolve();
                audio.play().catch(() => resolve());
            });
        }

        // æ’­æ”¾èªéŸ³ï¼ˆè¿”å› Promiseï¼‰
        function speakAsync(text) {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window)) { resolve(); return; }
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.85;
                utterance.pitch = 1.1;
                utterance.onend = () => resolve();
                utterance.onerror = () => resolve();
                window.speechSynthesis.speak(utterance);
            });
        }

        // è¨ˆç®—æœ€å°éœ€è¦çš„è²éŸ³é•·åº¦
        function getMinVoiceDuration(text) {
            if (!text) return 500;
            return Math.max(400, text.length * 400);
        }

        function startVAD() {
            if (!analyser) return;
            hasDetectedVoice = false;
            voiceStartTime = null;
            totalVoiceDuration = 0;

            // é–‹å§‹éŒ„éŸ³
            startRecording();

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            let lastVoiceTime = null;

            vadInterval = setInterval(() => {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                const average = sum / dataArray.length;

                if (average > VAD_THRESHOLD) {
                    const now = Date.now();
                    if (!voiceStartTime) {
                        voiceStartTime = now;
                    }
                    // ç´¯è¨ˆè²éŸ³é•·åº¦
                    if (lastVoiceTime) {
                        totalVoiceDuration += (now - lastVoiceTime);
                    }
                    lastVoiceTime = now;

                    if (now - voiceStartTime > MIN_VOICE_DURATION && !hasDetectedVoice) {
                        hasDetectedVoice = true;
                        document.getElementById('resultMessage').textContent = 'ğŸ¤ è½åˆ°ä½ çš„è²éŸ³äº†ï¼æ­£åœ¨è¾¨è­˜...';
                        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                    }
                } else {
                    lastVoiceTime = null;
                }
            }, 50);
        }

        function stopVAD() {
            if (vadInterval) {
                clearInterval(vadInterval);
                vadInterval = null;
            }
            // åœæ­¢éŒ„éŸ³
            stopRecording();
        }

        function getListenDuration(text) {
            const len = text ? text.length : 1;
            if (len === 1) return 10000;      // å–®å­—ï¼š10ç§’ï¼ˆè¦å”¸2-3æ¬¡ï¼‰
            if (len <= 3) return 8000;       // 2-3å­—ï¼š8ç§’
            if (len <= 6) return 10000;      // 4-6å­—ï¼š10ç§’
            if (len <= 10) return 12000;     // 7-10å­—ï¼š12ç§’
            return 15000;                     // æ›´é•·ï¼š15ç§’
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 5;

                recognition.onstart = () => {
                    isListening = true;
                    hasReceivedResult = false;
                    lastTranscript = '';
                    document.getElementById('speakBtn').textContent = 'ğŸ™ï¸ æ­£åœ¨è½...';
                    document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                    if (navigator.vibrate) navigator.vibrate(100);

                    const textLen = currentNumber.text.length;
                    const listenTime = getListenDuration(currentNumber.text);

                    if (textLen <= 1) {
                        document.getElementById('resultMessage').textContent = 'ğŸ™ï¸ è«‹å¤§è²å”¸ 2~3 æ¬¡ï¼';
                        speakShort('è«‹å”¸å…©åˆ°ä¸‰æ¬¡');
                    } else {
                        document.getElementById('resultMessage').textContent = 'ğŸ™ï¸ è«‹è·Ÿè‘—å”¸ï¼';
                        speakShort('è«‹è·Ÿè‘—å”¸');
                    }

                    recognitionTimeout = setTimeout(() => {
                        if (isListening) {
                            try { recognition.stop(); } catch(e) {}
                        }
                    }, listenTime);
                };

                recognition.onresult = (event) => {
                    const lastResult = event.results[event.results.length - 1];
                    const transcript = lastResult[0].transcript.trim();

                    if (hasReceivedResult) return;
                    if (transcript.includes('è«‹å”¸') || transcript.includes('å…©åˆ°ä¸‰æ¬¡') || transcript.includes('è·Ÿè‘—å”¸')) return;

                    if (transcript) {
                        lastTranscript = transcript;
                        document.getElementById('resultMessage').textContent = 'ğŸ¤ è½åˆ°ï¼š' + transcript;

                        hasReceivedResult = true;
                        clearTimeout(recognitionTimeout);
                        stopVAD();
                        try { recognition.stop(); } catch(e) {}
                        isListening = false;
                        document.getElementById('speakBtn').textContent = 'ğŸ¤ æˆ‘ä¾†å”¸';
                        document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                        checkSpeakResult(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    clearTimeout(recognitionTimeout);
                    stopVAD();
                    console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);

                    if (event.error === 'not-allowed' || event.error === 'service-not-allowed' || event.error === 'audio-capture') {
                        recognitionFailed = true;
                        isListening = false;
                        document.getElementById('speakBtn').textContent = 'ğŸ¤ æˆ‘ä¾†å”¸';
                        document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                        document.getElementById('resultMessage').textContent = 'âŒ éº¥å…‹é¢¨ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é»ã€Œâœ…æˆ‘æœƒå”¸ã€æŒ‰éˆ•';
                        document.getElementById('speakBtn').style.display = 'none';
                        document.getElementById('manualSpeakBtn').style.display = 'inline-block';
                        return;
                    }
                };

                recognition.onend = () => {
                    clearTimeout(recognitionTimeout);
                    stopVAD();
                    const wasListening = isListening;
                    isListening = false;
                    document.getElementById('speakBtn').textContent = 'ğŸ¤ æˆ‘ä¾†å”¸';
                    document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';

                    if (!hasReceivedResult && lastTranscript && wasListening) {
                        hasReceivedResult = true;
                        document.getElementById('resultMessage').textContent = 'è½åˆ°ï¼š' + lastTranscript;
                        checkSpeakResult(lastTranscript);
                    } else if (!hasReceivedResult && wasListening) {
                        if (hasDetectedVoice) {
                            document.getElementById('resultMessage').textContent = 'ğŸ¤ è½åˆ°è²éŸ³äº†ï¼Œä½†è¾¨è­˜ä¸æ¸…æ¥šï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼';
                        } else {
                            document.getElementById('resultMessage').textContent = 'æ²’è½æ¸…æ¥šï¼Œé»ğŸ¤å†è©¦ï¼Œæˆ–é»ã€Œâœ…æˆ‘æœƒå”¸ã€';
                        }
                    }
                };
            }

            initVAD();
        }

        function manualSpeakConfirm() {
            speak(currentNumber.text, () => {
                if (confirm('ä½ æœƒå”¸ã€Œ' + currentNumber.text + 'ã€å—ï¼Ÿ\n\né»ã€Œç¢ºå®šã€è¡¨ç¤ºæœƒå”¸')) {
                    handleSpeakCorrect();
                } else {
                    document.getElementById('resultMessage').textContent = 'æ²’é—œä¿‚ï¼Œå†è½ä¸€æ¬¡ï¼';
                    speak('æ²’é—œä¿‚ï¼Œå†è½ä¸€æ¬¡ï¼');
                }
            });
        }

        function startSpeaking() {
            if (!recognition) {
                if (confirm(`ä½ èªªçš„æ˜¯ã€Œ${currentNumber.text}ã€å—ï¼Ÿ`)) {
                    handleSpeakCorrect();
                }
                return;
            }

            if (isListening) return;

            startVAD();

            try {
                recognition.start();
            } catch (error) {
                console.error('å•Ÿå‹•è¾¨è­˜å¤±æ•—:', error);
                stopVAD();
            }
        }

        function checkSpeakResult(transcript) {
            const hasSound = transcript && transcript.trim().length > 0;
            const threshold = getSimilarityThreshold();

            // è¨ˆç®—ç›¸ä¼¼åº¦ï¼ˆä½¿ç”¨ config.js çš„å‡½æ•¸ï¼‰
            const similarity = hasSound ? calculateSimilarity(transcript, currentNumber.text) : 0;

            // è¨˜éŒ„ç™¼éŸ³ï¼ˆç”¨æ–¼è¿½è¹¤é€²åº¦ï¼‰
            if (hasSound) {
                recordPronunciation('number', currentNumber.text, transcript, similarity);
            }

            // æª¢æŸ¥è²éŸ³é•·åº¦æ˜¯å¦è¶³å¤ 
            const minDuration = getMinVoiceDuration(currentNumber.text);
            const durationSufficient = totalVoiceDuration >= minDuration;

            // é–€æª»ç‚º 0 æ™‚çš„è™•ç†ï¼ˆå¤±èªç—‡å‹å–„æ¨¡å¼ï¼‰
            if (threshold === 0) {
                if ((hasSound || hasDetectedVoice) && durationSufficient) {
                    handleSpeakCorrect(similarity);
                } else if (!durationSufficient && (hasSound || hasDetectedVoice)) {
                    // è²éŸ³å¤ªçŸ­
                    document.getElementById('resultMessage').textContent = 'ğŸ¤ è²éŸ³æœ‰é»çŸ­ï¼Œè«‹å†å”¸ä¸€æ¬¡ï¼';
                } else {
                    document.getElementById('resultMessage').textContent = 'æ²’è½æ¸…æ¥šï¼Œé»ğŸ¤å†è©¦ï¼Œæˆ–é»ã€Œâœ…æˆ‘æœƒå”¸ã€';
                }
                return;
            }

            // é–€æª» > 0 æ™‚çš„è™•ç†
            const passes = hasSound && passesSimilarityThreshold(similarity) && durationSufficient;

            // é¡¯ç¤ºç›¸ä¼¼åº¦è³‡è¨Š
            if (hasSound) {
                const level = getSimilarityLevel(similarity);
                document.getElementById('resultMessage').textContent = `${level.emoji} ${Math.round(similarity)}% - ${level.label}`;
            }

            if (passes) {
                handleSpeakCorrect(similarity);
            } else {
                // è¾¨è­˜å¤±æ•—ï¼ŒåŸ·è¡Œå›æ”¾æµç¨‹
                handleRecognitionFailed(currentNumber.text, transcript, similarity);
            }
        }

        // è¾¨è­˜å¤±æ•—å¾Œçš„å›æ”¾æµç¨‹
        async function handleRecognitionFailed(target, transcript, similarity) {
            // å¦‚æœæœ‰éŒ„éŸ³ï¼Œå›æ”¾çµ¦ä½¿ç”¨è€…è½
            if (lastRecordedAudioUrl) {
                document.getElementById('resultMessage').textContent = 'ğŸ”Š è®“æˆ‘å€‘è½è½ä½ çš„ç™¼éŸ³...';
                await new Promise(r => setTimeout(r, 500));
                await playbackRecording();
                await new Promise(r => setTimeout(r, 300));
            }

            // æ’­æ”¾æ­£ç¢ºç™¼éŸ³
            document.getElementById('resultMessage').textContent = 'ğŸ”Š æ­£ç¢ºçš„ç™¼éŸ³æ˜¯...';
            await new Promise(r => setTimeout(r, 300));
            await speakAsync(target);
            await new Promise(r => setTimeout(r, 500));

            // æç¤ºé‡è©¦
            document.getElementById('resultMessage').textContent = 'å†è©¦ä¸€æ¬¡ï¼é»ğŸ¤æˆ–é»ã€Œâœ…æˆ‘æœƒå”¸ã€';
        }

        function handleSpeakCorrect(similarity = 100) {
            score += 10;
            updateScore();
            saveMastered(currentNumber.num);

            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            const encouragement = getEncouragement();
            document.getElementById('resultMessage').textContent = 'ğŸ‰ ' + encouragement + ' ğŸ‰';

            speak(encouragement);
            createFireworks(20);
            setTimeout(nextSpeakQuestion, 2000);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function saveMastered(num) {
            masteredNumbers.add(num);
            localStorage.setItem('masteredNumbers_0_99', JSON.stringify([...masteredNumbers]));
            if (currentMode === 'learn') renderNumberGrid();
        }

        function endGame() {
            document.getElementById('completeScore').textContent = `å¾—åˆ†ï¼š${score} åˆ†`;
            document.getElementById('completeOverlay').classList.add('show');
            createFireworks(50);
            speak(`å¤ªæ£’äº†ï¼ä½ å¾—äº†${score}åˆ†ï¼`);
        }

        function restartGame() {
            document.getElementById('completeOverlay').classList.remove('show');
            setMode(currentMode);
        }

        function createFireworks(count) {
            const container = document.getElementById('fireworks');
            const emojis = ['âœ¨', 'ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'ğŸŒŸ'];

            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.fontSize = (2 + Math.random() * 2) + 'rem';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
            }
            setTimeout(() => { container.innerHTML = ''; }, 2000);
        }

        function init() {
            renderNumberGrid();
            currentNumber = ALL_NUMBERS[0];
            displayNumber();
            setTimeout(() => {
                speak('æ­¡è¿ä¾†åˆ°æ•¸å­—ç·´ç¿’ï¼é€™è£¡ç·´ç¿’æ•¸å­—é›¶åˆ°ä¹åä¹çš„ç™¼éŸ³ã€‚', () => {
                    setTimeout(() => speak('é¸æ“‡ç¯„åœï¼Œç„¶å¾Œé»æ“Šæ•¸å­—è½ç™¼éŸ³ï¼'), 1000);
                });
            }, 500);
        }

        init();
    </script>
</body>
</html>
