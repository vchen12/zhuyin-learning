<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>âš™ï¸ è¨­å®š - æ³¨éŸ³å­¸ç¿’æ¨‚åœ’</title>
    <script src="js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; overflow: hidden; }
        body {
            height: 100%;
            height: 100dvh;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            padding: 20px;
            padding: max(10px, env(safe-area-inset-top)) max(10px, env(safe-area-inset-right)) max(10px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left));
        }

        .nav-bar {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .back-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        .back-btn:active {
            transform: scale(0.95);
        }
        .nav-title {
            font-size: 1.3rem;
            color: #667eea;
            font-weight: bold;
        }

        .container { max-width: 800px; margin: 0 auto; }

        .page-title {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .page-title h1 {
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* è¨­å®šå€å¡Š */
        .settings-section {
            background: white;
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section-title {
            font-size: 1.4rem;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* è§’è‰²é¸æ“‡ */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .character-item {
            background: #f5f5f5;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .character-item:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }
        .character-item.selected {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        .character-item.disabled {
            opacity: 0.5;
            border-color: #f44336;
            background: #ffebee;
        }
        .character-item .emoji {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 8px;
        }
        .character-item .name {
            font-size: 1rem;
            color: #333;
            margin-bottom: 5px;
        }
        .character-item .status {
            font-size: 0.8rem;
            color: #999;
        }

        /* ç·¨è¼¯æŒ‰éˆ• */
        .edit-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        .edit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            min-height: 44px;
        }
        .edit-btn.delete {
            background: #f44336;
        }
        .edit-btn.rename {
            background: #ff9800;
        }

        /* æ–°å¢è§’è‰²æŒ‰éˆ• */
        .add-character {
            background: #e0e0e0;
            border: 3px dashed #bbb;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-character:hover {
            background: #d0d0d0;
            border-color: #667eea;
        }
        .add-character .icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 8px;
        }

        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .upload-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .upload-area {
            background: #f9f9f9;
            border: 3px dashed #ddd;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .upload-area.dragover {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .upload-text {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 10px;
        }
        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        /* å·²ä¸Šå‚³åœ–ç‰‡é è¦½ */
        .uploaded-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .uploaded-image {
            position: relative;
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .uploaded-image .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .uploaded-image .label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 0.75rem;
            text-align: center;
        }

        /* é‡ç½®æŒ‰éˆ• */
        .reset-section {
            text-align: center;
            padding-top: 20px;
        }
        .reset-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 5px;
        }
        .save-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 5px;
        }

        /* éš±è—çš„æ–‡ä»¶è¼¸å…¥ */
        .hidden-input {
            display: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-title {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
        }
        .modal-btn.confirm {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }
        .modal-btn.cancel {
            background: #e0e0e0;
            color: #666;
        }

        /* é€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1rem;
            z-index: 1001;
            display: none;
        }
        .toast.show { display: block; }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }

        /* èªéŸ³é–€æª»é è¨­æŒ‰éˆ• */
        .threshold-preset {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .threshold-preset:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .threshold-preset.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        .stat-card.green { background: linear-gradient(135deg, #4caf50, #8bc34a); }
        .stat-card.orange { background: linear-gradient(135deg, #ff9800, #ffc107); }
        .stat-card.blue { background: linear-gradient(135deg, #2196f3, #03a9f4); }
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-card .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* é¡å‹æ¨™ç±¤ */
        .type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
        }
        .type-badge.zhuyin { background: #9c27b0; }
        .type-badge.word { background: #4caf50; }
        .type-badge.number { background: #2196f3; }
        .type-badge.sentence { background: #ff9800; }

        /* ç´€éŒ„é …ç›® */
        .record-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            gap: 15px;
        }
        .record-item:last-child { border-bottom: none; }
        .record-item:hover { background: #f9f9f9; }
        .record-target {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            min-width: 80px;
        }
        .record-score {
            font-weight: bold;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        .record-score.excellent { background: #e8f5e9; color: #2e7d32; }
        .record-score.good { background: #fff3e0; color: #ef6c00; }
        .record-score.fair { background: #fff8e1; color: #f9a825; }
        .record-score.needs-work { background: #ffebee; color: #c62828; }
        .record-attempts {
            color: #999;
            font-size: 0.85rem;
        }

        /* éœ€è¦åŠ å¼·é …ç›® */
        .improvement-item {
            background: #ffebee;
            border: 2px solid #f44336;
            padding: 8px 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .improvement-item .target { font-weight: bold; color: #c62828; }
        .improvement-item .score { font-size: 0.85rem; color: #999; }

        /* é€²æ­¥é …ç›® */
        .progress-item {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            padding: 8px 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .progress-item .target { font-weight: bold; color: #2e7d32; }
        .progress-item .improvement { font-size: 0.85rem; color: #4caf50; }

        /* é¡åˆ¥æ¨™ç±¤ */
        .category-tab {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .category-tab:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .category-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* ä¾‹å¥åˆ†é¡æ¨™ç±¤ */
        .sentence-tab {
            background: #fff3e0;
            border: 2px solid #ffcc80;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sentence-tab:hover {
            border-color: #ff9800;
            background: #ffe0b2;
        }
        .sentence-tab.active {
            background: #ff9800;
            color: white;
            border-color: #ff9800;
        }

        /* å­—è©å¡ç‰‡ */
        .word-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
        }
        .word-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .word-card .emoji { font-size: 1.3rem; }
        .word-card .text { font-weight: bold; color: #333; }
        .word-card .zhuyin { font-size: 0.8rem; color: #667eea; }

        /* ä¾‹å¥å¡ç‰‡ */
        .sentence-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }
        .sentence-card:hover {
            border-color: #ff9800;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sentence-card .sentence-text {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .sentence-card .sentence-parts {
            font-size: 0.85rem;
            color: #666;
        }

        /* çµ±è¨ˆå°å¡ */
        .mini-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 12px;
            text-align: center;
        }
        .mini-stat .value { font-size: 1.3rem; font-weight: bold; }
        .mini-stat .label { font-size: 0.8rem; opacity: 0.9; }

        @media (max-width: 600px) {
            .character-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .character-item .emoji { font-size: 2rem; }
            .character-item .name { font-size: 0.85rem; }
            .threshold-preset { font-size: 0.8rem; padding: 8px 12px; }
            .category-tab { font-size: 0.75rem; padding: 6px 10px; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="index.html" class="back-btn">â† è¿”å›é¦–é </a>
        <div class="nav-title">âš™ï¸ è¨­å®š</div>
        <div></div>
    </nav>

    <div class="container">
        <div class="page-title">
            <h1>âš™ï¸ å€‹äººåŒ–è¨­å®š</h1>
        </div>

        <!-- ä½¿ç”¨è€…åç¨±è¨­å®š -->
        <div class="settings-section">
            <div class="section-title">ğŸ‘¤ ä½¿ç”¨è€…åç¨±</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                è¨­å®šä½¿ç”¨è€…çš„åç¨±ï¼Œç³»çµ±æœƒåœ¨ç¨±è®šæˆ–æç¤ºæ™‚åŠ ä¸Šåå­—ï¼Œ<br>
                ä¾‹å¦‚ã€Œå°ä¹–ï¼Œä½ å¥½æ£’ï¼ã€æˆ–ã€Œæ­£æ˜‡ï¼Œå†è©¦ä¸€æ¬¡ï¼ã€
            </p>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="userName" class="modal-input" placeholder="è¼¸å…¥ä½¿ç”¨è€…åç¨±ï¼ˆä¾‹å¦‚ï¼šå°ä¹–ã€æ­£æ˜‡ï¼‰" style="flex: 1; min-width: 200px; margin: 0;">
                <button class="save-btn" onclick="saveUserName()" style="margin: 0; padding: 15px 25px;">ğŸ’¾ å„²å­˜åç¨±</button>
            </div>
            <div id="userNamePreview" style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 15px; display: none;">
                <p style="color: #667eea; font-size: 1.1rem; font-weight: bold;">
                    é è¦½æ•ˆæœï¼š<span id="previewText"></span>
                </p>
            </div>
        </div>

        <!-- å®¶äººè§’è‰²è¨­å®šå·²æ•´åˆåˆ°ã€Œå­—è©åº«ç®¡ç†ã€çš„ã€Œå®¶äººã€é¡åˆ¥ä¸­ -->

        <!-- åœ–ç‰‡ä¸Šå‚³ -->
        <div class="settings-section">
            <div class="section-title">ğŸ“· è‡ªè¨‚åœ–ç‰‡</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                ä¸Šå‚³çœŸå¯¦ç…§ç‰‡ä¾†æ›¿æ›é è¨­çš„ emoji åœ–ç¤ºã€‚<br>
                ç³»çµ±æœƒè‡ªå‹•è£åˆ‡ä¸¦è™•ç†åœ–ç‰‡ã€‚
            </p>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-text">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡ä¸Šå‚³</div>
                <div class="upload-hint">æ”¯æ´ JPGã€PNG æ ¼å¼ï¼Œå»ºè­°æ­£æ–¹å½¢åœ–ç‰‡</div>
            </div>
            <input type="file" id="imageInput" class="hidden-input" accept="image/*" multiple>

            <div class="uploaded-images" id="uploadedImages"></div>

            <div class="upload-section">
                <p style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">åœ–ç‰‡å°æ‡‰è¨­å®šï¼šä¸Šå‚³å¾Œé¸æ“‡è¦æ›¿æ›çš„è§’è‰²</p>
            </div>
        </div>

        <!-- éº¥å…‹é¢¨æ¸¬è©¦ -->
        <div class="settings-section">
            <div class="section-title">ğŸ¤ éº¥å…‹é¢¨æ¸¬è©¦</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                åœ¨é–‹å§‹èªéŸ³ç·´ç¿’å‰ï¼Œè«‹å…ˆæ¸¬è©¦éº¥å…‹é¢¨æ˜¯å¦æ­£å¸¸é‹ä½œã€‚<br>
                é€™æœƒç¢ºèªç€è¦½å™¨å·²æˆæ¬Šéº¥å…‹é¢¨æ¬Šé™ï¼Œä¸”æ”¶éŸ³æ­£å¸¸ã€‚
            </p>

            <!-- éº¥å…‹é¢¨ç‹€æ…‹ -->
            <div id="micTestArea" style="background: #f9f9f9; padding: 25px; border-radius: 15px; text-align: center;">
                <div id="micStatus" style="font-size: 1.2rem; color: #666; margin-bottom: 20px;">
                    å°šæœªæ¸¬è©¦éº¥å…‹é¢¨
                </div>

                <!-- éŸ³é‡æŒ‡ç¤ºæ¢ -->
                <div style="background: #ddd; height: 25px; border-radius: 15px; overflow: hidden; margin-bottom: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <div id="volumeMeter" style="height: 100%; background: linear-gradient(90deg, #4caf50, #8bc34a); width: 0%; transition: width 0.1s;"></div>
                </div>

                <!-- æ¸¬è©¦æŒ‰éˆ• -->
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button id="testMicBtn" onclick="testMicrophone()" class="save-btn" style="background: linear-gradient(135deg, #667eea, #764ba2); min-width: 160px;">
                        ğŸ¤ æ¸¬è©¦éº¥å…‹é¢¨
                    </button>
                    <button id="testSpeechBtn" onclick="testSpeechRecognition()" class="save-btn" style="background: linear-gradient(135deg, #11998e, #38ef7d); min-width: 160px; display: none;">
                        ğŸ—£ï¸ æ¸¬è©¦èªéŸ³è¾¨è­˜
                    </button>
                </div>

                <!-- èªéŸ³è¾¨è­˜çµæœ -->
                <div id="speechResult" style="display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 12px; text-align: left;">
                    <strong style="color: #2e7d32;">è¾¨è­˜çµæœï¼š</strong>
                    <span id="speechResultText"></span>
                </div>
            </div>

            <!-- æ¸¬è©¦æç¤º -->
            <div id="micTestHint" style="background: #fff3e0; padding: 15px; border-radius: 12px; border-left: 4px solid #ff9800; margin-top: 15px; display: none;">
                <p style="color: #e65100; font-size: 0.9rem; margin: 0;">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong><span id="micTestHintText"></span>
                </p>
            </div>
        </div>

        <!-- èªéŸ³è¾¨è­˜è¨­å®š -->
        <div class="settings-section">
            <div class="section-title">ğŸ“Š èªéŸ³è¾¨è­˜é–€æª»è¨­å®š</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                èª¿æ•´èªéŸ³è¾¨è­˜çš„éé—œé–€æª»ã€‚é è¨­ç‚º 0ï¼ˆåªè¦æœ‰ç™¼è²å°±éé—œï¼‰ï¼Œ<br>
                å¯æé«˜æ¨™æº–è®“ä½¿ç”¨è€…ç·´ç¿’æ›´ç²¾ç¢ºçš„ç™¼éŸ³ã€‚
            </p>

            <!-- ç›¸ä¼¼åº¦é–€æª»æ»‘æ¡¿ -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <label style="color: #667eea; font-weight: bold; font-size: 1.1rem;">éé—œé–€æª»</label>
                    <span id="thresholdValue" style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 1.1rem;">0%</span>
                </div>

                <input type="range" id="similarityThreshold" min="0" max="100" value="0"
                    style="width: 100%; height: 20px; cursor: pointer; accent-color: #667eea;">

                <div style="display: flex; justify-content: space-between; margin-top: 10px; color: #999; font-size: 0.85rem;">
                    <span>0% (æœ‰ç™¼è²å³å¯)</span>
                    <span>50%</span>
                    <span>100% (å®Œå…¨æ­£ç¢º)</span>
                </div>

                <!-- é è¨­ç­‰ç´šå¿«æ·æŒ‰éˆ• -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                    <button onclick="setThreshold(0)" class="threshold-preset" data-value="0">
                        ğŸ˜Š é¼“å‹µæ¨¡å¼ (0%)
                    </button>
                    <button onclick="setThreshold(50)" class="threshold-preset" data-value="50">
                        ğŸ“– ç·´ç¿’æ¨¡å¼ (50%)
                    </button>
                    <button onclick="setThreshold(80)" class="threshold-preset" data-value="80">
                        ğŸ¯ æŒ‘æˆ°æ¨¡å¼ (80%)
                    </button>
                    <button onclick="setThreshold(90)" class="threshold-preset" data-value="90">
                        â­ ç²¾æº–æ¨¡å¼ (90%)
                    </button>
                </div>
            </div>

            <div style="background: #e8f5e9; padding: 15px; border-radius: 12px; border-left: 4px solid #4caf50;">
                <p style="color: #2e7d32; font-size: 0.9rem; margin: 0;">
                    <strong>ğŸ’¡ å»ºè­°ï¼š</strong>å¤±èªç—‡å¾©å¥åˆæœŸå»ºè­°ä½¿ç”¨ã€Œé¼“å‹µæ¨¡å¼ã€(0%)ï¼Œ<br>
                    é¼“å‹µæ‚£è€…å¤šç™¼è²ï¼›éš¨è‘—é€²æ­¥å¯é€æ­¥æé«˜é–€æª»ã€‚
                </p>
            </div>
        </div>

        <!-- ç™¼éŸ³ç´€éŒ„ -->
        <div class="settings-section">
            <div class="section-title">ğŸ“Š ç™¼éŸ³ç·´ç¿’ç´€éŒ„</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                æŸ¥çœ‹ä½¿ç”¨è€…çš„ç™¼éŸ³ç·´ç¿’æ­·å²èˆ‡é€²æ­¥æƒ…æ³ã€‚<br>
                é€™äº›ç´€éŒ„å¯ä½œç‚ºå¾©å¥é€²åº¦çš„åƒè€ƒä¾æ“šã€‚
            </p>

            <!-- çµ±è¨ˆæ‘˜è¦ -->
            <div id="pronunciationSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- åˆ†é¡çµ±è¨ˆ -->
            <div id="pronunciationByType" style="margin-bottom: 20px;">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- éœ€è¦åŠ å¼·çš„é …ç›® -->
            <div id="needsImprovementSection" style="display: none; margin-bottom: 20px;">
                <h4 style="color: #f44336; margin-bottom: 10px;">âš ï¸ éœ€è¦åŠ å¼·ç·´ç¿’</h4>
                <div id="needsImprovementList" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æœ€è¿‘é€²æ­¥ -->
            <div id="recentProgressSection" style="display: none; margin-bottom: 20px;">
                <h4 style="color: #4caf50; margin-bottom: 10px;">ğŸŒŸ æœ€è¿‘é€²æ­¥</h4>
                <div id="recentProgressList" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è©³ç´°ç´€éŒ„è¡¨æ ¼ -->
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #667eea; margin: 0;">ğŸ“‹ è©³ç´°ç´€éŒ„</h4>
                    <div style="display: flex; gap: 10px;">
                        <select id="recordTypeFilter" onchange="renderDetailedRecords()" style="padding: 8px 12px; border-radius: 10px; border: 2px solid #e0e0e0; font-size: 0.9rem;">
                            <option value="all">å…¨éƒ¨é¡å‹</option>
                            <option value="zhuyin">æ³¨éŸ³ç¬¦è™Ÿ</option>
                            <option value="word">å­—è©</option>
                            <option value="number">æ•¸å­—</option>
                            <option value="sentence">å¥å­</option>
                        </select>
                    </div>
                </div>
                <div id="detailedRecords" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 15px;">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; justify-content: center;">
                <button onclick="exportRecords()" class="save-btn" style="background: linear-gradient(135deg, #2196f3, #03a9f4);">
                    ğŸ“¤ åŒ¯å‡ºç´€éŒ„
                </button>
                <button onclick="refreshRecords()" class="save-btn" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    ğŸ”„ é‡æ–°æ•´ç†
                </button>
                <button onclick="clearRecords()" class="reset-btn" style="background: #ff9800;">
                    ğŸ—‘ï¸ æ¸…é™¤ç´€éŒ„
                </button>
            </div>
        </div>

        <!-- è‡ªè¨‚å­—è©åŠŸèƒ½ -->
        <div class="settings-section">
            <div class="section-title">ğŸ“ å­—è©åº«ç®¡ç†</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                ç®¡ç†ç³»çµ±å…§å»ºçš„å­—è©åº«èˆ‡è‡ªè¨‚å­—è©ã€‚<br>
                å¯ä»¥æŸ¥çœ‹ã€æ–°å¢æˆ–åˆªé™¤å„é¡åˆ¥çš„å­—è©ã€‚
            </p>

            <!-- é¡åˆ¥é¸æ“‡æ¨™ç±¤ -->
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                <button class="category-tab active" data-category="custom" onclick="switchVocabCategory('custom')">
                    âœï¸ è‡ªè¨‚å­—è©
                </button>
                <button class="category-tab" data-category="family" onclick="switchVocabCategory('family')">
                    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äºº
                </button>
                <button class="category-tab" data-category="animals" onclick="switchVocabCategory('animals')">
                    ğŸ¾ å‹•ç‰©
                </button>
                <button class="category-tab" data-category="fruits" onclick="switchVocabCategory('fruits')">
                    ğŸ æ°´æœ
                </button>
                <button class="category-tab" data-category="items" onclick="switchVocabCategory('items')">
                    ğŸ“¦ æ—¥å¸¸ç”¨å“
                </button>
                <button class="category-tab" data-category="food" onclick="switchVocabCategory('food')">
                    ğŸœ é£Ÿç‰©
                </button>
                <button class="category-tab" data-category="actions" onclick="switchVocabCategory('actions')">
                    ğŸƒ å‹•ä½œ
                </button>
                <button class="category-tab" data-category="body" onclick="switchVocabCategory('body')">
                    ğŸ§ èº«é«”
                </button>
                <button class="category-tab" data-category="nature" onclick="switchVocabCategory('nature')">
                    ğŸŒ³ è‡ªç„¶
                </button>
                <button class="category-tab" data-category="sentences" onclick="switchVocabCategory('sentences')">
                    ğŸ’¬ ä¾‹å¥
                </button>
            </div>

            <!-- è‡ªè¨‚å­—è©å€å¡Š -->
            <div id="customWordSection">
                <!-- æ–°å¢å­—è©è¡¨å–® -->
                <div style="background: #f9f9f9; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">â• æ–°å¢è‡ªè¨‚å­—è©</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; color: #667eea; font-weight: bold; margin-bottom: 5px;">ä¸­æ–‡å­—è©</label>
                            <input type="text" id="newWord" class="modal-input" placeholder="ä¾‹å¦‚ï¼šåª½åª½ã€è˜‹æœ" style="margin: 0; width: 100%;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; color: #667eea; font-weight: bold; margin-bottom: 5px;">æ³¨éŸ³ï¼ˆé¸å¡«ï¼‰</label>
                            <input type="text" id="newWordZhuyin" class="modal-input" placeholder="ä¾‹å¦‚ï¼šã„‡ã„š ã„‡ã„šË™" style="margin: 0; width: 100%;">
                        </div>
                        <div style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                            <button class="save-btn" onclick="addCustomWord()" style="margin: 0; padding: 15px 25px;">â• æ–°å¢</button>
                        </div>
                    </div>

                    <!-- åˆ†é¡é¸æ“‡ -->
                    <div>
                        <label style="display: block; color: #667eea; font-weight: bold; margin-bottom: 8px;">åˆ†é¡</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="wordCategory" value="daily" checked> æ—¥å¸¸ç”¨èª
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="wordCategory" value="family"> äººåç¨±å‘¼
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="wordCategory" value="place"> åœ°é»
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="wordCategory" value="sentence"> å¥å­
                            </label>
                        </div>
                    </div>
                </div>

                <!-- å·²æ–°å¢çš„å­—è©åˆ—è¡¨ -->
                <div id="customWordsList" style="display: none;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">ğŸ“‹ å·²æ–°å¢çš„è‡ªè¨‚å­—è©</h4>
                    <div id="customWordsContainer" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>
            </div>

            <!-- ç³»çµ±å­—è©å€å¡Š -->
            <div id="systemWordSection" style="display: none;">
                <div style="background: #f0f8ff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
                    <p style="color: #1565c0; font-size: 0.9rem; margin: 0;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>é€™äº›æ˜¯ç³»çµ±å…§å»ºçš„å­—è©ï¼Œç”¨æ–¼éŠæˆ²ä¸­çš„å­¸ç¿’å…§å®¹ã€‚<br>
                        å¯ä»¥é»æ“Šå­—è©è¤‡è£½åˆ°è‡ªè¨‚å€ï¼Œæˆ–ç›´æ¥åœ¨æ­¤é è¦½ã€‚
                    </p>
                </div>
                <div id="systemWordStats" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;"></div>
                <div id="systemWordsContainer" style="display: flex; flex-wrap: wrap; gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 15px;"></div>
            </div>

            <!-- ä¾‹å¥å€å¡Š -->
            <div id="sentenceSection" style="display: none;">
                <div style="background: #fff3e0; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                    <p style="color: #e65100; font-size: 0.9rem; margin: 0;">
                        <strong>ğŸ’¬ ä¾‹å¥è³‡æ–™åº«ï¼š</strong>é€™äº›ä¾‹å¥ç”¨æ–¼ç¬¬ä¸‰é—œçš„å¥å­ç·´ç¿’éŠæˆ²ã€‚
                    </p>
                </div>

                <!-- ä¾‹å¥åˆ†é¡æ¨™ç±¤ -->
                <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="sentence-tab active" data-type="simple" onclick="switchSentenceType('simple')">ğŸ“ ç°¡å–®å¥å­</button>
                    <button class="sentence-tab" data-type="questions" onclick="switchSentenceType('questions')">â“ å•ç­”ç·´ç¿’</button>
                    <button class="sentence-tab" data-type="fillBlanks" onclick="switchSentenceType('fillBlanks')">ğŸ“‹ å¡«ç©ºç·´ç¿’</button>
                    <button class="sentence-tab" data-type="dialogs" onclick="switchSentenceType('dialogs')">ğŸ’¬ å°è©±ç·´ç¿’</button>
                </div>

                <div id="sentenceStats" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;"></div>
                <div id="sentencesContainer" style="max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 15px;"></div>
            </div>
        </div>

        <!-- é‡ç½®èˆ‡å„²å­˜ -->
        <div class="settings-section">
            <div class="section-title">ğŸ”„ è³‡æ–™ç®¡ç†</div>
            <div class="reset-section">
                <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button class="reset-btn" onclick="resetProgress()">ğŸ—‘ï¸ é‡ç½®å­¸ç¿’é€²åº¦</button>
                <button class="reset-btn" onclick="resetAll()" style="background: #9e9e9e;">â†©ï¸ é‚„åŸé è¨­å€¼</button>
            </div>
        </div>
    </div>

    <!-- é‡å‘½å Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-title">âœï¸ é‡æ–°å‘½å</div>
            <input type="text" class="modal-input" id="renameInput" placeholder="è¼¸å…¥æ–°åç¨±">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmRename()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡é¸æ“‡ Modal -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ¯ é¸æ“‡è¦æ›¿æ›çš„è§’è‰²</div>
            <div class="character-grid" id="assignGrid" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn cancel" onclick="closeAssignModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨è¼¸å…¥ Modalï¼ˆæ›¿ä»£ promptï¼‰ -->
    <div class="modal" id="promptModal">
        <div class="modal-content">
            <div class="modal-title" id="promptModalTitle">è¼¸å…¥</div>
            <input type="text" class="modal-input" id="promptModalInput" placeholder="">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="resolvePromptModal(null)" style="padding: 15px 30px; font-size: 1.1rem; min-height: 50px;">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="resolvePromptModal(document.getElementById('promptModalInput').value)" style="padding: 15px 30px; font-size: 1.1rem; min-height: 50px;">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨é¸æ“‡ Modalï¼ˆæ›¿ä»£ prompt é¸é …ï¼‰ -->
    <div class="modal" id="choiceModal">
        <div class="modal-content">
            <div class="modal-title" id="choiceModalTitle">é¸æ“‡</div>
            <div id="choiceModalOptions" style="display: flex; flex-direction: column; gap: 12px;"></div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn cancel" onclick="resolveChoiceModal(null)" style="padding: 15px 30px; font-size: 1.1rem; min-height: 50px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div class="toast" id="toast">è¨­å®šå·²å„²å­˜</div>

    <!-- è¼‰å…¥è©å½™è³‡æ–™åº« -->
    <script src="js/vocabulary.js"></script>
    <script>
        // ==========================================
        // é€šç”¨ Modal æ›¿ä»£ prompt()ï¼ˆå¤§è¼¸å…¥æ¡†ï¼Œé©åˆå¤±èªç—‡æ‚£è€…ï¼‰
        // ==========================================
        let _promptResolve = null;
        let _choiceResolve = null;

        function modalPrompt(title, defaultValue) {
            return new Promise((resolve) => {
                _promptResolve = resolve;
                document.getElementById('promptModalTitle').textContent = title;
                const input = document.getElementById('promptModalInput');
                input.value = defaultValue || '';
                input.placeholder = '';
                document.getElementById('promptModal').classList.add('show');
                setTimeout(() => input.focus(), 100);
            });
        }

        function resolvePromptModal(value) {
            document.getElementById('promptModal').classList.remove('show');
            if (_promptResolve) {
                _promptResolve(value);
                _promptResolve = null;
            }
        }

        function modalChoice(title, options) {
            return new Promise((resolve) => {
                _choiceResolve = resolve;
                document.getElementById('choiceModalTitle').textContent = title;
                const container = document.getElementById('choiceModalOptions');
                container.innerHTML = '';
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'modal-btn confirm';
                    btn.style.cssText = 'padding: 18px 30px; font-size: 1.2rem; min-height: 55px; width: 100%;';
                    btn.textContent = opt.label;
                    btn.onclick = () => resolveChoiceModal(opt.value);
                    container.appendChild(btn);
                });
                document.getElementById('choiceModal').classList.add('show');
            });
        }

        function resolveChoiceModal(value) {
            document.getElementById('choiceModal').classList.remove('show');
            if (_choiceResolve) {
                _choiceResolve(value);
                _choiceResolve = null;
            }
        }

        // Enter éµç¢ºèª modal
        document.getElementById('promptModalInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                resolvePromptModal(e.target.value);
            }
        });

        // é è¨­å®¶äººè³‡æ–™
        const DEFAULT_FAMILY = [
            { id: 'dad', emoji: 'ğŸ‘¨', name: 'çˆ¸çˆ¸', enabled: true, customImage: null },
            { id: 'mom', emoji: 'ğŸ‘©', name: 'åª½åª½', enabled: true, customImage: null },
            { id: 'grandpa', emoji: 'ğŸ‘´', name: 'çˆºçˆº', enabled: true, customImage: null },
            { id: 'grandma', emoji: 'ğŸ‘µ', name: 'å¥¶å¥¶', enabled: true, customImage: null },
            { id: 'grandpa2', emoji: 'ğŸ‘´', name: 'å¤–å…¬', enabled: true, customImage: null },
            { id: 'grandma2', emoji: 'ğŸ‘µ', name: 'å¤–å©†', enabled: true, customImage: null },
            { id: 'brother', emoji: 'ğŸ‘¦', name: 'å“¥å“¥', enabled: true, customImage: null },
            { id: 'sister', emoji: 'ğŸ‘§', name: 'å§å§', enabled: true, customImage: null },
            { id: 'young_brother', emoji: 'ğŸ‘¦', name: 'å¼Ÿå¼Ÿ', enabled: true, customImage: null },
            { id: 'young_sister', emoji: 'ğŸ‘§', name: 'å¦¹å¦¹', enabled: true, customImage: null },
            { id: 'uncle', emoji: 'ğŸ‘¨', name: 'å”å”', enabled: true, customImage: null },
            { id: 'aunt', emoji: 'ğŸ‘©', name: 'é˜¿å§¨', enabled: true, customImage: null },
            { id: 'uncle2', emoji: 'ğŸ‘¨', name: 'èˆ…èˆ…', enabled: true, customImage: null },
            { id: 'aunt2', emoji: 'ğŸ‘©', name: 'å§‘å§‘', enabled: true, customImage: null }
        ];

        let familySettings = [];
        let uploadedImages = [];
        let currentEditingId = null;
        let currentAssigningImage = null;

        // ==========================================
        // è‡ªè¨‚å­—è©åŠŸèƒ½
        // ==========================================
        let customWords = [];
        let currentVocabCategory = 'custom';
        let currentSentenceType = 'simple';

        function loadCustomWords() {
            customWords = JSON.parse(localStorage.getItem('customWords') || '[]');
            renderCustomWords();
        }

        function addCustomWord() {
            const wordInput = document.getElementById('newWord');
            const zhuyinInput = document.getElementById('newWordZhuyin');
            const categoryRadio = document.querySelector('input[name="wordCategory"]:checked');

            const word = wordInput.value.trim();
            const zhuyin = zhuyinInput.value.trim();
            const category = categoryRadio ? categoryRadio.value : 'daily';

            if (!word) {
                showToast('è«‹è¼¸å…¥å­—è©ï¼', 'error');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦é‡è¤‡
            if (customWords.some(w => w.word === word)) {
                showToast('é€™å€‹å­—è©å·²ç¶“å­˜åœ¨ï¼', 'error');
                return;
            }

            const newWord = {
                id: Date.now(),
                word: word,
                zhuyin: zhuyin || '',
                category: category,
                createdAt: new Date().toISOString()
            };

            customWords.push(newWord);
            localStorage.setItem('customWords', JSON.stringify(customWords));

            // æ¸…ç©ºè¼¸å…¥
            wordInput.value = '';
            zhuyinInput.value = '';

            renderCustomWords();
            showToast(`å·²æ–°å¢ã€Œ${word}ã€`, 'success');
        }

        function removeCustomWord(id) {
            const word = customWords.find(w => w.id === id);
            if (word && confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${word.word}ã€å—ï¼Ÿ`)) {
                customWords = customWords.filter(w => w.id !== id);
                localStorage.setItem('customWords', JSON.stringify(customWords));
                renderCustomWords();
                showToast(`å·²åˆªé™¤ã€Œ${word.word}ã€`);
            }
        }

        function renderCustomWords() {
            const container = document.getElementById('customWordsContainer');
            const listSection = document.getElementById('customWordsList');

            if (customWords.length === 0) {
                listSection.style.display = 'none';
                return;
            }

            listSection.style.display = 'block';

            const categoryLabels = {
                daily: 'æ—¥å¸¸',
                family: 'äººå',
                place: 'åœ°é»',
                sentence: 'å¥å­'
            };

            const categoryColors = {
                daily: '#4caf50',
                family: '#e91e63',
                place: '#2196f3',
                sentence: '#ff9800'
            };

            container.innerHTML = customWords.map(w => `
                <div style="
                    background: white;
                    border: 2px solid ${categoryColors[w.category] || '#ccc'};
                    border-radius: 12px;
                    padding: 10px 15px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                ">
                    <span style="
                        background: ${categoryColors[w.category] || '#ccc'};
                        color: white;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        border-radius: 10px;
                    ">${categoryLabels[w.category] || 'å…¶ä»–'}</span>
                    <span style="font-size: 1.1rem; font-weight: bold; color: #333;">${w.word}</span>
                    ${w.zhuyin ? `<span style="font-size: 0.85rem; color: #667eea;">${w.zhuyin}</span>` : ''}
                    <button onclick="removeCustomWord(${w.id})" style="
                        background: #f44336;
                        color: white;
                        border: none;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 0.8rem;
                        margin-left: auto;
                    ">âœ•</button>
                </div>
            `).join('');
        }

        // ==========================================
        // å­—è©åº«é¡åˆ¥åˆ‡æ›åŠŸèƒ½
        // ==========================================
        function switchVocabCategory(category) {
            currentVocabCategory = category;

            // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });

            // åˆ‡æ›é¡¯ç¤ºå€å¡Š
            const customSection = document.getElementById('customWordSection');
            const systemSection = document.getElementById('systemWordSection');
            const sentenceSection = document.getElementById('sentenceSection');

            customSection.style.display = 'none';
            systemSection.style.display = 'none';
            sentenceSection.style.display = 'none';

            if (category === 'custom') {
                customSection.style.display = 'block';
            } else if (category === 'sentences') {
                sentenceSection.style.display = 'block';
                renderSentences();
            } else {
                systemSection.style.display = 'block';
                renderSystemWords(category);
            }
        }

        // éŠæˆ²å°æ‡‰è¡¨
        function getGameMappingForCategory(category) {
            const mapping = {
                family: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€å•ç­”ç·´ç¿’ã€çœ‹åœ–èªªè©±ã€è©å½™æ’åºã€è½å¥é¸åœ–ã€æ•…äº‹æ¥é¾ã€ç”Ÿæ´»å°è©±ã€æœ—è®€ç·´ç¿’',
                animals: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€å•ç­”ç·´ç¿’ã€çœ‹åœ–èªªè©±ã€è©å½™æ’åºã€è½å¥é¸åœ–ã€æ•…äº‹æ¥é¾ã€æœ—è®€ç·´ç¿’',
                fruits: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€å•ç­”ç·´ç¿’ã€å¥å­å¡«ç©ºã€çœ‹åœ–èªªè©±ã€è½å¥é¸åœ–ã€ç”Ÿæ´»å°è©±ã€æœ—è®€ç·´ç¿’',
                items: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€å•ç­”ç·´ç¿’ã€å¥å­å¡«ç©ºã€çœ‹åœ–èªªè©±ã€è½å¥é¸åœ–',
                food: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€å•ç­”ç·´ç¿’ã€å¥å­å¡«ç©ºã€çœ‹åœ–èªªè©±ã€è½å¥é¸åœ–ã€æ•…äº‹æ¥é¾ã€ç”Ÿæ´»å°è©±ã€æœ—è®€ç·´ç¿’',
                actions: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€çœ‹åœ–èªªè©±ã€è©å½™æ’åºã€è½å¥é¸åœ–',
                body: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€å•ç­”ç·´ç¿’ã€å¥å­å¡«ç©º',
                nature: 'Level 2 å…¨éƒ¨ 6 éŠæˆ²ï½œLevel 3: è³½è»Šã€å¯¶è—çµäººã€å•ç­”ç·´ç¿’ã€å¥å­å¡«ç©º'
            };
            return mapping[category] || 'æ‰€æœ‰å­—è©é¡éŠæˆ²';
        }

        // è©å½™ä¿®æ”¹è¨˜éŒ„
        let vocabularyModifications = { deleted: {}, edited: {}, added: {} };

        function loadVocabularyModifications() {
            vocabularyModifications = JSON.parse(localStorage.getItem('vocabularyModifications') || '{"deleted":{},"edited":{},"added":{}}');
        }

        function saveVocabularyModifications() {
            localStorage.setItem('vocabularyModifications', JSON.stringify(vocabularyModifications));
        }

        function renderSystemWords(category) {
            const statsContainer = document.getElementById('systemWordStats');
            const wordsContainer = document.getElementById('systemWordsContainer');

            // æª¢æŸ¥ VOCABULARY æ˜¯å¦å·²è¼‰å…¥
            if (typeof VOCABULARY === 'undefined') {
                wordsContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">è©å½™è³‡æ–™è¼‰å…¥ä¸­...</p>';
                return;
            }

            const vocab = VOCABULARY[category];
            if (!vocab) {
                wordsContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æ‰¾ä¸åˆ°æ­¤é¡åˆ¥çš„è³‡æ–™</p>';
                return;
            }

            // å®¶äººé¡åˆ¥ç‰¹æ®Šè™•ç†
            if (category === 'family') {
                renderFamilyManagement(vocab, statsContainer, wordsContainer);
                return;
            }

            // ç²å–è©²é¡åˆ¥çš„ä¿®æ”¹è¨˜éŒ„
            loadVocabularyModifications();
            const deletedWords = vocabularyModifications.deleted[category] || [];
            const editedWords = vocabularyModifications.edited[category] || {};
            const addedWords = vocabularyModifications.added[category] || [];

            // åˆä½µä¸¦éæ¿¾è©å½™
            let words = vocab.words
                .filter(w => !deletedWords.includes(w.text))
                .map(w => editedWords[w.text] ? { ...w, ...editedWords[w.text], isEdited: true } : w);
            words = words.concat(addedWords.map(w => ({ ...w, isAdded: true })));

            const gameMapping = getGameMappingForCategory(category);

            // é¡¯ç¤ºçµ±è¨ˆå’ŒéŠæˆ²å°æ‡‰
            statsContainer.innerHTML = `
                <div class="mini-stat">
                    <div class="value">${words.length}</div>
                    <div class="label">å­—è©æ•¸é‡</div>
                </div>
                <div class="mini-stat" style="background: linear-gradient(135deg, ${vocab.color}, ${vocab.color}dd);">
                    <div class="value">${vocab.icon}</div>
                    <div class="label">${vocab.name}</div>
                </div>
                <div style="flex: 1; background: #e3f2fd; padding: 10px 15px; border-radius: 12px; border-left: 4px solid #2196f3; font-size: 0.85rem;">
                    <strong style="color: #1565c0;">ğŸ® ä½¿ç”¨æ­¤é¡åˆ¥çš„éŠæˆ²ï¼š</strong><br>
                    <span style="color: #666;">${gameMapping}</span>
                </div>
            `;

            // é¡¯ç¤ºå­—è©å¡ç‰‡ï¼ˆå¸¶ç·¨è¼¯/åˆªé™¤æŒ‰éˆ•ï¼‰
            wordsContainer.innerHTML = `
                <div style="width: 100%; padding: 10px; background: #e8f5e9; border-radius: 12px; margin-bottom: 15px;">
                    <button onclick="showAddWordToCategory('${category}')" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">
                        â• æ–°å¢å­—è©åˆ°ã€Œ${vocab.name}ã€
                    </button>
                </div>
                ${words.map(word => `
                    <div class="word-card" style="position: relative; flex-wrap: wrap;">
                        <span class="emoji">${word.emoji}</span>
                        <div style="flex: 1; min-width: 80px;">
                            <span class="text">${word.text}</span>
                            <span class="zhuyin">${word.zhuyin}</span>
                        </div>
                        ${word.isAdded ? '<span style="background: #4caf50; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-right: 5px;">æ–°å¢</span>' : ''}
                        ${word.isEdited ? '<span style="background: #ff9800; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-right: 5px;">å·²ä¿®æ”¹</span>' : ''}
                        <div style="display: flex; gap: 5px;">
                            <button onclick="event.stopPropagation(); editSystemWord('${category}', '${word.text}')"
                                    style="background: #2196f3; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                                ç·¨è¼¯
                            </button>
                            <button onclick="event.stopPropagation(); deleteSystemWord('${category}', '${word.text}', ${word.isAdded || false})"
                                    style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // å®¶äººé¡åˆ¥å°ˆç”¨æ¸²æŸ“å‡½æ•¸
        function renderFamilyManagement(vocab, statsContainer, wordsContainer) {
            // ç¢ºä¿ familySettings å·²åˆå§‹åŒ–
            if (!familySettings || familySettings.length === 0) {
                loadSettings();
            }

            const enabledCount = familySettings.filter(m => m.enabled).length;
            const gameMapping = getGameMappingForCategory('family');

            // é¡¯ç¤ºçµ±è¨ˆå’ŒéŠæˆ²å°æ‡‰
            statsContainer.innerHTML = `
                <div class="mini-stat">
                    <div class="value">${familySettings.length}</div>
                    <div class="label">ç¸½è§’è‰²æ•¸</div>
                </div>
                <div class="mini-stat" style="background: linear-gradient(135deg, #4caf50, #8bc34a);">
                    <div class="value">${enabledCount}</div>
                    <div class="label">å·²å•Ÿç”¨</div>
                </div>
                <div style="flex: 1; background: #e3f2fd; padding: 10px 15px; border-radius: 12px; border-left: 4px solid #2196f3; font-size: 0.85rem;">
                    <strong style="color: #1565c0;">ğŸ® ä½¿ç”¨æ­¤é¡åˆ¥çš„éŠæˆ²ï¼š</strong><br>
                    <span style="color: #666;">${gameMapping}</span>
                </div>
            `;

            // è®€å–ç”¨æˆ¶æ–°å¢çš„å®¶äºº
            loadVocabularyModifications();
            const addedFamily = vocabularyModifications.added['family'] || [];

            // æç¤ºè¨Šæ¯
            const tipHtml = `
                <div style="width: 100%; padding: 12px 15px; background: #fff3e0; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                    <p style="color: #e65100; font-size: 0.9rem; margin: 0;">
                        <strong>ğŸ’¡ æç¤ºï¼š</strong>é»æ“Šã€Œæ”¹åã€å¯å°‡è§’è‰²æ”¹æˆå¯¦éš›ç¨±å‘¼ï¼ˆå¦‚ï¼šçˆºçˆºâ†’é˜¿å…¬ï¼‰ã€‚<br>
                        ã€Œåœç”¨ã€çš„è§’è‰²ä¸æœƒå‡ºç¾åœ¨éŠæˆ²ä¸­ã€‚ä¿®æ”¹æœƒè‡ªå‹•å„²å­˜ã€‚
                    </p>
                </div>
            `;

            // æ–°å¢å®¶äººæŒ‰éˆ•
            const addButtonHtml = `
                <div style="width: 100%; padding: 10px; background: #e8f5e9; border-radius: 12px; margin-bottom: 15px;">
                    <button onclick="showAddFamilyMember()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: bold;">
                        â• æ–°å¢å®¶äººè§’è‰²
                    </button>
                </div>
            `;

            // æ¸²æŸ“ç³»çµ±å®¶äººå¡ç‰‡ï¼ˆå¸¶å•Ÿç”¨/åœç”¨å’Œæ”¹ååŠŸèƒ½ï¼‰
            const systemFamilyHtml = familySettings.map((member, index) => {
                const vocabWord = vocab.words.find(w => w.text === DEFAULT_FAMILY[index]?.name);
                const zhuyin = vocabWord ? vocabWord.zhuyin : '';

                return `
                    <div class="word-card" style="position: relative; ${!member.enabled ? 'opacity: 0.5; border-color: #f44336; background: #ffebee;' : ''}">
                        <span class="emoji">${member.customImage ?
                            '<img src="' + member.customImage + '" style="width:35px;height:35px;border-radius:50%;object-fit:cover;">' :
                            member.emoji}</span>
                        <div style="flex: 1; min-width: 60px;">
                            <span class="text">${member.name}</span>
                            <span class="zhuyin">${zhuyin}</span>
                        </div>
                        ${!member.enabled ? '<span style="background: #f44336; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-right: 5px;">å·²åœç”¨</span>' : ''}
                        <div style="display: flex; gap: 5px;">
                            <button onclick="event.stopPropagation(); uploadFamilyPhoto('${member.id}')"
                                    style="background: #9c27b0; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                                æ›ç…§ç‰‡
                            </button>
                            <button onclick="event.stopPropagation(); openRenameModal('${member.id}')"
                                    style="background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                                æ”¹å
                            </button>
                            <button onclick="event.stopPropagation(); toggleMemberAndRefresh('${member.id}')"
                                    style="background: ${member.enabled ? '#f44336' : '#4caf50'}; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                                ${member.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // æ¸²æŸ“ç”¨æˆ¶æ–°å¢çš„å®¶äººå¡ç‰‡
            const addedFamilyHtml = addedFamily.map(member => `
                <div class="word-card" style="position: relative; border-color: #4caf50; background: #f1f8e9;">
                    <span class="emoji">${member.customImage ?
                        '<img src="' + member.customImage + '" style="width:35px;height:35px;border-radius:50%;object-fit:cover;">' :
                        member.emoji}</span>
                    <div style="flex: 1; min-width: 60px;">
                        <span class="text">${member.text}</span>
                        <span class="zhuyin">${member.zhuyin || ''}</span>
                    </div>
                    <span style="background: #4caf50; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; margin-right: 5px;">æ–°å¢</span>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="event.stopPropagation(); uploadAddedFamilyPhoto('${member.text}')"
                                style="background: #9c27b0; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                            æ›ç…§ç‰‡
                        </button>
                        <button onclick="event.stopPropagation(); editAddedFamilyMember('${member.text}')"
                                style="background: #2196f3; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                            ç·¨è¼¯
                        </button>
                        <button onclick="event.stopPropagation(); deleteAddedFamilyMember('${member.text}')"
                                style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer;">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            `).join('');

            wordsContainer.innerHTML = tipHtml + addButtonHtml + systemFamilyHtml + addedFamilyHtml;
        }

        // åˆ‡æ›å®¶äººå•Ÿç”¨ç‹€æ…‹ä¸¦åˆ·æ–°é¡¯ç¤º
        function toggleMemberAndRefresh(id) {
            toggleMember(id);
            renderSystemWords('family');
        }

        // ==========================================
        // å®¶äººè§’è‰²å°ˆç”¨åŠŸèƒ½
        // ==========================================

        // æ–°å¢å®¶äººè§’è‰²ï¼ˆå½ˆå‡ºå°è©±æ¡†é¸æ“‡æ€§åˆ¥ï¼‰
        async function showAddFamilyMember() {
            const name = await modalPrompt('è¼¸å…¥å®¶äººç¨±å‘¼ï¼ˆå¦‚ï¼šå¤§èˆ…ã€äºŒå§‘ã€è¡¨å“¥ï¼‰ï¼š');
            if (!name || !name.trim()) return;

            const zhuyin = await modalPrompt('è¼¸å…¥æ³¨éŸ³ï¼ˆé¸å¡«ï¼‰ï¼š') || '';

            // é¸æ“‡æ€§åˆ¥
            const genderChoice = await modalChoice('é¸æ“‡æ€§åˆ¥', [{label: 'ğŸ‘¨ ç”·æ€§', value: '1'}, {label: 'ğŸ‘© å¥³æ€§', value: '2'}]);
            let gender = 'unknown';
            let emoji = 'ğŸ‘¤';
            if (genderChoice === '1') {
                gender = 'male';
                emoji = 'ğŸ‘¨';
            } else if (genderChoice === '2') {
                gender = 'female';
                emoji = 'ğŸ‘©';
            }

            loadVocabularyModifications();
            if (!vocabularyModifications.added['family']) {
                vocabularyModifications.added['family'] = [];
            }

            // æª¢æŸ¥é‡è¤‡
            const existsInSystem = familySettings.some(m => m.name === name.trim());
            const existsInAdded = vocabularyModifications.added['family'].some(w => w.text === name.trim());

            if (existsInSystem || existsInAdded) {
                showToast('æ­¤å®¶äººè§’è‰²å·²å­˜åœ¨ï¼', 'error');
                return;
            }

            vocabularyModifications.added['family'].push({
                text: name.trim(),
                zhuyin: zhuyin,
                emoji: emoji,
                gender: gender,
                customImage: null
            });

            saveVocabularyModifications();
            renderSystemWords('family');
            showToast(`å·²æ–°å¢ã€Œ${name.trim()}ã€`, 'success');
        }

        // ä¸Šå‚³ç³»çµ±å®¶äººçš„ç…§ç‰‡
        function uploadFamilyPhoto(memberId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const member = familySettings.find(m => m.id === memberId);
                    if (member) {
                        member.customImage = event.target.result;
                        localStorage.setItem('familySettings', JSON.stringify(familySettings));
                        renderSystemWords('family');
                        showToast(`å·²æ›´æ–°ã€Œ${member.name}ã€çš„ç…§ç‰‡`, 'success');
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // ä¸Šå‚³æ–°å¢å®¶äººçš„ç…§ç‰‡
        function uploadAddedFamilyPhoto(memberName) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    loadVocabularyModifications();
                    const member = (vocabularyModifications.added['family'] || []).find(m => m.text === memberName);
                    if (member) {
                        member.customImage = event.target.result;
                        saveVocabularyModifications();
                        renderSystemWords('family');
                        showToast(`å·²æ›´æ–°ã€Œ${memberName}ã€çš„ç…§ç‰‡`, 'success');
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // ç·¨è¼¯æ–°å¢çš„å®¶äºº
        async function editAddedFamilyMember(memberName) {
            loadVocabularyModifications();
            const member = (vocabularyModifications.added['family'] || []).find(m => m.text === memberName);
            if (!member) {
                showToast('æ‰¾ä¸åˆ°æ­¤å®¶äºº', 'error');
                return;
            }

            const newName = await modalPrompt('ç·¨è¼¯ç¨±å‘¼ï¼š', member.text);
            if (newName === null) return;

            const newZhuyin = await modalPrompt('ç·¨è¼¯æ³¨éŸ³ï¼š', member.zhuyin || '');
            if (newZhuyin === null) return;

            const genderChoice = await modalChoice('é¸æ“‡æ€§åˆ¥', [{label: 'ğŸ‘¨ ç”·æ€§', value: '1'}, {label: 'ğŸ‘© å¥³æ€§', value: '2'}, {label: 'ä¿æŒä¸è®Š', value: '0'}]);

            let newGender = member.gender;
            let newEmoji = member.emoji;
            if (genderChoice === '1') {
                newGender = 'male';
                newEmoji = 'ğŸ‘¨';
            } else if (genderChoice === '2') {
                newGender = 'female';
                newEmoji = 'ğŸ‘©';
            }

            // æ›´æ–°è³‡æ–™
            member.text = newName.trim() || member.text;
            member.zhuyin = newZhuyin;
            member.gender = newGender;
            member.emoji = newEmoji;

            saveVocabularyModifications();
            renderSystemWords('family');
            showToast(`å·²ä¿®æ”¹ã€Œ${memberName}ã€`, 'success');
        }

        // åˆªé™¤æ–°å¢çš„å®¶äºº
        function deleteAddedFamilyMember(memberName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${memberName}ã€å—ï¼Ÿ`)) return;

            loadVocabularyModifications();
            vocabularyModifications.added['family'] = (vocabularyModifications.added['family'] || []).filter(m => m.text !== memberName);
            saveVocabularyModifications();
            renderSystemWords('family');
            showToast(`å·²åˆªé™¤ã€Œ${memberName}ã€`, 'success');
        }

        // ==========================================
        // ä¸€èˆ¬å­—è©ç·¨è¼¯åŠŸèƒ½
        // ==========================================

        // ç·¨è¼¯ç³»çµ±å­—è©
        async function editSystemWord(category, wordText) {
            loadVocabularyModifications();
            const vocab = VOCABULARY[category];
            const originalWord = vocab.words.find(w => w.text === wordText);
            const editedVersion = (vocabularyModifications.edited[category] || {})[wordText];
            const addedVersion = (vocabularyModifications.added[category] || []).find(w => w.text === wordText);
            const currentWord = addedVersion || editedVersion || originalWord;

            if (!currentWord) {
                showToast('æ‰¾ä¸åˆ°æ­¤å­—è©', 'error');
                return;
            }

            const newText = await modalPrompt('ç·¨è¼¯å­—è©åç¨±ï¼š', currentWord.text);
            if (newText === null) return;

            const newZhuyin = await modalPrompt('ç·¨è¼¯æ³¨éŸ³ï¼š', currentWord.zhuyin);
            if (newZhuyin === null) return;

            const newEmoji = await modalPrompt('ç·¨è¼¯åœ–ç¤º (emoji)ï¼š', currentWord.emoji);
            if (newEmoji === null) return;

            if (addedVersion) {
                // å¦‚æœæ˜¯æ–°å¢çš„å­—è©ï¼Œç›´æ¥ä¿®æ”¹ added åˆ—è¡¨
                const idx = vocabularyModifications.added[category].findIndex(w => w.text === wordText);
                if (idx !== -1) {
                    vocabularyModifications.added[category][idx] = {
                        text: newText || currentWord.text,
                        zhuyin: newZhuyin || currentWord.zhuyin,
                        emoji: newEmoji || currentWord.emoji
                    };
                }
            } else {
                // ç³»çµ±å­—è©ï¼Œè¨˜éŒ„åˆ° edited
                if (!vocabularyModifications.edited[category]) {
                    vocabularyModifications.edited[category] = {};
                }
                vocabularyModifications.edited[category][wordText] = {
                    text: newText || currentWord.text,
                    zhuyin: newZhuyin || currentWord.zhuyin,
                    emoji: newEmoji || currentWord.emoji
                };
            }

            saveVocabularyModifications();
            renderSystemWords(category);
            showToast(`å·²ä¿®æ”¹ã€Œ${wordText}ã€`, 'success');
        }

        // åˆªé™¤ç³»çµ±å­—è©
        function deleteSystemWord(category, wordText, isAdded) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${wordText}ã€å—ï¼Ÿ`)) return;

            loadVocabularyModifications();

            if (isAdded) {
                // å¦‚æœæ˜¯æ–°å¢çš„å­—è©ï¼Œç›´æ¥å¾ added åˆ—è¡¨ç§»é™¤
                vocabularyModifications.added[category] =
                    (vocabularyModifications.added[category] || []).filter(w => w.text !== wordText);
            } else {
                // å¦‚æœæ˜¯ç³»çµ±å­—è©ï¼ŒåŠ å…¥ deleted åˆ—è¡¨
                if (!vocabularyModifications.deleted[category]) {
                    vocabularyModifications.deleted[category] = [];
                }
                if (!vocabularyModifications.deleted[category].includes(wordText)) {
                    vocabularyModifications.deleted[category].push(wordText);
                }
                // åŒæ™‚ç§»é™¤å¯èƒ½çš„ç·¨è¼¯è¨˜éŒ„
                if (vocabularyModifications.edited[category]) {
                    delete vocabularyModifications.edited[category][wordText];
                }
            }

            saveVocabularyModifications();
            renderSystemWords(category);
            showToast(`å·²åˆªé™¤ã€Œ${wordText}ã€`);
        }

        // æ–°å¢å­—è©åˆ°é¡åˆ¥
        async function showAddWordToCategory(category) {
            const vocab = VOCABULARY[category];
            const text = await modalPrompt(`æ–°å¢å­—è©åˆ°ã€Œ${vocab.name}ã€ï¼š`);
            if (!text || !text.trim()) return;

            const zhuyin = await modalPrompt('è¼¸å…¥æ³¨éŸ³ï¼ˆé¸å¡«ï¼‰ï¼š') || '';
            const emoji = await modalPrompt('è¼¸å…¥åœ–ç¤º emojiï¼ˆé¸å¡«ï¼‰ï¼š') || 'ğŸ“';

            loadVocabularyModifications();

            if (!vocabularyModifications.added[category]) {
                vocabularyModifications.added[category] = [];
            }

            // æª¢æŸ¥é‡è¤‡
            const existsInSystem = vocab.words.some(w => w.text === text.trim());
            const existsInAdded = vocabularyModifications.added[category].some(w => w.text === text.trim());
            const isDeleted = (vocabularyModifications.deleted[category] || []).includes(text.trim());

            if ((existsInSystem && !isDeleted) || existsInAdded) {
                showToast('æ­¤å­—è©å·²å­˜åœ¨ï¼', 'error');
                return;
            }

            // å¦‚æœæ˜¯æ¢å¾©å·²åˆªé™¤çš„å­—è©
            if (isDeleted) {
                vocabularyModifications.deleted[category] =
                    vocabularyModifications.deleted[category].filter(t => t !== text.trim());
                showToast(`å·²æ¢å¾©ã€Œ${text.trim()}ã€`, 'success');
            } else {
                vocabularyModifications.added[category].push({
                    text: text.trim(),
                    zhuyin: zhuyin,
                    emoji: emoji,
                    image: null
                });
                showToast(`å·²æ–°å¢ã€Œ${text.trim()}ã€åˆ°${vocab.name}`, 'success');
            }

            saveVocabularyModifications();
            renderSystemWords(category);
        }

        function copyToCustom(text, zhuyin, emoji) {
            // å¡«å…¥è¡¨å–®
            document.getElementById('newWord').value = text;
            document.getElementById('newWordZhuyin').value = zhuyin;

            // åˆ‡æ›åˆ°è‡ªè¨‚å­—è©å€
            switchVocabCategory('custom');

            showToast(`å·²è¤‡è£½ã€Œ${text}ã€ï¼Œå¯ç›´æ¥æ–°å¢æˆ–ä¿®æ”¹`, 'success');
        }

        // ==========================================
        // ä¾‹å¥å€å¡ŠåŠŸèƒ½
        // ==========================================
        function switchSentenceType(type) {
            currentSentenceType = type;

            // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
            document.querySelectorAll('.sentence-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });

            renderSentences();
        }

        function renderSentences() {
            const statsContainer = document.getElementById('sentenceStats');
            const container = document.getElementById('sentencesContainer');

            // æª¢æŸ¥ SENTENCES æ˜¯å¦å·²è¼‰å…¥
            if (typeof SENTENCES === 'undefined') {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">ä¾‹å¥è³‡æ–™è¼‰å…¥ä¸­...</p>';
                return;
            }

            const typeLabels = {
                simple: 'ç°¡å–®å¥å­',
                questions: 'å•ç­”ç·´ç¿’',
                fillBlanks: 'å¡«ç©ºç·´ç¿’',
                dialogs: 'å°è©±ç·´ç¿’'
            };

            const typeColors = {
                simple: '#4caf50',
                questions: '#2196f3',
                fillBlanks: '#9c27b0',
                dialogs: '#ff9800'
            };

            const data = SENTENCES[currentSentenceType];
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">æ­¤é¡å‹å°šç„¡ä¾‹å¥</p>';
                statsContainer.innerHTML = '';
                return;
            }

            // ä¾‹å¥éŠæˆ²å°æ‡‰
            const sentenceGameMapping = {
                simple: 'è©å½™æ’åº',
                questions: 'å•ç­”ç·´ç¿’',
                fillBlanks: 'å¥å­å¡«ç©º',
                dialogs: 'ç”Ÿæ´»å°è©±ã€æœ—è®€ç·´ç¿’'
            };

            // é¡¯ç¤ºçµ±è¨ˆå’ŒéŠæˆ²å°æ‡‰
            statsContainer.innerHTML = `
                <div class="mini-stat" style="background: linear-gradient(135deg, ${typeColors[currentSentenceType]}, ${typeColors[currentSentenceType]}aa);">
                    <div class="value">${data.length}</div>
                    <div class="label">${typeLabels[currentSentenceType]}</div>
                </div>
                <div style="flex: 1; background: #fff3e0; padding: 10px 15px; border-radius: 12px; border-left: 4px solid #ff9800; font-size: 0.85rem;">
                    <strong style="color: #e65100;">ğŸ® ä½¿ç”¨æ­¤é¡åˆ¥çš„éŠæˆ²ï¼š</strong><br>
                    <span style="color: #666;">${sentenceGameMapping[currentSentenceType] || 'ä¾‹å¥é¡éŠæˆ²'}</span>
                </div>
            `;

            // æ ¹æ“šé¡å‹é¡¯ç¤ºä¸åŒæ ¼å¼
            if (currentSentenceType === 'simple') {
                container.innerHTML = data.map(s => `
                    <div class="sentence-card">
                        <div class="sentence-text">${s.text}</div>
                        <div class="sentence-parts">çµ„æˆï¼š${s.parts.join(' + ')}</div>
                    </div>
                `).join('');
            } else if (currentSentenceType === 'questions') {
                container.innerHTML = data.map(s => `
                    <div class="sentence-card">
                        <div class="sentence-text">â“ ${s.question}</div>
                        <div class="sentence-parts">ç­”æ¡ˆï¼š${s.answer}ï¼ˆé—œéµè©ï¼š${s.word}ï¼‰</div>
                    </div>
                `).join('');
            } else if (currentSentenceType === 'fillBlanks') {
                container.innerHTML = data.map(s => `
                    <div class="sentence-card">
                        <div class="sentence-text">ğŸ“‹ ${s.sentence}</div>
                        <div class="sentence-parts">é¸é …ï¼š${s.options.join('ã€')} â†’ æ­£ç¢ºç­”æ¡ˆï¼š<strong>${s.answer}</strong></div>
                    </div>
                `).join('');
            } else if (currentSentenceType === 'dialogs') {
                container.innerHTML = data.map(d => `
                    <div class="sentence-card">
                        <div class="sentence-text">ğŸ’¬ ${d.title}</div>
                        <div class="sentence-parts">
                            ${d.lines.map(line => `<div style="margin-top: 5px;"><strong>${line.role}ï¼š</strong>${line.text}</div>`).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

        // ==========================================
        // ä½¿ç”¨è€…åç¨±åŠŸèƒ½
        // ==========================================
        let userName = '';

        function loadUserName() {
            userName = localStorage.getItem('userName') || '';
            document.getElementById('userName').value = userName;
            updateUserNamePreview();
        }

        function saveUserName() {
            userName = document.getElementById('userName').value.trim();
            localStorage.setItem('userName', userName);
            updateUserNamePreview();
            showToast(userName ? `å·²è¨­å®šåç¨±ç‚ºã€Œ${userName}ã€` : 'å·²æ¸…é™¤åç¨±è¨­å®š', 'success');
        }

        function updateUserNamePreview() {
            const preview = document.getElementById('userNamePreview');
            const previewText = document.getElementById('previewText');

            if (userName) {
                preview.style.display = 'block';
                const examples = [
                    `${userName}ï¼Œä½ å¥½æ£’ï¼`,
                    `${userName}ï¼Œå†è©¦ä¸€æ¬¡ï¼`,
                    `å¤ªå²å®³äº†ï¼Œ${userName}ï¼`
                ];
                previewText.textContent = examples[Math.floor(Math.random() * examples.length)];
            } else {
                preview.style.display = 'none';
            }
        }

        // åç¨±è¼¸å…¥æ™‚å³æ™‚é è¦½
        document.addEventListener('DOMContentLoaded', function() {
            const userNameInput = document.getElementById('userName');
            if (userNameInput) {
                userNameInput.addEventListener('input', function() {
                    userName = this.value.trim();
                    updateUserNamePreview();
                });
            }
        });

        // ==========================================
        // èªéŸ³ç›¸ä¼¼åº¦è¨­å®šåŠŸèƒ½
        // ==========================================

        function loadSimilarityThreshold() {
            const threshold = parseInt(localStorage.getItem('similarityThreshold') || '0');
            const slider = document.getElementById('similarityThreshold');
            const display = document.getElementById('thresholdValue');

            slider.value = threshold;
            display.textContent = threshold + '%';
            updateThresholdPresets(threshold);

            // æ»‘æ¡¿äº‹ä»¶
            slider.addEventListener('input', function() {
                const value = parseInt(this.value);
                display.textContent = value + '%';
                updateThresholdPresets(value);
            });

            slider.addEventListener('change', function() {
                const value = parseInt(this.value);
                localStorage.setItem('similarityThreshold', value.toString());
                showToast(`éé—œé–€æª»å·²è¨­å®šç‚º ${value}%`, 'success');
            });
        }

        function setThreshold(value) {
            const slider = document.getElementById('similarityThreshold');
            const display = document.getElementById('thresholdValue');

            slider.value = value;
            display.textContent = value + '%';
            localStorage.setItem('similarityThreshold', value.toString());
            updateThresholdPresets(value);
            showToast(`éé—œé–€æª»å·²è¨­å®šç‚º ${value}%`, 'success');
        }

        function updateThresholdPresets(value) {
            document.querySelectorAll('.threshold-preset').forEach(btn => {
                const btnValue = parseInt(btn.dataset.value);
                btn.classList.toggle('active', btnValue === value);
            });
        }

        // ==========================================
        // ç™¼éŸ³ç´€éŒ„åŠŸèƒ½
        // ==========================================

        function loadPronunciationRecords() {
            renderPronunciationSummary();
            renderPronunciationByType();
            renderNeedsImprovement();
            renderRecentProgress();
            renderDetailedRecords();
        }

        function getPronunciationRecords() {
            return JSON.parse(localStorage.getItem('pronunciationRecords') || '{}');
        }

        function renderPronunciationSummary() {
            const container = document.getElementById('pronunciationSummary');
            const records = getPronunciationRecords();

            let totalAttempts = 0;
            let totalItems = 0;
            let totalBestScore = 0;

            Object.values(records).forEach(typeRecords => {
                Object.values(typeRecords).forEach(record => {
                    totalAttempts += record.attempts || 0;
                    totalItems++;
                    totalBestScore += record.bestScore || 0;
                });
            });

            const avgScore = totalItems > 0 ? Math.round(totalBestScore / totalItems) : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalItems}</div>
                    <div class="stat-label">å·²ç·´ç¿’é …ç›®</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-value">${totalAttempts}</div>
                    <div class="stat-label">ç¸½ç·´ç¿’æ¬¡æ•¸</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-value">${avgScore}%</div>
                    <div class="stat-label">å¹³å‡æœ€é«˜åˆ†</div>
                </div>
            `;

            if (totalItems === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ“Š</div>
                        <p>å°šç„¡ç·´ç¿’ç´€éŒ„</p>
                        <p style="font-size: 0.9rem;">é–‹å§‹ç·´ç¿’å¾Œï¼Œç´€éŒ„æœƒé¡¯ç¤ºåœ¨é€™è£¡</p>
                    </div>
                `;
            }
        }

        function renderPronunciationByType() {
            const container = document.getElementById('pronunciationByType');
            const records = getPronunciationRecords();

            const typeNames = {
                zhuyin: 'æ³¨éŸ³ç¬¦è™Ÿ',
                word: 'å­—è©',
                number: 'æ•¸å­—',
                sentence: 'å¥å­'
            };

            const typeStats = {};
            Object.entries(records).forEach(([type, typeRecords]) => {
                const items = Object.values(typeRecords);
                if (items.length > 0) {
                    const totalScore = items.reduce((sum, r) => sum + (r.bestScore || 0), 0);
                    typeStats[type] = {
                        count: items.length,
                        avgScore: Math.round(totalScore / items.length),
                        totalAttempts: items.reduce((sum, r) => sum + (r.attempts || 0), 0)
                    };
                }
            });

            if (Object.keys(typeStats).length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = `
                <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“ˆ åˆ†é¡çµ±è¨ˆ</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    ${Object.entries(typeStats).map(([type, stats]) => `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; border-left: 4px solid ${getTypeColor(type)};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span class="type-badge ${type}">${typeNames[type] || type}</span>
                                <span style="font-weight: bold; color: #333;">${stats.avgScore}%</span>
                            </div>
                            <div style="color: #666; font-size: 0.85rem;">
                                ${stats.count} é …ç›® Â· ${stats.totalAttempts} æ¬¡ç·´ç¿’
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getTypeColor(type) {
            const colors = {
                zhuyin: '#9c27b0',
                word: '#4caf50',
                number: '#2196f3',
                sentence: '#ff9800'
            };
            return colors[type] || '#667eea';
        }

        function renderNeedsImprovement() {
            const section = document.getElementById('needsImprovementSection');
            const list = document.getElementById('needsImprovementList');
            const records = getPronunciationRecords();

            const needsWork = [];
            Object.entries(records).forEach(([type, typeRecords]) => {
                Object.entries(typeRecords).forEach(([target, record]) => {
                    if ((record.bestScore || 0) < 50) {
                        needsWork.push({ type, target, bestScore: record.bestScore || 0 });
                    }
                });
            });

            if (needsWork.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            needsWork.sort((a, b) => a.bestScore - b.bestScore);

            list.innerHTML = needsWork.slice(0, 10).map(item => `
                <div class="improvement-item">
                    <span class="target">${item.target}</span>
                    <span class="score">${item.bestScore}%</span>
                </div>
            `).join('');
        }

        function renderRecentProgress() {
            const section = document.getElementById('recentProgressSection');
            const list = document.getElementById('recentProgressList');
            const records = getPronunciationRecords();

            const improved = [];
            Object.entries(records).forEach(([type, typeRecords]) => {
                Object.entries(typeRecords).forEach(([target, record]) => {
                    if (record.history && record.history.length >= 2) {
                        const recent = record.history.slice(-5);
                        const firstScore = recent[0].similarity || 0;
                        const lastScore = recent[recent.length - 1].similarity || 0;
                        const improvement = lastScore - firstScore;
                        if (improvement > 10) {
                            improved.push({ type, target, improvement, currentScore: record.bestScore });
                        }
                    }
                });
            });

            if (improved.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            improved.sort((a, b) => b.improvement - a.improvement);

            list.innerHTML = improved.slice(0, 10).map(item => `
                <div class="progress-item">
                    <span class="target">${item.target}</span>
                    <span class="improvement">â†‘${item.improvement}%</span>
                </div>
            `).join('');
        }

        function renderDetailedRecords() {
            const container = document.getElementById('detailedRecords');
            const filter = document.getElementById('recordTypeFilter').value;
            const records = getPronunciationRecords();

            const typeNames = {
                zhuyin: 'æ³¨éŸ³',
                word: 'å­—è©',
                number: 'æ•¸å­—',
                sentence: 'å¥å­'
            };

            const allRecords = [];
            Object.entries(records).forEach(([type, typeRecords]) => {
                if (filter === 'all' || filter === type) {
                    Object.entries(typeRecords).forEach(([target, record]) => {
                        allRecords.push({
                            type,
                            target,
                            bestScore: record.bestScore || 0,
                            attempts: record.attempts || 0,
                            lastPracticed: record.history && record.history.length > 0
                                ? record.history[record.history.length - 1].timestamp
                                : null
                        });
                    });
                }
            });

            if (allRecords.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æœ€é«˜åˆ†æ’åº
            allRecords.sort((a, b) => b.bestScore - a.bestScore);

            container.innerHTML = allRecords.map(record => {
                const scoreClass = record.bestScore >= 90 ? 'excellent'
                    : record.bestScore >= 80 ? 'good'
                    : record.bestScore >= 50 ? 'fair'
                    : 'needs-work';

                return `
                    <div class="record-item">
                        <span class="type-badge ${record.type}">${typeNames[record.type]}</span>
                        <span class="record-target">${record.target}</span>
                        <span class="record-score ${scoreClass}">${record.bestScore}%</span>
                        <span class="record-attempts">${record.attempts} æ¬¡ç·´ç¿’</span>
                    </div>
                `;
            }).join('');
        }

        function exportRecords() {
            const records = getPronunciationRecords();
            const report = generatePronunciationReport();

            const exportData = {
                exportDate: new Date().toISOString(),
                userName: localStorage.getItem('userName') || 'æœªè¨­å®š',
                similarityThreshold: parseInt(localStorage.getItem('similarityThreshold') || '0'),
                summary: report,
                detailedRecords: records
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç™¼éŸ³ç·´ç¿’ç´€éŒ„_${new Date().toLocaleDateString('zh-TW').replace(/\//g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('ç´€éŒ„å·²åŒ¯å‡º', 'success');
        }

        function generatePronunciationReport() {
            const records = getPronunciationRecords();

            let totalAttempts = 0;
            let totalItems = 0;
            let totalBestScore = 0;
            const byType = {};

            Object.entries(records).forEach(([type, typeRecords]) => {
                const items = Object.values(typeRecords);
                if (items.length > 0) {
                    totalItems += items.length;
                    const typeTotal = items.reduce((sum, r) => sum + (r.bestScore || 0), 0);
                    const typeAttempts = items.reduce((sum, r) => sum + (r.attempts || 0), 0);
                    totalBestScore += typeTotal;
                    totalAttempts += typeAttempts;

                    byType[type] = {
                        count: items.length,
                        avgScore: Math.round(typeTotal / items.length),
                        totalAttempts: typeAttempts
                    };
                }
            });

            return {
                totalItems,
                totalAttempts,
                avgBestScore: totalItems > 0 ? Math.round(totalBestScore / totalItems) : 0,
                byType
            };
        }

        function refreshRecords() {
            loadPronunciationRecords();
            showToast('å·²é‡æ–°æ•´ç†', 'success');
        }

        function clearRecords() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç™¼éŸ³ç·´ç¿’ç´€éŒ„å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                localStorage.removeItem('pronunciationRecords');
                loadPronunciationRecords();
                showToast('ç´€éŒ„å·²æ¸…é™¤', 'success');
            }
        }

        // ==========================================
        // éº¥å…‹é¢¨æ¸¬è©¦åŠŸèƒ½
        // ==========================================
        let audioContext = null;
        let analyser = null;
        let microphoneStream = null;
        let volumeInterval = null;
        let testRecognition = null;

        async function testMicrophone() {
            const statusEl = document.getElementById('micStatus');
            const meterEl = document.getElementById('volumeMeter');
            const testBtn = document.getElementById('testMicBtn');
            const speechBtn = document.getElementById('testSpeechBtn');
            const hintEl = document.getElementById('micTestHint');
            const hintTextEl = document.getElementById('micTestHintText');

            // å¦‚æœå·²ç¶“åœ¨æ¸¬è©¦ï¼Œåœæ­¢æ¸¬è©¦
            if (volumeInterval) {
                stopMicTest();
                return;
            }

            statusEl.textContent = 'ğŸ”„ æ­£åœ¨è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™...';
            statusEl.style.color = '#666';
            testBtn.textContent = 'â³ è«‹ç¨å€™...';
            testBtn.disabled = true;

            try {
                // è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphoneStream = stream;

                // å»ºç«‹éŸ³è¨Šåˆ†æå™¨
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                statusEl.textContent = 'âœ… éº¥å…‹é¢¨æ¬Šé™å·²æˆäºˆï¼è«‹èªªè©±æ¸¬è©¦éŸ³é‡...';
                statusEl.style.color = '#4caf50';
                testBtn.textContent = 'â¹ï¸ åœæ­¢æ¸¬è©¦';
                testBtn.disabled = false;
                speechBtn.style.display = 'inline-block';

                // é¡¯ç¤ºæç¤º
                hintEl.style.display = 'block';
                hintTextEl.textContent = 'å°è‘—éº¥å…‹é¢¨èªªè©±ï¼Œè§€å¯ŸéŸ³é‡æ¢æ˜¯å¦æœ‰åæ‡‰ã€‚ç¶ è‰²æ¢æœƒéš¨è‘—éŸ³é‡è·³å‹•ã€‚';

                let maxVolume = 0;
                let hasDetectedSound = false;

                // é–‹å§‹éŸ³é‡åµæ¸¬
                volumeInterval = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                    const volume = Math.min(100, average * 1.5);
                    meterEl.style.width = volume + '%';

                    if (volume > maxVolume) {
                        maxVolume = volume;
                    }

                    if (volume > 10 && !hasDetectedSound) {
                        hasDetectedSound = true;
                        statusEl.textContent = 'ğŸ¤ å¾ˆå¥½ï¼åµæ¸¬åˆ°è²éŸ³ï¼ç¹¼çºŒèªªè©±æˆ–æŒ‰ã€Œæ¸¬è©¦èªéŸ³è¾¨è­˜ã€';
                        hintTextEl.textContent = 'éº¥å…‹é¢¨æ­£å¸¸é‹ä½œï¼ç¾åœ¨å¯ä»¥æ¸¬è©¦èªéŸ³è¾¨è­˜åŠŸèƒ½ã€‚';
                        hintEl.style.background = '#e8f5e9';
                        hintEl.style.borderColor = '#4caf50';
                        hintTextEl.parentElement.style.color = '#2e7d32';
                    }
                }, 100);

            } catch (err) {
                console.error('éº¥å…‹é¢¨æ¬Šé™éŒ¯èª¤:', err);
                statusEl.textContent = 'âŒ ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼š' + (err.message || err.name);
                statusEl.style.color = '#f44336';
                testBtn.textContent = 'ğŸ¤ é‡æ–°æ¸¬è©¦';
                testBtn.disabled = false;

                // é¡¯ç¤ºéŒ¯èª¤æç¤º
                hintEl.style.display = 'block';
                hintEl.style.background = '#ffebee';
                hintEl.style.borderColor = '#f44336';
                hintTextEl.parentElement.style.color = '#c62828';

                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    hintTextEl.textContent = 'è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±æ­¤ç¶²ç«™å­˜å–éº¥å…‹é¢¨ã€‚åœ¨ Safari ä¸­ï¼šè¨­å®š > Safari > ç¶²ç«™è¨­å®š > éº¥å…‹é¢¨ã€‚';
                } else if (err.name === 'NotFoundError') {
                    hintTextEl.textContent = 'æ‰¾ä¸åˆ°éº¥å…‹é¢¨è£ç½®ã€‚è«‹ç¢ºèªæ‚¨çš„è£ç½®æœ‰éº¥å…‹é¢¨ï¼Œä¸”å·²æ­£ç¢ºé€£æ¥ã€‚';
                } else {
                    hintTextEl.textContent = 'ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message + 'ã€‚è«‹å˜—è©¦é‡æ–°æ•´ç†é é¢æˆ–ä½¿ç”¨å…¶ä»–ç€è¦½å™¨ã€‚';
                }
            }
        }

        function stopMicTest() {
            if (volumeInterval) {
                clearInterval(volumeInterval);
                volumeInterval = null;
            }
            if (microphoneStream) {
                microphoneStream.getTracks().forEach(track => track.stop());
                microphoneStream = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            document.getElementById('volumeMeter').style.width = '0%';
            document.getElementById('testMicBtn').textContent = 'ğŸ¤ æ¸¬è©¦éº¥å…‹é¢¨';
            document.getElementById('micStatus').textContent = 'æ¸¬è©¦å·²åœæ­¢';
            document.getElementById('micStatus').style.color = '#666';
        }

        function testSpeechRecognition() {
            const statusEl = document.getElementById('micStatus');
            const speechBtn = document.getElementById('testSpeechBtn');
            const resultEl = document.getElementById('speechResult');
            const resultTextEl = document.getElementById('speechResultText');
            const hintEl = document.getElementById('micTestHint');
            const hintTextEl = document.getElementById('micTestHintText');

            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                statusEl.textContent = 'âŒ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜';
                statusEl.style.color = '#f44336';
                hintEl.style.display = 'block';
                hintEl.style.background = '#ffebee';
                hintEl.style.borderColor = '#f44336';
                hintTextEl.parentElement.style.color = '#c62828';
                hintTextEl.textContent = 'å»ºè­°ä½¿ç”¨ Google Chrome æˆ– Microsoft Edge ç€è¦½å™¨ä»¥ç²å¾—æœ€ä½³èªéŸ³è¾¨è­˜é«”é©—ã€‚';
                return;
            }

            // å¦‚æœå·²ç¶“åœ¨è¾¨è­˜ï¼Œåœæ­¢
            if (testRecognition) {
                testRecognition.stop();
                testRecognition = null;
                speechBtn.textContent = 'ğŸ—£ï¸ æ¸¬è©¦èªéŸ³è¾¨è­˜';
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            testRecognition = new SpeechRecognition();
            testRecognition.lang = 'zh-TW';
            testRecognition.continuous = false;
            testRecognition.interimResults = true;
            testRecognition.maxAlternatives = 3;

            let lastTranscript = '';

            testRecognition.onstart = () => {
                statusEl.textContent = 'ğŸ™ï¸ æ­£åœ¨è†è½...è«‹èªªä¸€å¥è©±ï¼';
                statusEl.style.color = '#2196f3';
                speechBtn.textContent = 'â¹ï¸ åœæ­¢è¾¨è­˜';
                resultEl.style.display = 'none';
            };

            testRecognition.onresult = (event) => {
                const result = event.results[event.results.length - 1];
                const transcript = result[0].transcript;
                const isFinal = result.isFinal;

                lastTranscript = transcript;

                resultEl.style.display = 'block';
                resultTextEl.textContent = transcript + (isFinal ? '' : '...');

                if (isFinal) {
                    statusEl.textContent = 'âœ… èªéŸ³è¾¨è­˜æˆåŠŸï¼';
                    statusEl.style.color = '#4caf50';
                }
            };

            testRecognition.onend = () => {
                speechBtn.textContent = 'ğŸ—£ï¸ æ¸¬è©¦èªéŸ³è¾¨è­˜';
                testRecognition = null;

                // Safari ä¿®æ­£ï¼šå¦‚æœæœ‰æ”¶åˆ°æ–‡å­—ä½†æ²’æœ‰ isFinalï¼Œåœ¨é€™è£¡è™•ç†
                if (lastTranscript) {
                    resultEl.style.display = 'block';
                    resultTextEl.textContent = lastTranscript;
                    statusEl.textContent = 'âœ… èªéŸ³è¾¨è­˜æˆåŠŸï¼';
                    statusEl.style.color = '#4caf50';

                    hintEl.style.display = 'block';
                    hintEl.style.background = '#e8f5e9';
                    hintEl.style.borderColor = '#4caf50';
                    hintTextEl.parentElement.style.color = '#2e7d32';
                    hintTextEl.textContent = 'å¤ªæ£’äº†ï¼èªéŸ³è¾¨è­˜æ­£å¸¸é‹ä½œã€‚æ‚¨å¯ä»¥é–‹å§‹ä½¿ç”¨èªéŸ³ç·´ç¿’éŠæˆ²äº†ï¼';
                } else {
                    statusEl.textContent = 'æ²’æœ‰è½åˆ°è²éŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡';
                    statusEl.style.color = '#ff9800';
                }
            };

            testRecognition.onerror = (event) => {
                console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
                speechBtn.textContent = 'ğŸ—£ï¸ æ¸¬è©¦èªéŸ³è¾¨è­˜';

                if (event.error === 'no-speech') {
                    statusEl.textContent = 'æ²’æœ‰åµæ¸¬åˆ°èªéŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡';
                    statusEl.style.color = '#ff9800';
                } else if (event.error === 'not-allowed') {
                    statusEl.textContent = 'âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•';
                    statusEl.style.color = '#f44336';
                } else {
                    statusEl.textContent = 'âŒ èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š' + event.error;
                    statusEl.style.color = '#f44336';
                }

                testRecognition = null;
            };

            try {
                testRecognition.start();
            } catch (err) {
                console.error('å•Ÿå‹•è¾¨è­˜å¤±æ•—:', err);
                statusEl.textContent = 'âŒ ç„¡æ³•å•Ÿå‹•èªéŸ³è¾¨è­˜';
                statusEl.style.color = '#f44336';
            }
        }

        // ==========================================
        // åˆå§‹åŒ–
        // ==========================================
        function init() {
            loadUserName();
            loadCustomWords();
            loadSettings();
            loadVocabularyModifications();
            loadSimilarityThreshold();
            loadPronunciationRecords();
            // renderFamilyGrid(); // å®¶äººè¨­å®šå·²æ•´åˆåˆ°å­—è©åº«ç®¡ç†
            renderUploadedImages();
            setupUploadEvents();
            // é è¨­é¡¯ç¤ºè‡ªè¨‚å­—è©å€
            switchVocabCategory('custom');
        }

        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            const saved = localStorage.getItem('familySettings');
            if (saved) {
                familySettings = JSON.parse(saved);
                // åˆä½µæ–°å¢çš„é è¨­è§’è‰²ï¼ˆå¦‚èˆ…èˆ…ã€å§‘å§‘ï¼‰
                DEFAULT_FAMILY.forEach(defaultMember => {
                    if (!familySettings.find(m => m.id === defaultMember.id)) {
                        familySettings.push(JSON.parse(JSON.stringify(defaultMember)));
                    }
                });
            } else {
                familySettings = JSON.parse(JSON.stringify(DEFAULT_FAMILY));
            }

            const savedImages = localStorage.getItem('uploadedImages');
            if (savedImages) {
                uploadedImages = JSON.parse(savedImages);
            }
        }

        // æ¸²æŸ“å®¶äººç¶²æ ¼ï¼ˆç”¨æ–¼åœ–ç‰‡ä¸Šå‚³é¸æ“‡ï¼‰
        function renderFamilyGrid() {
            const grid = document.getElementById('familyGrid');
            if (!grid) return; // å®¶äººè¨­å®šå€å¡Šå·²ç§»é™¤ï¼Œè·³é
            grid.innerHTML = '';

            familySettings.forEach((member) => {
                const item = document.createElement('div');
                item.className = 'character-item' + (member.enabled ? ' selected' : ' disabled');
                item.innerHTML = `
                    <span class="emoji">${member.customImage ? '<img src="' + member.customImage + '" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">' : member.emoji}</span>
                    <span class="name">${member.name}</span>
                    <span class="status">${member.enabled ? 'âœ“ å·²å•Ÿç”¨' : 'âœ— å·²åœç”¨'}</span>
                    <div class="edit-controls">
                        <button class="edit-btn rename" onclick="event.stopPropagation(); openRenameModal('${member.id}')">æ”¹å</button>
                        <button class="edit-btn ${member.enabled ? 'delete' : ''}" onclick="event.stopPropagation(); toggleMember('${member.id}')">${member.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}</button>
                    </div>
                `;
                item.onclick = () => toggleMember(member.id);
                grid.appendChild(item);
            });
        }

        // åˆ‡æ›æˆå“¡å•Ÿç”¨ç‹€æ…‹
        function toggleMember(id) {
            const member = familySettings.find(m => m.id === id);
            if (member) {
                member.enabled = !member.enabled;
                // è‡ªå‹•å„²å­˜åˆ° localStorage
                localStorage.setItem('familySettings', JSON.stringify(familySettings));
                renderFamilyGrid();
                showToast(member.enabled ? `å·²å•Ÿç”¨ã€Œ${member.name}ã€` : `å·²åœç”¨ã€Œ${member.name}ã€`, 'success');
            }
        }

        // æ‰“é–‹é‡å‘½å Modal
        function openRenameModal(id) {
            currentEditingId = id;
            const member = familySettings.find(m => m.id === id);
            document.getElementById('renameInput').value = member.name;
            document.getElementById('renameModal').classList.add('show');
        }

        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('renameModal').classList.remove('show');
            currentEditingId = null;
        }

        // ç¢ºèªé‡å‘½å
        function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (newName && currentEditingId) {
                const member = familySettings.find(m => m.id === currentEditingId);
                member.name = newName;
                // è‡ªå‹•å„²å­˜åˆ° localStorage
                localStorage.setItem('familySettings', JSON.stringify(familySettings));
                renderFamilyGrid();
                showToast(`å·²æ”¹åç‚ºã€Œ${newName}ã€`, 'success');
            }
            closeModal();
        }

        // è¨­å®šä¸Šå‚³äº‹ä»¶
        function setupUploadEvents() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');

            // æ‹–æ›³äº‹ä»¶
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // æ–‡ä»¶é¸æ“‡
            imageInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // è™•ç†ä¸Šå‚³çš„æ–‡ä»¶
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    // æ‰“é–‹åˆ†é… Modal
                    currentAssigningImage = imageData;
                    openAssignModal();
                };
                reader.readAsDataURL(file);
            });
        }

        // æ‰“é–‹åˆ†é… Modal
        function openAssignModal() {
            const grid = document.getElementById('assignGrid');
            grid.innerHTML = '';

            familySettings.forEach((member) => {
                const item = document.createElement('div');
                item.className = 'character-item';
                item.innerHTML = `
                    <span class="emoji">${member.emoji}</span>
                    <span class="name">${member.name}</span>
                `;
                item.onclick = () => assignImageToMember(member.id);
                grid.appendChild(item);
            });

            document.getElementById('assignModal').classList.add('show');
        }

        // é—œé–‰åˆ†é… Modal
        function closeAssignModal() {
            document.getElementById('assignModal').classList.remove('show');
            currentAssigningImage = null;
        }

        // å°‡åœ–ç‰‡åˆ†é…çµ¦æˆå“¡
        function assignImageToMember(id) {
            const member = familySettings.find(m => m.id === id);
            if (member && currentAssigningImage) {
                member.customImage = currentAssigningImage;

                // å„²å­˜åˆ°å·²ä¸Šå‚³åœ–ç‰‡åˆ—è¡¨
                uploadedImages.push({
                    id: Date.now(),
                    image: currentAssigningImage,
                    assignedTo: id,
                    memberName: member.name
                });

                renderFamilyGrid();
                renderUploadedImages();
                showToast(`å·²è¨­å®šã€Œ${member.name}ã€çš„åœ–ç‰‡`, 'success');
            }
            closeAssignModal();
        }

        // æ¸²æŸ“å·²ä¸Šå‚³åœ–ç‰‡
        function renderUploadedImages() {
            const container = document.getElementById('uploadedImages');
            container.innerHTML = '';

            uploadedImages.forEach((img) => {
                const item = document.createElement('div');
                item.className = 'uploaded-image';
                item.innerHTML = `
                    <img src="${img.image}" alt="${img.memberName}">
                    <button class="delete-btn" onclick="removeUploadedImage(${img.id})">âœ•</button>
                    <div class="label">${img.memberName}</div>
                `;
                container.appendChild(item);
            });
        }

        // ç§»é™¤å·²ä¸Šå‚³åœ–ç‰‡
        function removeUploadedImage(id) {
            const img = uploadedImages.find(i => i.id === id);
            if (img) {
                // ç§»é™¤æˆå“¡çš„è‡ªè¨‚åœ–ç‰‡
                const member = familySettings.find(m => m.id === img.assignedTo);
                if (member) {
                    member.customImage = null;
                }
            }

            uploadedImages = uploadedImages.filter(i => i.id !== id);
            renderFamilyGrid();
            renderUploadedImages();
            showToast('å·²ç§»é™¤åœ–ç‰‡');
        }

        // å„²å­˜è¨­å®š
        function saveSettings() {
            localStorage.setItem('familySettings', JSON.stringify(familySettings));
            localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
            showToast('è¨­å®šå·²å„²å­˜ï¼', 'success');
        }

        // é‡ç½®å­¸ç¿’é€²åº¦
        function resetProgress() {
            // ç¬¬ä¸€æ¬¡ç¢ºèª
            if (!confirm('âš ï¸ è­¦å‘Šï¼\n\nç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç¿’é€²åº¦å—ï¼Ÿ\n\né€™å°‡æ¸…é™¤ï¼š\nâ€¢ å·²æŒæ¡çš„æ³¨éŸ³ç¬¦è™Ÿ\nâ€¢ å·²å­¸ç¿’çš„å­—è©\nâ€¢ æ‰€æœ‰ç™¼éŸ³ç·´ç¿’ç´€éŒ„\n\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            // ç¬¬äºŒæ¬¡ç¢ºèª
            if (!confirm('âš ï¸ æœ€å¾Œç¢ºèªï¼\n\nçœŸçš„è¦åˆªé™¤æ‰€æœ‰å­¸ç¿’ç´€éŒ„å—ï¼Ÿ\n\nè«‹æŒ‰ã€Œç¢ºå®šã€ç¹¼çºŒï¼Œæˆ–ã€Œå–æ¶ˆã€ä¿ç•™è³‡æ–™ã€‚')) {
                showToast('å·²å–æ¶ˆé‡ç½®', '');
                return;
            }

            // åŸ·è¡Œé‡ç½®
            localStorage.removeItem('masteredZhuyin');
            localStorage.removeItem('masteredWords_level2');
            localStorage.removeItem('masteredWords_level3');
            localStorage.removeItem('pronunciationRecords');

            // é‡æ–°è¼‰å…¥ç´€éŒ„é¡¯ç¤º
            loadPronunciationRecords();

            showToast('âœ… å­¸ç¿’é€²åº¦å·²é‡ç½®', 'success');
        }

        // é‚„åŸé è¨­å€¼
        function resetAll() {
            // ç¬¬ä¸€æ¬¡ç¢ºèª
            if (!confirm('âš ï¸ è­¦å‘Šï¼\n\nç¢ºå®šè¦é‚„åŸæ‰€æœ‰è¨­å®šç‚ºé è¨­å€¼å—ï¼Ÿ\n\né€™å°‡æ¸…é™¤ï¼š\nâ€¢ ä½¿ç”¨è€…åç¨±\nâ€¢ å®¶äººè§’è‰²è¨­å®š\nâ€¢ è‡ªè¨‚åœ–ç‰‡\nâ€¢ è‡ªè¨‚å­—è©\nâ€¢ èªéŸ³è¾¨è­˜é–€æª»è¨­å®š\n\næ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            // ç¬¬äºŒæ¬¡ç¢ºèª
            if (!confirm('âš ï¸ æœ€å¾Œç¢ºèªï¼\n\nçœŸçš„è¦é‚„åŸæ‰€æœ‰è¨­å®šå—ï¼Ÿ\n\nè«‹æŒ‰ã€Œç¢ºå®šã€ç¹¼çºŒï¼Œæˆ–ã€Œå–æ¶ˆã€ä¿ç•™è¨­å®šã€‚')) {
                showToast('å·²å–æ¶ˆé‚„åŸ', '');
                return;
            }

            // åŸ·è¡Œé‚„åŸ
            familySettings = JSON.parse(JSON.stringify(DEFAULT_FAMILY));
            uploadedImages = [];
            customWords = [];
            userName = '';

            localStorage.removeItem('familySettings');
            localStorage.removeItem('uploadedImages');
            localStorage.removeItem('customWords');
            localStorage.removeItem('userName');
            localStorage.removeItem('similarityThreshold');

            // æ›´æ–° UI
            document.getElementById('userName').value = '';
            document.getElementById('userNamePreview').style.display = 'none';
            document.getElementById('similarityThreshold').value = 0;
            document.getElementById('thresholdValue').textContent = '0%';
            updateThresholdPresets(0);

            renderFamilyGrid();
            renderUploadedImages();
            renderCustomWords();

            showToast('âœ… å·²é‚„åŸé è¨­å€¼', 'success');
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>
