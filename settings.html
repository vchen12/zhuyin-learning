<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="manifest.json">
    <title>âš™ï¸ è¨­å®š - æ³¨éŸ³å­¸ç¿’æ¨‚åœ’</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            padding: 20px;
        }

        .nav-bar {
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
        }
        .nav-title {
            font-size: 1.3rem;
            color: #667eea;
            font-weight: bold;
        }

        .container { max-width: 800px; margin: 0 auto; }

        .page-title {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .page-title h1 {
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* è¨­å®šå€å¡Š */
        .settings-section {
            background: white;
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .section-title {
            font-size: 1.4rem;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        /* è§’è‰²é¸æ“‡ */
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .character-item {
            background: #f5f5f5;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .character-item:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }
        .character-item.selected {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        .character-item.disabled {
            opacity: 0.5;
            border-color: #f44336;
            background: #ffebee;
        }
        .character-item .emoji {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 8px;
        }
        .character-item .name {
            font-size: 1rem;
            color: #333;
            margin-bottom: 5px;
        }
        .character-item .status {
            font-size: 0.8rem;
            color: #999;
        }

        /* ç·¨è¼¯æŒ‰éˆ• */
        .edit-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        .edit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .edit-btn.delete {
            background: #f44336;
        }
        .edit-btn.rename {
            background: #ff9800;
        }

        /* æ–°å¢è§’è‰²æŒ‰éˆ• */
        .add-character {
            background: #e0e0e0;
            border: 3px dashed #bbb;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .add-character:hover {
            background: #d0d0d0;
            border-color: #667eea;
        }
        .add-character .icon {
            font-size: 2.5rem;
            display: block;
            margin-bottom: 8px;
        }

        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .upload-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .upload-area {
            background: #f9f9f9;
            border: 3px dashed #ddd;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #f0f0ff;
        }
        .upload-area.dragover {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .upload-text {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 10px;
        }
        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        /* å·²ä¸Šå‚³åœ–ç‰‡é è¦½ */
        .uploaded-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .uploaded-image {
            position: relative;
            background: #f5f5f5;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        .uploaded-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .uploaded-image .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .uploaded-image .label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            font-size: 0.75rem;
            text-align: center;
        }

        /* é‡ç½®æŒ‰éˆ• */
        .reset-section {
            text-align: center;
            padding-top: 20px;
        }
        .reset-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 5px;
        }
        .save-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 5px;
        }

        /* éš±è—çš„æ–‡ä»¶è¼¸å…¥ */
        .hidden-input {
            display: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-title {
            font-size: 1.5rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
        }
        .modal-btn.confirm {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }
        .modal-btn.cancel {
            background: #e0e0e0;
            color: #666;
        }

        /* é€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1rem;
            z-index: 1001;
            display: none;
        }
        .toast.show { display: block; }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }

        @media (max-width: 600px) {
            .character-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .character-item .emoji { font-size: 2rem; }
            .character-item .name { font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="index.html" class="back-btn">â† è¿”å›é¦–é </a>
        <div class="nav-title">âš™ï¸ è¨­å®š</div>
        <div></div>
    </nav>

    <div class="container">
        <div class="page-title">
            <h1>âš™ï¸ å€‹äººåŒ–è¨­å®š</h1>
        </div>

        <!-- è§’è‰²é¸æ“‡ -->
        <div class="settings-section">
            <div class="section-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶äººè§’è‰²è¨­å®š</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                é»é¸è§’è‰²é€²è¡Œå•Ÿç”¨/åœç”¨ã€‚åœç”¨çš„è§’è‰²ä¸æœƒå‡ºç¾åœ¨éŠæˆ²ä¸­ã€‚<br>
                ä½ å¯ä»¥é‡æ–°å‘½åè§’è‰²ï¼Œä¾‹å¦‚å°‡ã€Œçˆ¸çˆ¸ã€æ”¹æˆå¯¦éš›ç¨±å‘¼ã€‚
            </p>
            <div class="character-grid" id="familyGrid"></div>
        </div>

        <!-- åœ–ç‰‡ä¸Šå‚³ -->
        <div class="settings-section">
            <div class="section-title">ğŸ“· è‡ªè¨‚åœ–ç‰‡</div>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                ä¸Šå‚³çœŸå¯¦ç…§ç‰‡ä¾†æ›¿æ›é è¨­çš„ emoji åœ–ç¤ºã€‚<br>
                ç³»çµ±æœƒè‡ªå‹•è£åˆ‡ä¸¦è™•ç†åœ–ç‰‡ã€‚
            </p>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('imageInput').click()">
                <div class="upload-icon">ğŸ“¤</div>
                <div class="upload-text">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡ä¸Šå‚³</div>
                <div class="upload-hint">æ”¯æ´ JPGã€PNG æ ¼å¼ï¼Œå»ºè­°æ­£æ–¹å½¢åœ–ç‰‡</div>
            </div>
            <input type="file" id="imageInput" class="hidden-input" accept="image/*" multiple>

            <div class="uploaded-images" id="uploadedImages"></div>

            <div class="upload-section">
                <p style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">åœ–ç‰‡å°æ‡‰è¨­å®šï¼šä¸Šå‚³å¾Œé¸æ“‡è¦æ›¿æ›çš„è§’è‰²</p>
            </div>
        </div>

        <!-- é‡ç½®èˆ‡å„²å­˜ -->
        <div class="settings-section">
            <div class="section-title">ğŸ”„ è³‡æ–™ç®¡ç†</div>
            <div class="reset-section">
                <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button class="reset-btn" onclick="resetProgress()">ğŸ—‘ï¸ é‡ç½®å­¸ç¿’é€²åº¦</button>
                <button class="reset-btn" onclick="resetAll()" style="background: #9e9e9e;">â†©ï¸ é‚„åŸé è¨­å€¼</button>
            </div>
        </div>
    </div>

    <!-- é‡å‘½å Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-title">âœï¸ é‡æ–°å‘½å</div>
            <input type="text" class="modal-input" id="renameInput" placeholder="è¼¸å…¥æ–°åç¨±">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn confirm" onclick="confirmRename()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- åœ–ç‰‡é¸æ“‡ Modal -->
    <div class="modal" id="assignModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ¯ é¸æ“‡è¦æ›¿æ›çš„è§’è‰²</div>
            <div class="character-grid" id="assignGrid" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn cancel" onclick="closeAssignModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div class="toast" id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        // é è¨­å®¶äººè³‡æ–™
        const DEFAULT_FAMILY = [
            { id: 'dad', emoji: 'ğŸ‘¨', name: 'çˆ¸çˆ¸', enabled: true, customImage: null },
            { id: 'mom', emoji: 'ğŸ‘©', name: 'åª½åª½', enabled: true, customImage: null },
            { id: 'grandpa', emoji: 'ğŸ‘´', name: 'çˆºçˆº', enabled: true, customImage: null },
            { id: 'grandma', emoji: 'ğŸ‘µ', name: 'å¥¶å¥¶', enabled: true, customImage: null },
            { id: 'grandpa2', emoji: 'ğŸ‘´', name: 'å¤–å…¬', enabled: true, customImage: null },
            { id: 'grandma2', emoji: 'ğŸ‘µ', name: 'å¤–å©†', enabled: true, customImage: null },
            { id: 'brother', emoji: 'ğŸ‘¦', name: 'å“¥å“¥', enabled: true, customImage: null },
            { id: 'sister', emoji: 'ğŸ‘§', name: 'å§å§', enabled: true, customImage: null },
            { id: 'young_brother', emoji: 'ğŸ‘¦', name: 'å¼Ÿå¼Ÿ', enabled: true, customImage: null },
            { id: 'young_sister', emoji: 'ğŸ‘§', name: 'å¦¹å¦¹', enabled: true, customImage: null },
            { id: 'uncle', emoji: 'ğŸ‘¨', name: 'å”å”', enabled: true, customImage: null },
            { id: 'aunt', emoji: 'ğŸ‘©', name: 'é˜¿å§¨', enabled: true, customImage: null }
        ];

        let familySettings = [];
        let uploadedImages = [];
        let currentEditingId = null;
        let currentAssigningImage = null;

        // åˆå§‹åŒ–
        function init() {
            loadSettings();
            renderFamilyGrid();
            renderUploadedImages();
            setupUploadEvents();
        }

        // è¼‰å…¥è¨­å®š
        function loadSettings() {
            const saved = localStorage.getItem('familySettings');
            if (saved) {
                familySettings = JSON.parse(saved);
            } else {
                familySettings = JSON.parse(JSON.stringify(DEFAULT_FAMILY));
            }

            const savedImages = localStorage.getItem('uploadedImages');
            if (savedImages) {
                uploadedImages = JSON.parse(savedImages);
            }
        }

        // æ¸²æŸ“å®¶äººç¶²æ ¼
        function renderFamilyGrid() {
            const grid = document.getElementById('familyGrid');
            grid.innerHTML = '';

            familySettings.forEach((member) => {
                const item = document.createElement('div');
                item.className = 'character-item' + (member.enabled ? ' selected' : ' disabled');
                item.innerHTML = `
                    <span class="emoji">${member.customImage ? '<img src="' + member.customImage + '" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">' : member.emoji}</span>
                    <span class="name">${member.name}</span>
                    <span class="status">${member.enabled ? 'âœ“ å·²å•Ÿç”¨' : 'âœ— å·²åœç”¨'}</span>
                    <div class="edit-controls">
                        <button class="edit-btn rename" onclick="event.stopPropagation(); openRenameModal('${member.id}')">æ”¹å</button>
                        <button class="edit-btn ${member.enabled ? 'delete' : ''}" onclick="event.stopPropagation(); toggleMember('${member.id}')">${member.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}</button>
                    </div>
                `;
                item.onclick = () => toggleMember(member.id);
                grid.appendChild(item);
            });
        }

        // åˆ‡æ›æˆå“¡å•Ÿç”¨ç‹€æ…‹
        function toggleMember(id) {
            const member = familySettings.find(m => m.id === id);
            if (member) {
                member.enabled = !member.enabled;
                renderFamilyGrid();
                showToast(member.enabled ? `å·²å•Ÿç”¨ã€Œ${member.name}ã€` : `å·²åœç”¨ã€Œ${member.name}ã€`);
            }
        }

        // æ‰“é–‹é‡å‘½å Modal
        function openRenameModal(id) {
            currentEditingId = id;
            const member = familySettings.find(m => m.id === id);
            document.getElementById('renameInput').value = member.name;
            document.getElementById('renameModal').classList.add('show');
        }

        // é—œé–‰ Modal
        function closeModal() {
            document.getElementById('renameModal').classList.remove('show');
            currentEditingId = null;
        }

        // ç¢ºèªé‡å‘½å
        function confirmRename() {
            const newName = document.getElementById('renameInput').value.trim();
            if (newName && currentEditingId) {
                const member = familySettings.find(m => m.id === currentEditingId);
                member.name = newName;
                renderFamilyGrid();
                showToast(`å·²æ”¹åç‚ºã€Œ${newName}ã€`);
            }
            closeModal();
        }

        // è¨­å®šä¸Šå‚³äº‹ä»¶
        function setupUploadEvents() {
            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');

            // æ‹–æ›³äº‹ä»¶
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // æ–‡ä»¶é¸æ“‡
            imageInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // è™•ç†ä¸Šå‚³çš„æ–‡ä»¶
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageData = e.target.result;
                    // æ‰“é–‹åˆ†é… Modal
                    currentAssigningImage = imageData;
                    openAssignModal();
                };
                reader.readAsDataURL(file);
            });
        }

        // æ‰“é–‹åˆ†é… Modal
        function openAssignModal() {
            const grid = document.getElementById('assignGrid');
            grid.innerHTML = '';

            familySettings.forEach((member) => {
                const item = document.createElement('div');
                item.className = 'character-item';
                item.innerHTML = `
                    <span class="emoji">${member.emoji}</span>
                    <span class="name">${member.name}</span>
                `;
                item.onclick = () => assignImageToMember(member.id);
                grid.appendChild(item);
            });

            document.getElementById('assignModal').classList.add('show');
        }

        // é—œé–‰åˆ†é… Modal
        function closeAssignModal() {
            document.getElementById('assignModal').classList.remove('show');
            currentAssigningImage = null;
        }

        // å°‡åœ–ç‰‡åˆ†é…çµ¦æˆå“¡
        function assignImageToMember(id) {
            const member = familySettings.find(m => m.id === id);
            if (member && currentAssigningImage) {
                member.customImage = currentAssigningImage;

                // å„²å­˜åˆ°å·²ä¸Šå‚³åœ–ç‰‡åˆ—è¡¨
                uploadedImages.push({
                    id: Date.now(),
                    image: currentAssigningImage,
                    assignedTo: id,
                    memberName: member.name
                });

                renderFamilyGrid();
                renderUploadedImages();
                showToast(`å·²è¨­å®šã€Œ${member.name}ã€çš„åœ–ç‰‡`, 'success');
            }
            closeAssignModal();
        }

        // æ¸²æŸ“å·²ä¸Šå‚³åœ–ç‰‡
        function renderUploadedImages() {
            const container = document.getElementById('uploadedImages');
            container.innerHTML = '';

            uploadedImages.forEach((img) => {
                const item = document.createElement('div');
                item.className = 'uploaded-image';
                item.innerHTML = `
                    <img src="${img.image}" alt="${img.memberName}">
                    <button class="delete-btn" onclick="removeUploadedImage(${img.id})">âœ•</button>
                    <div class="label">${img.memberName}</div>
                `;
                container.appendChild(item);
            });
        }

        // ç§»é™¤å·²ä¸Šå‚³åœ–ç‰‡
        function removeUploadedImage(id) {
            const img = uploadedImages.find(i => i.id === id);
            if (img) {
                // ç§»é™¤æˆå“¡çš„è‡ªè¨‚åœ–ç‰‡
                const member = familySettings.find(m => m.id === img.assignedTo);
                if (member) {
                    member.customImage = null;
                }
            }

            uploadedImages = uploadedImages.filter(i => i.id !== id);
            renderFamilyGrid();
            renderUploadedImages();
            showToast('å·²ç§»é™¤åœ–ç‰‡');
        }

        // å„²å­˜è¨­å®š
        function saveSettings() {
            localStorage.setItem('familySettings', JSON.stringify(familySettings));
            localStorage.setItem('uploadedImages', JSON.stringify(uploadedImages));
            showToast('è¨­å®šå·²å„²å­˜ï¼', 'success');
        }

        // é‡ç½®å­¸ç¿’é€²åº¦
        function resetProgress() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å­¸ç¿’é€²åº¦å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                localStorage.removeItem('masteredZhuyin');
                localStorage.removeItem('masteredWords_level2');
                showToast('å­¸ç¿’é€²åº¦å·²é‡ç½®', 'success');
            }
        }

        // é‚„åŸé è¨­å€¼
        function resetAll() {
            if (confirm('ç¢ºå®šè¦é‚„åŸæ‰€æœ‰è¨­å®šç‚ºé è¨­å€¼å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼')) {
                familySettings = JSON.parse(JSON.stringify(DEFAULT_FAMILY));
                uploadedImages = [];
                localStorage.removeItem('familySettings');
                localStorage.removeItem('uploadedImages');
                renderFamilyGrid();
                renderUploadedImages();
                showToast('å·²é‚„åŸé è¨­å€¼', 'success');
            }
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // å•Ÿå‹•
        init();
    </script>
</body>
</html>
