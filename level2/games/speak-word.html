<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#11998e">
    <link rel="manifest" href="../../manifest.json">
    <title>å”¸å”¸çœ‹</title>
    <script src="../../js/config.js"></script>
    <script src="../../js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }

        /* å°èˆªåˆ— */
        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
        }
        .back-btn:hover { transform: scale(1.05); }
        .back-btn:active { transform: scale(0.95); }
        .nav-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .progress-text {
            font-size: 0.95rem;
            color: #666;
            font-weight: bold;
        }
        .score-display {
            font-size: 1rem;
            color: #11998e;
            font-weight: bold;
        }

        /* éŠæˆ²å€åŸŸ */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            gap: 15px;
            overflow: hidden;
        }

        /* åœ–ç‰‡å€åŸŸ */
        .image-section {
            background: white;
            border-radius: 25px;
            padding: 25px 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-width: 90%;
        }
        .image-emoji {
            font-size: 6rem;
            margin-bottom: 10px;
            animation: bounce 2s ease-in-out infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .word-hint {
            font-size: 1.8rem;
            color: #e0e0e0;
            letter-spacing: 8px;
            font-weight: bold;
        }
        .word-hint.revealed {
            color: #11998e;
            letter-spacing: 3px;
        }
        .word-zhuyin {
            font-size: 1.3rem;
            color: #11998e;
            margin-top: 8px;
            letter-spacing: 2px;
        }

        /* éº¥å…‹é¢¨å€åŸŸ */
        .mic-section {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .mic-btn {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            font-size: 5rem;
            cursor: pointer;
            box-shadow: 0 12px 40px rgba(240, 147, 251, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
            touch-action: manipulation;
        }
        .mic-btn:hover {
            transform: scale(1.05);
        }
        .mic-btn:active {
            transform: scale(0.95);
        }
        .mic-btn.listening {
            animation: pulse 1s ease-in-out infinite;
            box-shadow: 0 0 0 0 rgba(240, 147, 251, 0.7);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(240, 147, 251, 0.7); }
            70% { box-shadow: 0 0 0 30px rgba(240, 147, 251, 0); }
            100% { box-shadow: 0 0 0 0 rgba(240, 147, 251, 0); }
        }
        .mic-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .mic-hint {
            color: white;
            font-size: 1.1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* è¼”åŠ©æŒ‰éˆ• */
        .helper-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .helper-btn {
            background: rgba(255,255,255,0.25);
            border: 3px solid rgba(255,255,255,0.5);
            padding: 18px 32px;
            border-radius: 30px;
            font-size: 1.3rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 65px;
            min-width: 140px;
            touch-action: manipulation;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .helper-btn:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.05);
        }
        .helper-btn:active {
            transform: scale(0.95);
        }

        /* çµæœè¨Šæ¯ */
        .result-section {
            text-align: center;
            min-height: 60px;
        }
        .recognized-text {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 1.1rem;
            color: white;
            display: none;
            margin-bottom: 5px;
        }
        .recognized-text.show { display: inline-block; }
        .result-message {
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* ç…™ç«æ•ˆæœ */
        .fireworks {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .firework {
            position: absolute;
            animation: firework-explode 1s ease-out forwards;
        }
        @keyframes firework-explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* å®Œæˆç•«é¢ */
        .complete-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .complete-overlay.show { display: flex; }
        .complete-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 90%;
            width: 350px;
        }
        .complete-icon { font-size: 4rem; margin-bottom: 15px; }
        .complete-title { font-size: 1.8rem; color: #11998e; margin-bottom: 10px; }
        .complete-score { font-size: 1.3rem; color: #666; margin-bottom: 20px; }
        .complete-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            border: none;
            padding: 18px 32px;
            border-radius: 25px;
            font-size: 1.3rem;
            color: white;
            cursor: pointer;
            margin: 5px;
            min-height: 65px;
            min-width: 140px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
        }
        .complete-btn:hover { transform: scale(1.05); }
        .complete-btn:active { transform: scale(0.95); }

        /* \u9583\u720d\u63d0\u793a\u52d5\u756b */
        .highlight-btn {
            animation: btn-glow 1.5s ease-in-out infinite;
        }
        @keyframes btn-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 0 25px 8px rgba(240, 147, 251, 0.7), 0 0 50px 15px rgba(245, 87, 108, 0.4); }
        }

        /* \u9ea5\u514b\u98a8\u6309\u9215\u7279\u5225\u9583\u720d */
        .mic-highlight {
            animation: mic-glow 1.5s ease-in-out infinite;
        }
        @keyframes mic-glow {
            0%, 100% { box-shadow: 0 12px 40px rgba(240, 147, 251, 0.5); }
            50% { box-shadow: 0 0 40px 15px rgba(240, 147, 251, 0.9), 0 0 80px 25px rgba(245, 87, 108, 0.6); }
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ - å°è¢å¹• */
        @media (max-height: 600px) {
            .image-section {
                padding: 15px 30px;
            }
            .image-emoji { font-size: 4rem; }
            .word-hint { font-size: 1.5rem; }
            .word-zhuyin { font-size: 1.1rem; }
            .mic-btn {
                width: 120px;
                height: 120px;
                font-size: 3.5rem;
            }
            .helper-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }
            .result-message { font-size: 1.3rem; }
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ - æ©«å‘æ¨¡å¼ */
        @media (orientation: landscape) and (max-height: 500px) {
            .game-area {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                gap: 15px;
                padding: 10px;
            }
            .image-section {
                padding: 15px 25px;
            }
            .image-emoji { font-size: 3.5rem; margin-bottom: 5px; }
            .word-hint { font-size: 1.3rem; letter-spacing: 5px; }
            .word-zhuyin { font-size: 1rem; margin-top: 5px; }
            .mic-section {
                gap: 8px;
            }
            .mic-btn {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }
            .mic-hint { font-size: 0.95rem; }
            .helper-buttons { gap: 8px; }
            .helper-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            .result-section { min-height: 40px; }
            .result-message { font-size: 1.1rem; }
        }

        @media (max-width: 400px) {
            .image-emoji { font-size: 5rem; }
            .word-hint { font-size: 1.5rem; }
            .helper-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="nav-info">
            <div class="progress-text">ç¬¬ <span id="currentRound">1</span>/<span id="totalRounds">10</span> é¡Œ</div>
            <div class="score-display">å¾—åˆ†ï¼š<span id="score">0</span></div>
        </div>
    </nav>

    <div class="game-area">
        <div class="image-section">
            <div class="image-emoji" id="imageEmoji">ğŸ•</div>
            <div class="word-hint" id="wordHint">ï¼¿ï¼¿</div>
            <div class="word-zhuyin" id="wordZhuyin">ã„ã„¡Ë‡</div>
        </div>

        <div class="mic-section">
            <button class="mic-btn mic-highlight" id="micBtn" onclick="startListening()">ğŸ¤</button>
            <button class="mic-btn" id="manualMicBtn" onclick="manualConfirm()" style="display: none; background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);">âœ…</button>
            <div class="mic-hint" id="micHint">é»æ“Šéº¥å…‹é¢¨ï¼Œèªªå‡ºé€™æ˜¯ä»€éº¼ï¼</div>
        </div>

        <div class="helper-buttons">
            <button class="helper-btn" onclick="playHint()">ğŸ”Š è½æç¤º</button>
            <button class="helper-btn" id="manualBtn" onclick="manualConfirm()" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);">âœ… æˆ‘æœƒå”¸</button>
            <button class="helper-btn" onclick="skipWord()">â­ï¸ è·³é</button>
        </div>

        <div class="result-section">
            <div class="recognized-text" id="recognizedText">ä½ èªªï¼š</div>
            <div class="result-message" id="resultMessage"></div>
        </div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <div class="complete-overlay" id="completeOverlay">
        <div class="complete-content">
            <div class="complete-icon">ğŸ‰</div>
            <div class="complete-title">å¤ªæ£’äº†ï¼</div>
            <div class="complete-score" id="completeScore">å¾—åˆ†ï¼š100 åˆ†</div>
            <button class="complete-btn highlight-btn" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="complete-btn" onclick="location.href='../index.html'" style="background: linear-gradient(135deg, #11998e, #38ef7d);">ğŸ  è¿”å›é¸å–®</button>
        </div>
    </div>

    <script src="../../js/vocabulary.js"></script>
    <script>
        const ENCOURAGEMENTS = ['å¤ªæ£’äº†ï¼', 'å¥½å²å®³ï¼', 'ç­”å°äº†ï¼', 'çœŸè°æ˜ï¼', 'å¾ˆæ£’å–”ï¼', 'ç™¼éŸ³å¥½æ¨™æº–ï¼'];

        // å–å¾—ä½¿ç”¨è€…åç¨±
        function getUserName() {
            return localStorage.getItem('userName') || '';
        }

        // å–å¾—å¸¶åå­—çš„é¼“å‹µèª
        function getEncouragement() {
            const name = getUserName();
            const base = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
            return name ? `${name}ï¼Œ${base}` : base;
        }

        let currentRound = 0;
        let totalRounds = 10;
        let score = 0;
        let currentWord = null;
        let questionQueue = [];
        let recognition = null;
        let isListening = false;

        function getAllWords() {
            let allWords = [];
            for (const [catKey, cat] of Object.entries(VOCABULARY)) {
                cat.words.forEach((word, index) => {
                    allWords.push({ ...word, category: catKey, index });
                });
            }
            return allWords;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame() {
            currentRound = 0;
            score = 0;
            const allWords = getAllWords();
            questionQueue = shuffle(allWords).slice(0, totalRounds);
            initSpeechRecognition();
            updateScore();
            nextRound();
        }

        let recognitionFailed = false;
        let isProcessing = false;
        let hasDetectedSound = false;
        let recognitionTimeout = null;
        let hasReceivedResult = false;
        let lastTranscript = '';

        // VADï¼ˆèªéŸ³æ´»å‹•åµæ¸¬ï¼‰ç›¸é—œè®Šæ•¸
        let audioContext = null;
        let analyser = null;
        let vadInterval = null;
        let hasDetectedVoice = false;
        const VAD_THRESHOLD = 35;
        const MIN_VOICE_DURATION = 200;
        let voiceStartTime = null;

        // åˆå§‹åŒ– VAD
        async function initVAD() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.5;
                microphone.connect(analyser);
                console.log('âœ… VAD åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('VAD åˆå§‹åŒ–å¤±æ•—:', error);
            }
        }

        // é–‹å§‹ VAD åµæ¸¬
        function startVAD() {
            if (!analyser) return;
            hasDetectedVoice = false;
            voiceStartTime = null;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            vadInterval = setInterval(() => {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                const average = sum / dataArray.length;

                if (average > VAD_THRESHOLD) {
                    if (!voiceStartTime) {
                        voiceStartTime = Date.now();
                    } else if (Date.now() - voiceStartTime > MIN_VOICE_DURATION && !hasDetectedVoice) {
                        hasDetectedVoice = true;
                        document.getElementById('micHint').textContent = 'ğŸ¤ è½åˆ°ä½ çš„è²éŸ³äº†ï¼';
                        if (navigator.vibrate) navigator.vibrate(30);
                    }
                } else {
                    voiceStartTime = null;
                }
            }, 50);
        }

        function stopVAD() {
            if (vadInterval) {
                clearInterval(vadInterval);
                vadInterval = null;
            }
        }

        // æ ¹æ“šæ–‡å­—é•·åº¦æ±ºå®šè†è½æ™‚é–“
        function getListenDuration(text) {
            const len = text.length;
            if (len === 1) return 8000;      // å–®å­—ï¼š8ç§’ï¼ˆè¦å”¸2-3æ¬¡ï¼‰
            if (len <= 3) return 6000;       // 2-3å­—ï¼š6ç§’
            if (len <= 6) return 8000;       // 4-6å­—ï¼š8ç§’
            return 10000;                     // æ›´é•·ï¼š10ç§’
        }

        // å¿«é€ŸçŸ­èªéŸ³æç¤º
        function speakShort(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                utterance.volume = 0.7;
                window.speechSynthesis.speak(utterance);
            }
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 5;

                recognition.onstart = () => {
                    isListening = true;
                    hasDetectedSound = false;
                    hasReceivedResult = false;
                    lastTranscript = '';
                    document.getElementById('micBtn').classList.add('listening');
                    document.getElementById('recognizedText').classList.remove('show');
                    if (navigator.vibrate) navigator.vibrate(100);

                    // æ ¹æ“šå­—è©é•·åº¦æ±ºå®šæç¤ºå’Œè†è½æ™‚é–“
                    const textLen = currentWord.text.length;
                    const listenTime = getListenDuration(currentWord.text);

                    if (textLen <= 1) {
                        document.getElementById('micHint').textContent = 'ğŸ™ï¸ è«‹å¤§è²å”¸ 2~3 æ¬¡ï¼';
                        speakShort('è«‹å”¸å…©åˆ°ä¸‰æ¬¡');
                    } else {
                        document.getElementById('micHint').textContent = 'ğŸ™ï¸ è«‹è·Ÿè‘—å”¸ï¼';
                        speakShort('è«‹è·Ÿè‘—å”¸');
                    }

                    recognitionTimeout = setTimeout(() => {
                        if (isListening && !hasReceivedResult) {
                            try { recognition.stop(); } catch(e) {}
                        }
                    }, listenTime);
                };

                recognition.onaudiostart = () => {
                    // ä¿ç•™ä½†ä¸æ”¹è®Šæç¤ºè¨Šæ¯
                };

                recognition.onspeechstart = () => {
                    hasDetectedSound = true;
                    if (navigator.vibrate) navigator.vibrate(50);
                };

                recognition.onspeechend = () => {
                    // ä¸è¦åœ¨é€™è£¡ stop
                };

                recognition.onresult = (event) => {
                    const lastResult = event.results[event.results.length - 1];
                    const transcript = lastResult[0].transcript.trim();

                    if (hasReceivedResult) return;

                    // éæ¿¾ç³»çµ±èªéŸ³
                    if (transcript.includes('è«‹å”¸') || transcript.includes('å…©åˆ°ä¸‰æ¬¡') || transcript.includes('è·Ÿè‘—å”¸')) return;

                    if (transcript) {
                        lastTranscript = transcript;
                        document.getElementById('recognizedText').textContent = 'ğŸ¤ è½åˆ°ï¼š' + transcript;
                        document.getElementById('recognizedText').classList.add('show');

                        // ç«‹å³è™•ç†
                        hasReceivedResult = true;
                        clearTimeout(recognitionTimeout);
                        stopVAD();
                        try { recognition.stop(); } catch(e) {}
                        isListening = false;
                        document.getElementById('micBtn').classList.remove('listening');
                        document.getElementById('micBtn').disabled = false;
                        checkResult(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    clearTimeout(recognitionTimeout);
                    stopVAD();
                    isListening = false;
                    document.getElementById('micBtn').classList.remove('listening');
                    document.getElementById('micBtn').disabled = false;
                    console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);

                    if (event.error === 'not-allowed' || event.error === 'service-not-allowed' || event.error === 'audio-capture') {
                        recognitionFailed = true;
                        document.getElementById('micBtn').style.display = 'none';
                        document.getElementById('manualMicBtn').style.display = 'inline-block';
                        document.getElementById('micHint').textContent = 'âŒ éº¥å…‹é¢¨ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é»ã€Œâœ…æˆ‘æœƒå”¸ã€æŒ‰éˆ•';
                        return;
                    }

                    // å¦‚æœ VAD æœ‰æª¢æ¸¬åˆ°è²éŸ³ä½†è¾¨è­˜å¤±æ•—ï¼Œä»ç„¶ç®—é€šéï¼ˆå°å¤±èªç—‡æ‚£è€…å‹å–„ï¼‰
                    if (hasDetectedVoice || hasDetectedSound) {
                        handleCorrect();
                        return;
                    }
                };

                recognition.onend = () => {
                    clearTimeout(recognitionTimeout);
                    stopVAD();
                    const wasListening = isListening;
                    isListening = false;
                    document.getElementById('micBtn').classList.remove('listening');
                    document.getElementById('micBtn').disabled = false;

                    if (!hasReceivedResult && lastTranscript && wasListening) {
                        hasReceivedResult = true;
                        document.getElementById('recognizedText').textContent = 'è½åˆ°ï¼š' + lastTranscript;
                        document.getElementById('recognizedText').classList.add('show');
                        checkResult(lastTranscript);
                    } else if (!isProcessing && !hasReceivedResult && wasListening) {
                        document.getElementById('micHint').textContent = 'æ²’è½æ¸…æ¥šï¼Œé»ğŸ¤å†è©¦ï¼Œæˆ–é»ã€Œâœ…æˆ‘æœƒå”¸ã€';
                    }
                };
            } else {
                document.getElementById('micBtn').style.display = 'none';
                document.getElementById('manualMicBtn').style.display = 'inline-block';
                document.getElementById('micHint').textContent = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹é»ã€Œâœ…æˆ‘æœƒå”¸ã€æŒ‰éˆ•';
            }

            // åˆå§‹åŒ– VAD
            initVAD();
        }

        function manualConfirm() {
            speak(currentWord.text, () => {
                if (confirm('ä½ æœƒå”¸ã€Œ' + currentWord.text + 'ã€å—ï¼Ÿ\n\né»ã€Œç¢ºå®šã€è¡¨ç¤ºæœƒå”¸')) {
                    handleCorrect();
                } else {
                    document.getElementById('resultMessage').textContent = 'æ²’é—œä¿‚ï¼Œå†è½ä¸€æ¬¡ï¼';
                    speak('æ²’é—œä¿‚ï¼Œå†è½ä¸€æ¬¡ï¼');
                }
            });
        }

        function nextRound() {
            if (currentRound >= totalRounds) {
                endGame();
                return;
            }

            currentWord = questionQueue[currentRound];
            currentRound++;

            updateUI();
            document.getElementById('wordHint').textContent = 'ï¼¿'.repeat(currentWord.text.length);
            document.getElementById('wordHint').classList.remove('revealed');
            document.getElementById('resultMessage').textContent = '';
            document.getElementById('recognizedText').classList.remove('show');
            document.getElementById('micHint').textContent = 'é»æ“Šéº¥å…‹é¢¨ï¼Œèªªå‡ºé€™æ˜¯ä»€éº¼ï¼';
        }

        function updateUI() {
            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('imageEmoji').textContent = currentWord.emoji;
            document.getElementById('wordZhuyin').textContent = currentWord.zhuyin;
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function startListening() {
            if (!recognition) {
                // æ²’æœ‰èªéŸ³è¾¨è­˜ï¼Œç”¨æ‰‹å‹•ç¢ºèª
                if (confirm(`ä½ èªªçš„æ˜¯ã€Œ${currentWord.text}ã€å—ï¼Ÿ`)) {
                    handleCorrect();
                }
                return;
            }

            if (isListening) return;

            // å•Ÿå‹• VAD
            startVAD();

            document.getElementById('micBtn').disabled = true;
            try {
                recognition.start();
            } catch (error) {
                document.getElementById('micBtn').disabled = false;
                stopVAD();
                console.error('å•Ÿå‹•è¾¨è­˜å¤±æ•—:', error);
            }
        }

        function checkResult(transcript) {
            if (isProcessing) return;
            isProcessing = true;

            const target = currentWord.text;
            const hasSound = transcript && transcript.trim().length > 0;

            // è¨ˆç®—ç›¸ä¼¼åº¦ï¼ˆä½¿ç”¨ config.js çš„å‡½æ•¸ï¼‰
            const similarity = hasSound ? calculateSimilarity(transcript, target) : 0;

            // è¨˜éŒ„ç™¼éŸ³ï¼ˆç”¨æ–¼è¿½è¹¤é€²åº¦ï¼‰
            if (hasSound) {
                recordPronunciation('word', target, transcript, similarity);
            }

            // æª¢æŸ¥æ˜¯å¦é€šéé–€æª»
            const passes = (hasSound || hasDetectedSound) && passesSimilarityThreshold(similarity);

            // é¡¯ç¤ºç›¸ä¼¼åº¦è³‡è¨Šï¼ˆå¦‚æœé–€æª»ä¸æ˜¯0ï¼‰
            if (getSimilarityThreshold() > 0 && hasSound) {
                const level = getSimilarityLevel(similarity);
                document.getElementById('resultMessage').textContent = `${level.emoji} ${similarity}% - ${level.label}`;
            }

            if (passes) {
                handleCorrect(similarity);
            } else {
                isProcessing = false;
                document.getElementById('resultMessage').textContent = 'å†è©¦ä¸€æ¬¡ï¼';
                // æ²’æœ‰é”åˆ°é–€æª»æ™‚ï¼Œé¡¯ç¤ºæç¤ºè®“ç”¨æˆ¶æ‰‹å‹•é‡è©¦ï¼Œä¸è‡ªå‹•å¾ªç’°
                document.getElementById('micHint').textContent = 'é»éº¥å…‹é¢¨å†è©¦ ğŸ¤ æˆ–é»ã€Œè·³éã€';
            }
        }

        function isSimilar(a, b) {
            // ç°¡å–®ç›¸ä¼¼åº¦æª¢æŸ¥
            const aChars = a.split('');
            const bChars = b.split('');
            let matches = 0;
            for (const char of aChars) {
                if (bChars.includes(char)) matches++;
            }
            return matches >= Math.min(a.length, b.length) * 0.5;
        }

        function handleCorrect(similarity = 100) {
            isProcessing = true;
            score += 10;
            updateScore();

            const encouragement = getEncouragement();
            document.getElementById('resultMessage').textContent = 'ğŸ‰ ' + encouragement + ' ğŸ‰';
            document.getElementById('wordHint').textContent = currentWord.text + ' (' + currentWord.zhuyin + ')';
            document.getElementById('wordHint').classList.add('revealed');
            document.getElementById('micHint').textContent = 'ğŸ‰ å¤ªæ£’äº†ï¼';

            // ç«‹å³éœ‡å‹•åé¥‹
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            // ç«‹å³æ’­æ”¾é¼“å‹µèª
            speak(encouragement);
            createFireworks(20);
            saveMastered(currentWord);

            // ç¸®çŸ­ç­‰å¾…æ™‚é–“
            setTimeout(() => {
                isProcessing = false;
                nextRound();
            }, 2000);
        }

        function playHint() {
            speak(currentWord.text);
        }

        function showAnswer() {
            document.getElementById('wordHint').textContent = currentWord.text + ' (' + currentWord.zhuyin + ')';
            document.getElementById('wordHint').classList.add('revealed');
            speak(currentWord.text);
        }

        function skipWord() {
            document.getElementById('resultMessage').textContent = 'è·³éï¼ç­”æ¡ˆæ˜¯ï¼š' + currentWord.text;
            speak(currentWord.text);
            setTimeout(nextRound, 1500);
        }

        function saveMastered(word) {
            let mastered = JSON.parse(localStorage.getItem('masteredWords_level2') || '{}');
            if (!mastered[word.category]) mastered[word.category] = {};
            mastered[word.category][word.index] = true;
            localStorage.setItem('masteredWords_level2', JSON.stringify(mastered));
        }

        function endGame() {
            document.getElementById('completeScore').textContent = `å¾—åˆ†ï¼š${score} åˆ†`;
            document.getElementById('completeOverlay').classList.add('show');
            createFireworks(50);
            speak(`å¤ªæ£’äº†ï¼ä½ å¾—äº†${score}åˆ†ï¼`);
        }

        function restartGame() {
            document.getElementById('completeOverlay').classList.remove('show');
            initGame();
        }

        function speak(text, callback) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.85;
                utterance.pitch = 1.1;
                if (callback) {
                    utterance.onend = callback;
                    setTimeout(() => { if (callback) callback(); }, 5000);
                }
                utterance.onerror = () => { if (callback) callback(); };
                window.speechSynthesis.speak(utterance);
            } else if (callback) {
                callback();
            }
        }

        function createFireworks(count) {
            const container = document.getElementById('fireworks');
            const emojis = ['âœ¨', 'ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'ğŸŒŸ'];

            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.fontSize = (2 + Math.random() * 2) + 'rem';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
            }
            setTimeout(() => { container.innerHTML = ''; }, 2000);
        }

        initGame();
    </script>
</body>
</html>
