<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#11998e">
    <link rel="manifest" href="../../manifest.json">
    <title>åœ–æ–‡é…å°</title>
    <script src="../../js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            touch-action: none;
        }

        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
        }
        .score-display {
            font-size: 1rem;
            color: #11998e;
            font-weight: bold;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 15px;
            gap: 10px;
            overflow: hidden;
            min-height: 0;
        }

        .round-info {
            flex-shrink: 0;
            text-align: center;
            color: white;
            font-size: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .match-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 20px;
            min-height: 0;
            overflow: hidden;
        }

        .zone-title {
            text-align: center;
            color: white;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: bold;
        }

        /* åœ–ç‰‡å€åŸŸ */
        .images-zone {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
            overflow: hidden;
        }
        .drag-item {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: grab;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            user-select: none;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70px;
            font-size: 1.4rem;
        }
        .drag-item:active { cursor: grabbing; }
        .drag-item.dragging {
            opacity: 0.6;
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .drag-item.matched {
            background: #4caf50;
            cursor: default;
            opacity: 0.7;
        }
        .drag-item .emoji {
            font-size: clamp(1.8rem, 8vmin, 2.5rem);
        }

        /* è©å½™å€åŸŸ */
        .words-zone {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
            overflow: hidden;
        }
        .drop-target {
            background: rgba(255,255,255,0.3);
            border: 3px dashed rgba(255,255,255,0.6);
            border-radius: 15px;
            padding: 8px;
            text-align: center;
            flex: 1;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 0;
        }
        .drop-target.over {
            background: rgba(255,255,255,0.5);
            border-color: #4caf50;
            transform: scale(1.02);
        }
        .drop-target.matched {
            background: #4caf50;
            border-style: solid;
            border-color: #4caf50;
        }
        .drop-target .word {
            font-size: clamp(1.2rem, 5vmin, 1.6rem);
            color: white;
            font-weight: bold;
        }
        .drop-target .zhuyin {
            font-size: clamp(0.7rem, 2.5vmin, 0.9rem);
            color: rgba(255,255,255,0.9);
            margin-top: 3px;
        }
        .drop-target .matched-emoji {
            font-size: clamp(1.5rem, 6vmin, 2rem);
            margin-top: 5px;
        }

        .result-message {
            flex-shrink: 0;
            text-align: center;
            font-size: 1.2rem;
            color: white;
            min-height: 30px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .fireworks {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .firework {
            position: absolute;
            animation: firework-explode 1s ease-out forwards;
        }
        @keyframes firework-explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .complete-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .complete-overlay.show { display: flex; }
        .complete-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 350px;
            margin: 20px;
        }
        .complete-icon { font-size: 4rem; margin-bottom: 15px; }
        .complete-title { font-size: 1.8rem; color: #11998e; margin-bottom: 12px; }
        .complete-score { font-size: 1.3rem; color: #666; margin-bottom: 20px; }
        .complete-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            border: none;
            padding: 18px 32px;
            border-radius: 25px;
            font-size: 1.3rem;
            color: white;
            cursor: pointer;
            margin: 5px;
            min-height: 65px;
            min-width: 140px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
        }
        .complete-btn:hover { transform: scale(1.05); }
        .complete-btn:active { transform: scale(0.95); }

        /* \u9583\u720d\u63d0\u793a\u52d5\u756b */
        .highlight-btn {
            animation: btn-glow 1.5s ease-in-out infinite;
        }
        @keyframes btn-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 0 25px 8px rgba(240, 147, 251, 0.7), 0 0 50px 15px rgba(245, 87, 108, 0.4); }
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 400px) {
            .drag-item .emoji { font-size: 1.8rem; }
            .drop-target .word { font-size: 1.1rem; }
        }

        /* æ©«å‘æ¨¡å¼ */
        @media (orientation: landscape) and (max-height: 500px) {
            .nav-bar { padding: 6px 12px; }
            .game-area {
                padding: 6px 10px;
                gap: 6px;
            }
            .round-info { font-size: 0.85rem; }
            .match-container {
                padding: 8px;
                gap: 10px;
            }
            .zone-title { font-size: 0.8rem; margin-bottom: 5px; }
            .images-zone, .words-zone { gap: 5px; }
            .drag-item { padding: 6px; border-radius: 10px; }
            .drag-item .emoji { font-size: 1.5rem; }
            .drop-target { padding: 5px; border-radius: 10px; }
            .drop-target .word { font-size: 1rem; }
            .drop-target .zhuyin { font-size: 0.65rem; }
            .drop-target .matched-emoji { font-size: 1.2rem; margin-top: 3px; }
            .result-message { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="score-display">å¾—åˆ†ï¼š<span id="score">0</span></div>
    </nav>

    <div class="game-area">
        <div class="round-info">ç¬¬ <span id="currentRound">1</span> / <span id="totalRounds">3</span> è¼ª - é…å°å®Œæˆï¼š<span id="matchedCount">0</span>/4</div>

        <div class="match-container">
            <div>
                <div class="zone-title">åœ–ç‰‡</div>
                <div class="images-zone" id="imagesZone"></div>
            </div>
            <div>
                <div class="zone-title">è©å½™</div>
                <div class="words-zone" id="wordsZone"></div>
            </div>
        </div>

        <div class="result-message" id="resultMessage">æ‹–æ›³åœ–ç‰‡åˆ°å°æ‡‰çš„è©å½™ä¸Šï¼</div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <div class="complete-overlay" id="completeOverlay">
        <div class="complete-content">
            <div class="complete-icon">ğŸ‰</div>
            <div class="complete-title">å¤ªæ£’äº†ï¼</div>
            <div class="complete-score" id="completeScore">å¾—åˆ†ï¼š100 åˆ†</div>
            <button class="complete-btn highlight-btn" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="complete-btn" onclick="location.href='../index.html'" style="background: linear-gradient(135deg, #11998e, #38ef7d);">ğŸ  è¿”å›é¸å–®</button>
        </div>
    </div>

    <script src="../../js/vocabulary.js"></script>
    <script>
        const ITEMS_PER_ROUND = 4;
        const TOTAL_ROUNDS = 3;

        let currentRound = 0;
        let score = 0;
        let matchedCount = 0;
        let roundWords = [];
        let draggedItem = null;

        function getAllWords() {
            let allWords = [];
            for (const [catKey, cat] of Object.entries(VOCABULARY)) {
                cat.words.forEach((word, index) => {
                    allWords.push({ ...word, category: catKey, index });
                });
            }
            return allWords;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame() {
            currentRound = 0;
            score = 0;
            nextRound();
        }

        function nextRound() {
            currentRound++;
            matchedCount = 0;

            if (currentRound > TOTAL_ROUNDS) {
                endGame();
                return;
            }

            const allWords = getAllWords();
            roundWords = shuffle(allWords).slice(0, ITEMS_PER_ROUND);

            updateUI();
            renderRound();
            document.getElementById('resultMessage').textContent = 'æ‹–æ›³åœ–ç‰‡åˆ°å°æ‡‰çš„è©å½™ä¸Šï¼';
        }

        function updateUI() {
            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('totalRounds').textContent = TOTAL_ROUNDS;
            document.getElementById('matchedCount').textContent = matchedCount;
            document.getElementById('score').textContent = score;
        }

        function renderRound() {
            const imagesZone = document.getElementById('imagesZone');
            const wordsZone = document.getElementById('wordsZone');

            imagesZone.innerHTML = '';
            wordsZone.innerHTML = '';

            // æ‰“äº‚åœ–ç‰‡é †åº
            const shuffledImages = shuffle([...roundWords]);

            // æ¸²æŸ“åœ–ç‰‡
            shuffledImages.forEach((word, index) => {
                const item = document.createElement('div');
                item.className = 'drag-item highlight-btn';
                item.dataset.text = word.text;
                item.innerHTML = `<span class="emoji">${word.emoji}</span>`;

                // æ‹–æ›³äº‹ä»¶
                item.draggable = true;
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);

                // è§¸æ§äº‹ä»¶
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);

                imagesZone.appendChild(item);
            });

            // æ¸²æŸ“è©å½™ç›®æ¨™
            roundWords.forEach((word, index) => {
                const target = document.createElement('div');
                target.className = 'drop-target';
                target.dataset.text = word.text;
                target.innerHTML = `<span class="word">${word.text}</span><span class="zhuyin">${word.zhuyin}</span>`;

                // æ‹–æ”¾äº‹ä»¶
                target.addEventListener('dragover', handleDragOver);
                target.addEventListener('dragleave', handleDragLeave);
                target.addEventListener('drop', handleDrop);

                wordsZone.appendChild(target);
            });
        }

        // æ‹–æ›³è™•ç†
        function handleDragStart(e) {
            draggedItem = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItem = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            if (!e.target.classList.contains('matched')) {
                e.target.classList.add('over');
            }
        }

        function handleDragLeave(e) {
            e.target.classList.remove('over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('over');

            if (e.target.classList.contains('matched') || !draggedItem) return;

            const draggedText = draggedItem.dataset.text;
            const targetText = e.target.dataset.text;

            if (draggedText === targetText) {
                // æ­£ç¢ºé…å°
                handleCorrectMatch(draggedItem, e.target, draggedText);
            } else {
                // éŒ¯èª¤é…å°
                handleWrongMatch();
            }
        }

        // è§¸æ§è™•ç†
        let touchStartX, touchStartY;
        let currentTouchItem = null;
        let touchClone = null;

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            currentTouchItem = e.target.closest('.drag-item');

            if (!currentTouchItem || currentTouchItem.classList.contains('matched')) return;

            touchStartX = touch.clientX;
            touchStartY = touch.clientY;

            currentTouchItem.classList.add('dragging');

            // å‰µå»ºè·Ÿéš¨æ‰‹æŒ‡çš„è¤‡è£½å…ƒç´ 
            touchClone = currentTouchItem.cloneNode(true);
            touchClone.style.position = 'fixed';
            touchClone.style.pointerEvents = 'none';
            touchClone.style.zIndex = '1000';
            touchClone.style.opacity = '0.8';
            touchClone.style.width = currentTouchItem.offsetWidth + 'px';
            document.body.appendChild(touchClone);

            updateTouchClonePosition(touch.clientX, touch.clientY);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!currentTouchItem || !touchClone) return;

            const touch = e.touches[0];
            updateTouchClonePosition(touch.clientX, touch.clientY);

            // æª¢æŸ¥æ˜¯å¦åœ¨ç›®æ¨™ä¸Šæ–¹
            const targets = document.querySelectorAll('.drop-target:not(.matched)');
            targets.forEach(target => {
                const rect = target.getBoundingClientRect();
                if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                    touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                    target.classList.add('over');
                } else {
                    target.classList.remove('over');
                }
            });
        }

        function handleTouchEnd(e) {
            if (!currentTouchItem) return;

            currentTouchItem.classList.remove('dragging');

            if (touchClone) {
                touchClone.remove();
                touchClone = null;
            }

            // æ‰¾åˆ°ç›®æ¨™
            const targets = document.querySelectorAll('.drop-target.over');
            if (targets.length > 0) {
                const target = targets[0];
                target.classList.remove('over');

                const draggedText = currentTouchItem.dataset.text;
                const targetText = target.dataset.text;

                if (draggedText === targetText) {
                    handleCorrectMatch(currentTouchItem, target, draggedText);
                } else {
                    handleWrongMatch();
                }
            }

            currentTouchItem = null;
        }

        function updateTouchClonePosition(x, y) {
            if (touchClone) {
                touchClone.style.left = (x - touchClone.offsetWidth / 2) + 'px';
                touchClone.style.top = (y - touchClone.offsetHeight / 2) + 'px';
            }
        }

        function handleCorrectMatch(dragItem, dropTarget, wordText) {
            dragItem.classList.add('matched');
            dragItem.draggable = false;
            dropTarget.classList.add('matched');

            // åœ¨ç›®æ¨™å€é¡¯ç¤º emoji
            const word = roundWords.find(w => w.text === wordText);
            dropTarget.innerHTML += `<span class="matched-emoji">${word.emoji}</span>`;

            matchedCount++;
            score += 10;
            updateUI();

            const encouragement = ['å¤ªæ£’äº†ï¼', 'å¥½å²å®³ï¼', 'çœŸè°æ˜ï¼'][Math.floor(Math.random() * 3)];
            document.getElementById('resultMessage').textContent = encouragement + ' ' + wordText;
            speak(encouragement);
            createFireworks(15);

            saveMastered(word);

            if (matchedCount >= ITEMS_PER_ROUND) {
                setTimeout(nextRound, 1500);
            }
        }

        function handleWrongMatch() {
            document.getElementById('resultMessage').textContent = 'å†è©¦ä¸€æ¬¡ï¼';
            speak('å†è©¦ä¸€æ¬¡ï¼');
        }

        function saveMastered(word) {
            let mastered = JSON.parse(localStorage.getItem('masteredWords_level2') || '{}');
            if (!mastered[word.category]) mastered[word.category] = {};
            mastered[word.category][word.index] = true;
            localStorage.setItem('masteredWords_level2', JSON.stringify(mastered));
        }

        function endGame() {
            document.getElementById('completeScore').textContent = `å¾—åˆ†ï¼š${score} åˆ†`;
            document.getElementById('completeOverlay').classList.add('show');
            createFireworks(50);
            speak(`å¤ªæ£’äº†ï¼ä½ å¾—äº†${score}åˆ†ï¼`);
        }

        function restartGame() {
            document.getElementById('completeOverlay').classList.remove('show');
            initGame();
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function createFireworks(count) {
            const container = document.getElementById('fireworks');
            const emojis = ['âœ¨', 'ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'ğŸŒŸ'];

            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.fontSize = (2 + Math.random() * 2) + 'rem';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
            }
            setTimeout(() => { container.innerHTML = ''; }, 2000);
        }

        initGame();
    </script>
</body>
</html>
