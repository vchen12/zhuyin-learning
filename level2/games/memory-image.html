<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#11998e">
    <link rel="manifest" href="../../manifest.json">
    <title>è¨˜æ†¶ç¿»ç‰Œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }

        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
        }
        .stats {
            display: flex;
            gap: 15px;
        }
        .stat {
            font-size: 0.9rem;
            color: #11998e;
            font-weight: bold;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 15px;
            gap: 10px;
            overflow: hidden;
            min-height: 0;
        }

        .game-info {
            flex-shrink: 0;
            text-align: center;
            color: white;
        }
        .game-info h2 {
            font-size: 1.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
        }
        .game-info .hint {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* å¡ç‰‡ç¶²æ ¼ */
        .cards-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            perspective: 1000px;
            min-height: 0;
        }

        .card {
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s;
            min-height: 0;
        }
        .card.flipped {
            transform: rotateY(180deg);
        }
        .card.matched {
            cursor: default;
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .card-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-back::before {
            content: '?';
            font-size: clamp(1.5rem, 6vmin, 2.5rem);
            color: white;
            font-weight: bold;
        }

        .card-front {
            background: white;
            transform: rotateY(180deg);
        }

        /* åœ–ç‰‡å¡ç‰‡ */
        .card-front.image-card .emoji {
            font-size: clamp(1.5rem, 6vmin, 2.2rem);
        }

        /* æ–‡å­—å¡ç‰‡ */
        .card-front.text-card .word {
            font-size: clamp(0.9rem, 3.5vmin, 1.3rem);
            color: #333;
            font-weight: bold;
        }
        .card-front.text-card .zhuyin {
            font-size: clamp(0.6rem, 2.5vmin, 0.8rem);
            color: #11998e;
            margin-top: 3px;
        }

        .card.matched .card-front {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 2px solid #4caf50;
        }

        .result-message {
            flex-shrink: 0;
            text-align: center;
            font-size: 1.1rem;
            color: white;
            min-height: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .fireworks {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .firework {
            position: absolute;
            animation: firework-explode 1s ease-out forwards;
        }
        @keyframes firework-explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .complete-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .complete-overlay.show { display: flex; }
        .complete-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 350px;
            margin: 20px;
        }
        .complete-icon { font-size: 4rem; margin-bottom: 15px; }
        .complete-title { font-size: 1.8rem; color: #11998e; margin-bottom: 12px; }
        .complete-stats { font-size: 1.1rem; color: #666; margin-bottom: 20px; line-height: 1.6; }
        .complete-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            color: white;
            cursor: pointer;
            margin: 5px;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 400px) {
            .cards-grid { gap: 6px; }
            .card-front.image-card .emoji { font-size: 1.5rem; }
            .card-front.text-card .word { font-size: 0.9rem; }
            .card-front.text-card .zhuyin { font-size: 0.6rem; }
        }

        /* æ©«å‘æ¨¡å¼ */
        @media (orientation: landscape) and (max-height: 500px) {
            .nav-bar { padding: 6px 12px; }
            .game-area {
                padding: 6px 10px;
                gap: 6px;
            }
            .game-info h2 { font-size: 1rem; margin-bottom: 3px; }
            .game-info .hint { font-size: 0.8rem; }
            .cards-grid {
                grid-template-columns: repeat(6, 1fr);
                grid-template-rows: repeat(2, 1fr);
                gap: 6px;
            }
            .card-face { border-radius: 8px; }
            .card-back::before { font-size: 1.3rem; }
            .card-front.image-card .emoji { font-size: 1.5rem; }
            .card-front.text-card .word { font-size: 0.85rem; }
            .card-front.text-card .zhuyin { font-size: 0.55rem; }
            .result-message { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="stats">
            <span class="stat">é…å°ï¼š<span id="matchedPairs">0</span>/6</span>
            <span class="stat">ç¿»ç‰Œï¼š<span id="attempts">0</span></span>
        </div>
    </nav>

    <div class="game-area">
        <div class="game-info">
            <h2>åœ–ç‰‡èˆ‡è©å½™é…å°</h2>
            <div class="hint">ç¿»é–‹å¡ç‰‡ï¼Œæ‰¾å‡ºç›¸åŒæ„æ€çš„åœ–ç‰‡å’Œæ–‡å­—ï¼</div>
        </div>

        <div class="cards-grid" id="cardsGrid"></div>

        <div class="result-message" id="resultMessage"></div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <div class="complete-overlay" id="completeOverlay">
        <div class="complete-content">
            <div class="complete-icon">ğŸ†</div>
            <div class="complete-title">æ­å–œå®Œæˆï¼</div>
            <div class="complete-stats" id="completeStats">
                ç¸½ç¿»ç‰Œæ¬¡æ•¸ï¼š0 æ¬¡<br>
                é…å°æˆåŠŸï¼š6 çµ„
            </div>
            <button class="complete-btn" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="complete-btn" onclick="location.href='../index.html'" style="background: linear-gradient(135deg, #11998e, #38ef7d);">ğŸ  è¿”å›é¸å–®</button>
        </div>
    </div>

    <script src="../../js/vocabulary.js"></script>
    <script>
        const PAIRS = 6; // 6çµ„é…å° = 12å¼µå¡ç‰‡

        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let attempts = 0;
        let isLocked = false;

        function getAllWords() {
            let allWords = [];
            for (const [catKey, cat] of Object.entries(VOCABULARY)) {
                cat.words.forEach((word, index) => {
                    allWords.push({ ...word, category: catKey, index });
                });
            }
            return allWords;
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initGame() {
            matchedPairs = 0;
            attempts = 0;
            flippedCards = [];
            isLocked = false;

            const allWords = getAllWords();
            const selectedWords = shuffle(allWords).slice(0, PAIRS);

            // å‰µå»ºå¡ç‰‡å°ï¼ˆåœ–ç‰‡å¡ + æ–‡å­—å¡ï¼‰
            cards = [];
            selectedWords.forEach((word, index) => {
                // åœ–ç‰‡å¡
                cards.push({
                    id: index * 2,
                    type: 'image',
                    word: word,
                    matchId: index
                });
                // æ–‡å­—å¡
                cards.push({
                    id: index * 2 + 1,
                    type: 'text',
                    word: word,
                    matchId: index
                });
            });

            cards = shuffle(cards);
            updateUI();
            renderCards();
            document.getElementById('resultMessage').textContent = '';
        }

        function updateUI() {
            document.getElementById('matchedPairs').textContent = matchedPairs;
            document.getElementById('attempts').textContent = attempts;
        }

        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';

            cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.dataset.index = index;

                let frontContent;
                if (card.type === 'image') {
                    frontContent = `<div class="card-face card-front image-card"><span class="emoji">${card.word.emoji}</span></div>`;
                } else {
                    frontContent = `<div class="card-face card-front text-card"><span class="word">${card.word.text}</span><span class="zhuyin">${card.word.zhuyin}</span></div>`;
                }

                cardEl.innerHTML = `
                    <div class="card-face card-back"></div>
                    ${frontContent}
                `;

                cardEl.addEventListener('click', () => flipCard(index));
                grid.appendChild(cardEl);
            });
        }

        function flipCard(index) {
            if (isLocked) return;

            const cardEl = document.querySelectorAll('.card')[index];
            const card = cards[index];

            // å·²ç¶“ç¿»é–‹æˆ–å·²é…å°
            if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return;

            // ç¿»é–‹
            cardEl.classList.add('flipped');
            flippedCards.push({ index, card, element: cardEl });

            // æ’­æ”¾ç™¼éŸ³
            speak(card.word.text);

            // æª¢æŸ¥é…å°
            if (flippedCards.length === 2) {
                attempts++;
                updateUI();
                checkMatch();
            }
        }

        function checkMatch() {
            isLocked = true;
            const [first, second] = flippedCards;

            if (first.card.matchId === second.card.matchId && first.card.type !== second.card.type) {
                // é…å°æˆåŠŸ
                setTimeout(() => {
                    first.element.classList.add('matched');
                    second.element.classList.add('matched');
                    matchedPairs++;
                    updateUI();

                    const encouragement = ['å¤ªæ£’äº†ï¼', 'å¥½å²å®³ï¼', 'çœŸè°æ˜ï¼'][Math.floor(Math.random() * 3)];
                    document.getElementById('resultMessage').textContent = encouragement;
                    speak(encouragement);
                    createFireworks(15);

                    saveMastered(first.card.word);

                    flippedCards = [];
                    isLocked = false;

                    if (matchedPairs >= PAIRS) {
                        setTimeout(endGame, 800);
                    }
                }, 500);
            } else {
                // é…å°å¤±æ•—
                document.getElementById('resultMessage').textContent = 'å†è©¦ä¸€æ¬¡ï¼';

                setTimeout(() => {
                    first.element.classList.remove('flipped');
                    second.element.classList.remove('flipped');
                    flippedCards = [];
                    isLocked = false;
                }, 1200);
            }
        }

        function saveMastered(word) {
            let mastered = JSON.parse(localStorage.getItem('masteredWords_level2') || '{}');
            if (!mastered[word.category]) mastered[word.category] = {};
            mastered[word.category][word.index] = true;
            localStorage.setItem('masteredWords_level2', JSON.stringify(mastered));
        }

        function endGame() {
            document.getElementById('completeStats').innerHTML = `
                ç¸½ç¿»ç‰Œæ¬¡æ•¸ï¼š${attempts} æ¬¡<br>
                é…å°æˆåŠŸï¼š${PAIRS} çµ„<br>
                ${attempts <= PAIRS * 2 ? 'ğŸŒŸ è¨˜æ†¶åŠ›è¶…å¼·ï¼' : attempts <= PAIRS * 3 ? 'ğŸ‘ å¾ˆæ£’å–”ï¼' : 'ğŸ’ª ç¹¼çºŒåŠ æ²¹ï¼'}
            `;
            document.getElementById('completeOverlay').classList.add('show');
            createFireworks(50);
            speak('æ­å–œå®Œæˆï¼');
        }

        function restartGame() {
            document.getElementById('completeOverlay').classList.remove('show');
            initGame();
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function createFireworks(count) {
            const container = document.getElementById('fireworks');
            const emojis = ['âœ¨', 'ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'ğŸŒŸ'];

            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.fontSize = (2 + Math.random() * 2) + 'rem';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
            }
            setTimeout(() => { container.innerHTML = ''; }, 2000);
        }

        initGame();
    </script>
</body>
</html>
