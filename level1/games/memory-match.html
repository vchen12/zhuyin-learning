<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="../../manifest.json">
    <title>ğŸƒ é…å°ç¿»ç‰Œ</title>
    <script src="../../js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            height: 100vh;
            height: 100dvh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨å°èˆªåˆ— */
        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
        }
        .game-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .stat-item {
            text-align: center;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #999;
        }
        .stat-value {
            font-size: 1rem;
            color: #667eea;
            font-weight: bold;
        }

        /* ä¸»éŠæˆ²å€ */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            gap: 15px;
            overflow: hidden;
        }

        .game-title {
            text-align: center;
            color: white;
        }
        .game-title h1 {
            font-size: 1.3rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .game-title p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 3px;
        }

        /* å¡ç‰‡ç¶²æ ¼ - 4x3 ä½ˆå±€ */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 400px;
        }

        /* å¡ç‰‡ */
        .card {
            aspect-ratio: 1;
            perspective: 1000px;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.5s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .card-front {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 1.8rem;
        }
        .card-back {
            background: white;
            transform: rotateY(180deg);
            font-size: 2.2rem;
            color: #667eea;
            font-weight: bold;
        }
        .card.matched .card-back {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        .card.matched {
            pointer-events: none;
        }

        /* çµæœè¨Šæ¯ */
        .message {
            text-align: center;
            color: white;
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            min-height: 35px;
        }

        /* ç…™ç« */
        .fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .firework {
            position: absolute;
            animation: firework-explode 1s ease-out forwards;
        }
        @keyframes firework-explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* å®Œæˆç•«é¢ */
        .complete-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .complete-overlay.show {
            display: flex;
        }
        .complete-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 350px;
            margin: 20px;
        }
        .complete-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        .complete-title {
            font-size: 1.8rem;
            color: #667eea;
            margin-bottom: 10px;
        }
        .complete-stats {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
        }
        .complete-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            color: white;
            cursor: pointer;
            margin: 5px;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-height: 550px) {
            .game-title h1 { font-size: 1.1rem; }
            .cards-grid { gap: 6px; max-width: 320px; }
            .card-back { font-size: 1.8rem; }
            .card-front { font-size: 1.5rem; }
        }

        @media (max-width: 350px) {
            .cards-grid { max-width: 280px; gap: 5px; }
            .card-back { font-size: 1.5rem; }
        }

        /* æ©«å‘æ¨¡å¼ */
        @media (orientation: landscape) and (max-height: 450px) {
            .game-area { padding: 10px; gap: 8px; }
            .game-title { display: none; }
            .cards-grid { max-width: 350px; gap: 5px; }
            .card-back { font-size: 1.5rem; }
            .card-front { font-size: 1.2rem; }
            .message { font-size: 1rem; min-height: 25px; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="game-stats">
            <div class="stat-item">
                <div class="stat-label">ç¿»ç‰Œ</div>
                <div class="stat-value" id="moves">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">é…å°</div>
                <div class="stat-value"><span id="matches">0</span>/6</div>
            </div>
        </div>
    </nav>

    <div class="game-area">
        <div class="game-title">
            <h1>ğŸƒ é…å°ç¿»ç‰Œ</h1>
            <p>æ‰¾å‡ºç›¸åŒçš„æ³¨éŸ³ç¬¦è™Ÿé…å°</p>
        </div>

        <div class="cards-grid" id="cardsGrid"></div>

        <div class="message" id="message"></div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <div class="complete-overlay" id="completeOverlay">
        <div class="complete-content">
            <div class="complete-icon">ğŸ†</div>
            <div class="complete-title">å…¨éƒ¨é…å°æˆåŠŸï¼</div>
            <div class="complete-stats" id="completeStats">ç¿»ç‰Œæ¬¡æ•¸ï¼š0</div>
            <button class="complete-btn" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="complete-btn" onclick="location.href='../index.html'" style="background: linear-gradient(135deg, #667eea, #764ba2);">ğŸ  è¿”å›é¸å–®</button>
        </div>
    </div>

    <script>
        // æ³¨éŸ³ç¬¦è™Ÿ
        const ALL_SYMBOLS = [
            'ã„…', 'ã„†', 'ã„‡', 'ã„ˆ', 'ã„‰', 'ã„Š', 'ã„‹', 'ã„Œ', 'ã„', 'ã„', 'ã„',
            'ã„', 'ã„‘', 'ã„’', 'ã„“', 'ã„”', 'ã„•', 'ã„–', 'ã„—', 'ã„˜', 'ã„™',
            'ã„š', 'ã„›', 'ã„œ', 'ã„', 'ã„', 'ã„Ÿ', 'ã„ ', 'ã„¡', 'ã„¢', 'ã„£', 'ã„¤', 'ã„¥', 'ã„¦', 'ã„§', 'ã„¨', 'ã„©'
        ];

        const SOUND_MAP = {
            'ã„…': 'F1', 'ã„†': 'F2', 'ã„‡': 'F3', 'ã„ˆ': 'F4', 'ã„‰': 'F5', 'ã„Š': 'F6', 'ã„‹': 'F7', 'ã„Œ': 'F8',
            'ã„': 'F9', 'ã„': 'F10', 'ã„': 'F11', 'ã„': 'F12', 'ã„‘': 'F13', 'ã„’': 'F14', 'ã„“': 'F15', 'ã„”': 'F16',
            'ã„•': 'F17', 'ã„–': 'F18', 'ã„—': 'F19', 'ã„˜': 'F20', 'ã„™': 'F21',
            'ã„š': 'F22', 'ã„›': 'F23', 'ã„œ': 'F24', 'ã„': 'F25', 'ã„': 'F26', 'ã„Ÿ': 'F27', 'ã„ ': 'F28', 'ã„¡': 'F29',
            'ã„¢': 'F30', 'ã„£': 'F31', 'ã„¤': 'F32', 'ã„¥': 'F33', 'ã„¦': 'F34', 'ã„§': 'F35', 'ã„¨': 'F36', 'ã„©': 'F37'
        };

        const ENCOURAGEMENTS = ['å¤ªæ£’äº†ï¼', 'å¥½å²å®³ï¼', 'é…å°æˆåŠŸï¼', 'çœŸè°æ˜ï¼', 'è¨˜æ†¶åŠ›çœŸå¥½ï¼'];
        const PAIR_COUNT = 6;

        // éŠæˆ²ç‹€æ…‹
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let isProcessing = false;

        // æ´—ç‰Œ
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            matchedPairs = 0;
            moves = 0;
            flippedCards = [];
            isProcessing = false;

            // é¸å–éš¨æ©Ÿç¬¦è™Ÿä¸¦è¤‡è£½ä¸€ä»½
            const selectedSymbols = shuffle([...ALL_SYMBOLS]).slice(0, PAIR_COUNT);
            cards = shuffle([...selectedSymbols, ...selectedSymbols]);

            renderCards();
            updateStats();
            document.getElementById('message').textContent = '';
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';

            cards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = index;
                card.dataset.symbol = symbol;
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">â“</div>
                        <div class="card-back">${symbol}</div>
                    </div>
                `;
                card.onclick = () => flipCard(card);
                grid.appendChild(card);
            });
        }

        // ç¿»ç‰Œ
        function flipCard(card) {
            if (isProcessing) return;
            if (card.classList.contains('flipped')) return;
            if (card.classList.contains('matched')) return;
            if (flippedCards.length >= 2) return;

            card.classList.add('flipped');
            flippedCards.push(card);

            // æ’­æ”¾éŸ³æª”
            playSound(card.dataset.symbol);

            if (flippedCards.length === 2) {
                moves++;
                updateStats();
                checkMatch();
            }
        }

        // æ’­æ”¾éŸ³æª”
        function playSound(symbol) {
            const fileNum = SOUND_MAP[symbol];
            if (fileNum) {
                const audio = new Audio(`../../sounds/${fileNum}.mp3`);
                audio.play().catch(err => console.error('æ’­æ”¾å¤±æ•—:', err));
            }
        }

        // æª¢æŸ¥é…å°
        function checkMatch() {
            isProcessing = true;
            const [card1, card2] = flippedCards;

            if (card1.dataset.symbol === card2.dataset.symbol) {
                // é…å°æˆåŠŸ
                setTimeout(() => {
                    card1.classList.add('matched');
                    card2.classList.add('matched');
                    matchedPairs++;
                    updateStats();

                    const encouragement = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
                    showMessage(encouragement);
                    speak(encouragement);
                    createFireworks(15);

                    // å„²å­˜é€²åº¦
                    saveMastered(card1.dataset.symbol);

                    flippedCards = [];
                    isProcessing = false;

                    // æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                    if (matchedPairs === PAIR_COUNT) {
                        setTimeout(endGame, 1000);
                    }
                }, 500);
            } else {
                // é…å°å¤±æ•—
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    showMessage('å†è©¦è©¦çœ‹ï¼');
                    flippedCards = [];
                    isProcessing = false;
                }, 1000);
            }
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            document.getElementById('moves').textContent = moves;
            document.getElementById('matches').textContent = matchedPairs;
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text) {
            document.getElementById('message').textContent = text;
        }

        // å„²å­˜å·²æŒæ¡
        function saveMastered(symbol) {
            let mastered = JSON.parse(localStorage.getItem('masteredZhuyin') || '[]');
            if (!mastered.includes(symbol)) {
                mastered.push(symbol);
                localStorage.setItem('masteredZhuyin', JSON.stringify(mastered));
            }
        }

        // çµæŸéŠæˆ²
        function endGame() {
            document.getElementById('completeStats').textContent = `ç¿»ç‰Œæ¬¡æ•¸ï¼š${moves} æ¬¡`;
            document.getElementById('completeOverlay').classList.add('show');
            createFireworks(50);
            speak(`å¤ªæ£’äº†ï¼ä½ ç”¨${moves}æ¬¡å°±å®Œæˆäº†ï¼`);
        }

        // é‡æ–°é–‹å§‹
        function restartGame() {
            document.getElementById('completeOverlay').classList.remove('show');
            initGame();
        }

        // èªéŸ³åˆæˆ
        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                window.speechSynthesis.speak(utterance);
            }
        }

        // ç…™ç«æ•ˆæœ
        function createFireworks(count) {
            const container = document.getElementById('fireworks');
            const emojis = ['âœ¨', 'ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'ğŸŒŸ'];

            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.fontSize = (2 + Math.random() * 2) + 'rem';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
            }

            setTimeout(() => { container.innerHTML = ''; }, 2000);
        }

        // èªéŸ³å¼•å°
        let hasPlayedGuide = false;
        function playGuide() {
            if (hasPlayedGuide) return;
            hasPlayedGuide = true;
            speak('é…å°ç¿»ç‰Œï¼é»æ“Šå¡ç‰‡ç¿»é–‹ï¼Œæ‰¾å‡ºå…©å¼µç›¸åŒçš„æ³¨éŸ³ç¬¦è™Ÿé…å°æˆåŠŸï¼');
        }

        // å•Ÿå‹•éŠæˆ²
        initGame();

        // é¦–æ¬¡é»æ“Šæ™‚æ’­æ”¾å¼•å°
        document.addEventListener('touchstart', playGuide, { once: true });
        document.addEventListener('click', playGuide, { once: true });
    </script>
</body>
</html>
