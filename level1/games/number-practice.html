<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="../../manifest.json">
    <title>æ•¸å­—ç·´ç¿’ (0-9)</title>
    <script src="../../js/config.js"></script>
    <script src="../../js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }

        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .back-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        .back-btn:active {
            transform: scale(0.95);
        }
        .score-display {
            font-size: 1rem;
            color: #667eea;
            font-weight: bold;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 12px;
            gap: 10px;
            overflow: hidden;
        }

        .mode-section {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .mode-btn {
            background: rgba(255,255,255,0.2);
            border: 3px solid rgba(255,255,255,0.5);
            padding: 14px 24px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        .mode-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .progress-section {
            width: 100%;
            max-width: 400px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px;
        }
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s;
        }
        .progress-text {
            color: white;
            text-align: center;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        /* æ•¸å­—é¡¯ç¤ºå€ */
        .number-display {
            background: white;
            border-radius: 20px;
            padding: 20px 40px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        .number {
            font-size: 5rem;
            color: #667eea;
            font-weight: bold;
            line-height: 1;
        }
        .number-zhuyin {
            font-size: 1.3rem;
            color: #764ba2;
            margin-top: 5px;
        }

        /* é¸é …å€ */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 280px;
        }
        .option-btn {
            background: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .option-btn:hover {
            transform: scale(1.05);
        }
        .option-btn.correct {
            background: #4caf50;
            color: white;
        }
        .option-btn.wrong {
            background: #f44336;
            color: white;
        }

        /* å‹•ä½œæŒ‰éˆ• - åŠ å¤§å°ºå¯¸æ–¹ä¾¿å…’ç«¥æ“ä½œ */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            padding: 15px;
        }
        .action-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            padding: 20px 36px;
            border-radius: 30px;
            font-size: 1.4rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            font-weight: bold;
            min-width: 150px;
            min-height: 70px;
            transition: transform 0.2s, box-shadow 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .action-btn:active {
            transform: scale(0.95);
        }

        /* éº¥å…‹é¢¨æŒ‰éˆ•é–ƒçˆæç¤º */
        .action-btn.mic-highlight {
            animation: mic-glow 1.5s ease-in-out infinite;
        }
        @keyframes mic-glow {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            }
            50% {
                box-shadow: 0 0 30px 10px rgba(240, 147, 251, 0.8), 0 0 60px 20px rgba(245, 87, 108, 0.5);
            }
        }

        .result-message {
            text-align: center;
            font-size: 1.2rem;
            color: white;
            min-height: 30px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* æ•¸å­—ç¶²æ ¼ï¼ˆå­¸ç¿’æ¨¡å¼ï¼‰ */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 450px;
        }
        .number-card {
            background: rgba(255,255,255,0.25);
            padding: 15px 10px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .number-card:hover {
            background: rgba(255,255,255,0.45);
            transform: scale(1.08);
        }
        .number-card.mastered {
            background: rgba(76, 175, 80, 0.6);
            border: 3px solid #4caf50;
        }
        .number-card .num {
            font-size: 1.8rem;
            color: white;
            font-weight: bold;
        }
        .number-card .zhuyin {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
        }

        .fireworks {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .firework {
            position: absolute;
            animation: firework-explode 1s ease-out forwards;
        }
        @keyframes firework-explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* å®Œæˆç•«é¢ */
        .complete-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .complete-overlay.show { display: flex; }
        .complete-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            max-width: 320px;
            margin: 15px;
        }
        .complete-icon { font-size: 3.5rem; margin-bottom: 15px; }
        .complete-title { font-size: 1.6rem; color: #667eea; margin-bottom: 10px; }
        .complete-score { font-size: 1.2rem; color: #666; margin-bottom: 20px; }
        .complete-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            color: white;
            cursor: pointer;
            margin: 5px;
        }

        @media (max-width: 400px) {
            .number { font-size: 4rem; }
            .number-zhuyin { font-size: 1.1rem; }
            .number-display { padding: 15px 30px; }
            .option-btn { font-size: 1.3rem; padding: 12px; }
            .mode-btn { padding: 6px 12px; font-size: 0.8rem; }
            .action-btn { padding: 8px 16px; font-size: 0.9rem; }
        }

        @media (max-height: 600px) {
            .game-area { gap: 6px; padding: 8px; }
            .number { font-size: 3.5rem; }
            .number-display { padding: 12px 25px; }
            .number-zhuyin { font-size: 1rem; }
            .number-grid { gap: 5px; }
            .number-card { padding: 5px 3px; }
            .number-card .num { font-size: 1.2rem; }
            .number-card .zhuyin { font-size: 0.6rem; }
            .progress-section { padding: 6px; }
            .result-message { font-size: 1rem; min-height: 24px; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="score-display">å¾—åˆ†ï¼š<span id="score">0</span></div>
    </nav>

    <div class="game-area">
        <div class="mode-section">
            <button class="mode-btn active" onclick="setMode('learn')">ğŸ“– å­¸ç¿’</button>
            <button class="mode-btn" onclick="setMode('listen')">ğŸ‘‚ è½éŸ³é¸æ•¸</button>
            <button class="mode-btn" onclick="setMode('speak')">ğŸ¤ çœ‹æ•¸å”¸å‡º</button>
        </div>

        <div class="progress-section" id="progressSection" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text">ç¬¬ <span id="currentRound">1</span> / <span id="totalRounds">10</span> é¡Œ</div>
        </div>

        <div class="number-display">
            <div class="number" id="numberDisplay">0</div>
            <div class="number-zhuyin" id="zhuyinDisplay">ã„Œã„§ã„¥ËŠ</div>
        </div>

        <div class="options-grid" id="optionsGrid" style="display: none;"></div>

        <div class="action-buttons" id="actionButtons">
            <button class="action-btn" onclick="playSound()">ğŸ”Š è½ç™¼éŸ³</button>
            <button class="action-btn" onclick="nextNumber()">âš¡ æ›ä¸€å€‹</button>
            <button class="action-btn mic-highlight" id="speakBtn" onclick="startSpeaking()" style="display: none;">ğŸ¤ æˆ‘ä¾†å”¸</button>
            <button class="action-btn" id="manualSpeakBtn" onclick="manualSpeakConfirm()" style="display: none; background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);">âœ… æˆ‘æœƒå”¸</button>
        </div>

        <div class="result-message" id="resultMessage"></div>

        <div class="number-grid" id="numberGrid"></div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <div class="complete-overlay" id="completeOverlay">
        <div class="complete-content">
            <div class="complete-icon">ğŸ‰</div>
            <div class="complete-title">å¤ªæ£’äº†ï¼</div>
            <div class="complete-score" id="completeScore">å¾—åˆ†ï¼š100 åˆ†</div>
            <button class="complete-btn" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="complete-btn" onclick="location.href='../index.html'" style="background: linear-gradient(135deg, #667eea, #764ba2);">ğŸ  è¿”å›é¸å–®</button>
        </div>
    </div>

    <script>
        // æ•¸å­—è³‡æ–™ (0-9)
        const NUMBERS = [
            { num: 0, zhuyin: 'ã„Œã„§ã„¥ËŠ', text: 'é›¶' },
            { num: 1, zhuyin: 'ã„§', text: 'ä¸€' },
            { num: 2, zhuyin: 'ã„¦Ë‹', text: 'äºŒ' },
            { num: 3, zhuyin: 'ã„™ã„¢', text: 'ä¸‰' },
            { num: 4, zhuyin: 'ã„™Ë‹', text: 'å››' },
            { num: 5, zhuyin: 'ã„¨Ë‡', text: 'äº”' },
            { num: 6, zhuyin: 'ã„Œã„§ã„¡Ë‹', text: 'å…­' },
            { num: 7, zhuyin: 'ã„‘ã„§', text: 'ä¸ƒ' },
            { num: 8, zhuyin: 'ã„…ã„š', text: 'å…«' },
            { num: 9, zhuyin: 'ã„ã„§ã„¡Ë‡', text: 'ä¹' }
        ];

        const ENCOURAGEMENTS = ['å¤ªæ£’äº†ï¼', 'å¥½å²å®³ï¼', 'ç­”å°äº†ï¼', 'çœŸè°æ˜ï¼', 'å¾ˆæ£’å–”ï¼', 'å¤ªå²å®³äº†ï¼'];

        let currentMode = 'learn';
        let currentNumber = null;
        let currentRound = 0;
        let totalRounds = 10;
        let score = 0;
        let questionQueue = [];
        let recognition = null;
        let isListening = false;
        let masteredNumbers = new Set(JSON.parse(localStorage.getItem('masteredNumbers_0_9') || '[]'));

        // èªéŸ³åˆæˆ
        let voicesLoaded = false;
        function loadVoices() {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voicesLoaded = true;
                }
            }
        }

        // åˆå§‹åŒ–èªéŸ³å¼•æ“
        if ('speechSynthesis' in window) {
            loadVoices();
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function speak(text, callback) {
            if ('speechSynthesis' in window) {
                // ç¢ºä¿èªéŸ³å¼•æ“æ²’æœ‰å¡ä½
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.85;
                utterance.pitch = 1.1;

                // å˜—è©¦é¸æ“‡ä¸­æ–‡èªéŸ³
                const voices = window.speechSynthesis.getVoices();
                const zhVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('TW'));
                if (zhVoice) {
                    utterance.voice = zhVoice;
                }

                if (callback) {
                    utterance.onend = callback;
                    // å‚™ç”¨ï¼šå¦‚æœ onend æ²’æœ‰è§¸ç™¼ï¼Œ5ç§’å¾Œå¼·åˆ¶åŸ·è¡Œ callback
                    setTimeout(() => {
                        if (callback) callback();
                    }, 5000);
                }

                // é˜²æ­¢æŸäº›ç€è¦½å™¨çš„èªéŸ³åˆæˆå¡ä½
                utterance.onerror = (e) => {
                    console.error('èªéŸ³åˆæˆéŒ¯èª¤:', e);
                    if (callback) callback();
                };

                window.speechSynthesis.speak(utterance);
            } else if (callback) {
                callback();
            }
        }

        // æ’­æ”¾æ•¸å­—ç™¼éŸ³
        function playSound() {
            speak(currentNumber.text);
        }

        // è¨­å®šæ¨¡å¼
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // é‡è¨­UI
            document.getElementById('optionsGrid').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('numberGrid').style.display = mode === 'learn' ? 'grid' : 'none';
            document.getElementById('speakBtn').style.display = 'none';
            document.getElementById('resultMessage').textContent = '';

            if (mode === 'learn') {
                document.getElementById('actionButtons').style.display = 'flex';
                renderNumberGrid();
                nextNumber();
                speak('å­¸ç¿’æ¨¡å¼ï¼é»æ“Šæ•¸å­—è½ç™¼éŸ³ï¼Œè·Ÿè‘—å”¸ä¸€éï¼');
            } else if (mode === 'listen') {
                startListenMode();
            } else if (mode === 'speak') {
                startSpeakMode();
            }
        }

        // å­¸ç¿’æ¨¡å¼
        function renderNumberGrid() {
            const grid = document.getElementById('numberGrid');
            grid.innerHTML = '';

            NUMBERS.forEach(num => {
                const card = document.createElement('div');
                card.className = 'number-card';
                if (masteredNumbers.has(num.num)) {
                    card.classList.add('mastered');
                }
                card.innerHTML = `<div class="num">${num.num}</div><div class="zhuyin">${num.zhuyin}</div>`;
                card.onclick = () => {
                    currentNumber = num;
                    displayNumber();
                    playSound();
                };
                grid.appendChild(card);
            });
        }

        function nextNumber() {
            currentNumber = NUMBERS[Math.floor(Math.random() * NUMBERS.length)];
            displayNumber();
            setTimeout(playSound, 300);
        }

        function displayNumber() {
            document.getElementById('numberDisplay').textContent = currentNumber.num;
            document.getElementById('zhuyinDisplay').textContent = currentNumber.zhuyin;
        }

        // è½éŸ³é¸æ•¸æ¨¡å¼
        function startListenMode() {
            currentRound = 0;
            score = 0;
            questionQueue = shuffle([...NUMBERS, ...NUMBERS]).slice(0, totalRounds);

            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('optionsGrid').style.display = 'grid';
            document.getElementById('actionButtons').style.display = 'none';

            updateScore();
            speak('è½éŸ³é¸æ•¸æ¨¡å¼ï¼è½ç™¼éŸ³å¾Œï¼Œé¸å‡ºæ­£ç¢ºçš„æ•¸å­—ï¼', () => {
                nextListenQuestion();
            });
        }

        function nextListenQuestion() {
            if (currentRound >= totalRounds) {
                endGame();
                return;
            }

            currentNumber = questionQueue[currentRound];
            currentRound++;

            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('progressFill').style.width = ((currentRound - 1) / totalRounds * 100) + '%';
            document.getElementById('numberDisplay').textContent = '?';
            document.getElementById('zhuyinDisplay').textContent = 'è½ç™¼éŸ³é¸æ“‡';
            document.getElementById('resultMessage').textContent = '';

            // ç”Ÿæˆé¸é …
            generateOptions();

            // æ’­æ”¾ç™¼éŸ³
            setTimeout(() => {
                speak(currentNumber.text);
            }, 500);
        }

        function generateOptions() {
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';

            let options = [currentNumber];
            while (options.length < 4) {
                const rand = NUMBERS[Math.floor(Math.random() * NUMBERS.length)];
                if (!options.find(o => o.num === rand.num)) {
                    options.push(rand);
                }
            }
            options = shuffle(options);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt.num;
                btn.onclick = () => checkAnswer(btn, opt);
                grid.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected) {
            const isCorrect = selected.num === currentNumber.num;

            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);

            if (isCorrect) {
                btn.classList.add('correct');
                score += 10;
                updateScore();
                saveMastered(currentNumber.num);

                const encouragement = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
                document.getElementById('resultMessage').textContent = 'âœ¨ ' + encouragement + ' âœ¨';
                document.getElementById('numberDisplay').textContent = currentNumber.num;
                document.getElementById('zhuyinDisplay').textContent = currentNumber.zhuyin;

                // åŠ å¼·æ­£ç¢ºå›é¥‹ï¼šéœ‡å‹•ï¼ˆå¦‚æœæ”¯æ´ï¼‰+ è¦–è¦ºæ•ˆæœ + èªéŸ³
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                btn.style.transform = 'scale(1.2)';
                setTimeout(() => { btn.style.transform = 'scale(1)'; }, 300);

                setTimeout(() => speak(encouragement), 500);
                createFireworks(20);

                setTimeout(nextListenQuestion, 2500);
            } else {
                btn.classList.add('wrong');
                document.getElementById('resultMessage').textContent = 'å†è©¦ä¸€æ¬¡ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ' + currentNumber.num;
                speak('å†è©¦ä¸€æ¬¡ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯' + currentNumber.text);

                setTimeout(() => {
                    document.querySelectorAll('.option-btn').forEach(b => {
                        b.disabled = false;
                        b.classList.remove('wrong');
                    });
                }, 1500);
            }
        }

        // çœ‹æ•¸å”¸å‡ºæ¨¡å¼
        function startSpeakMode() {
            currentRound = 0;
            score = 0;
            questionQueue = shuffle([...NUMBERS, ...NUMBERS]).slice(0, totalRounds);

            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('optionsGrid').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'flex';
            document.getElementById('speakBtn').style.display = 'inline-block';
            document.getElementById('manualSpeakBtn').style.display = 'inline-block'; // ç¸½æ˜¯é¡¯ç¤ºã€Œæˆ‘æœƒå”¸ã€æŒ‰éˆ•

            initSpeechRecognition();
            updateScore();
            speak('çœ‹æ•¸å”¸å‡ºæ¨¡å¼ï¼çœ‹åˆ°æ•¸å­—å¾Œï¼Œå¤§è²å”¸å‡ºä¾†ï¼', () => {
                nextSpeakQuestion();
            });
        }

        function nextSpeakQuestion() {
            if (currentRound >= totalRounds) {
                endGame();
                return;
            }

            currentNumber = questionQueue[currentRound];
            currentRound++;

            document.getElementById('currentRound').textContent = currentRound;
            document.getElementById('progressFill').style.width = ((currentRound - 1) / totalRounds * 100) + '%';
            displayNumber();
            document.getElementById('resultMessage').textContent = 'çœ‹åˆ°é€™å€‹æ•¸å­—äº†å—ï¼Ÿé»æ“Šéº¥å…‹é¢¨å”¸å‡ºä¾†ï¼';
        }

        let recognitionFailed = false;

        let recognitionTimeout = null;
        let hasReceivedResult = false;
        let lastTranscript = ''; // å„²å­˜æœ€å¾Œæ”¶åˆ°çš„æ–‡å­—ï¼ˆå³ä½¿ä¸æ˜¯ finalï¼‰

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-TW';
                recognition.continuous = false; // æ”¹å› falseï¼Œè®“ç€è¦½å™¨è‡ªå‹•ç®¡ç†
                recognition.interimResults = true; // é–‹å•Ÿå³æ™‚çµæœå›é¥‹
                recognition.maxAlternatives = 5;

                recognition.onstart = () => {
                    isListening = true;
                    hasReceivedResult = false;
                    lastTranscript = '';
                    document.getElementById('speakBtn').textContent = 'ğŸ™ï¸ æ­£åœ¨è½...';
                    document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                    document.getElementById('resultMessage').textContent = 'ğŸ™ï¸ è«‹å¤§è²èªªå‡ºæ•¸å­—ï¼';
                    if (navigator.vibrate) {
                        navigator.vibrate(100);
                    }

                    // è¨­å®š 10 ç§’è¶…æ™‚
                    recognitionTimeout = setTimeout(() => {
                        if (isListening) {
                            try { recognition.stop(); } catch(e) {}
                        }
                    }, 10000);
                };

                recognition.onaudiostart = () => {
                    document.getElementById('resultMessage').textContent = 'ğŸ™ï¸ è½åˆ°è²éŸ³äº†ï¼è«‹ç¹¼çºŒèªª...';
                };

                recognition.onspeechstart = () => {
                    document.getElementById('resultMessage').textContent = 'ğŸ™ï¸ è½åˆ°ä½ åœ¨èªªè©±ï¼';
                };

                recognition.onspeechend = () => {
                    document.getElementById('resultMessage').textContent = 'ğŸ™ï¸ æ­£åœ¨è¾¨è­˜...';
                    // ä¸è¦åœ¨é€™è£¡ stopï¼Œè®“ç€è¦½å™¨è‡ªå·±æ±ºå®šä½•æ™‚çµæŸ
                };

                recognition.onresult = (event) => {
                    // å–å¾—æœ€æ–°çš„è¾¨è­˜çµæœ
                    const lastResult = event.results[event.results.length - 1];
                    const transcript = lastResult[0].transcript.trim();
                    const isFinal = lastResult.isFinal;

                    // å„²å­˜æ”¶åˆ°çš„æ–‡å­—
                    if (transcript) {
                        lastTranscript = transcript;
                    }

                    // é¡¯ç¤ºå³æ™‚è¾¨è­˜çµæœ
                    document.getElementById('resultMessage').textContent = 'è½åˆ°ï¼š' + transcript + (isFinal ? '' : '...');

                    if (isFinal && !hasReceivedResult) {
                        hasReceivedResult = true;
                        clearTimeout(recognitionTimeout);
                        isListening = false;
                        try { recognition.stop(); } catch(e) {}
                        document.getElementById('speakBtn').textContent = 'ğŸ¤ æˆ‘ä¾†å”¸';
                        document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                        checkSpeakResult(transcript);
                    }
                };

                recognition.onerror = (event) => {
                    clearTimeout(recognitionTimeout);
                    console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);

                    if (event.error === 'not-allowed' || event.error === 'service-not-allowed' || event.error === 'audio-capture') {
                        recognitionFailed = true;
                        isListening = false;
                        document.getElementById('speakBtn').textContent = 'ğŸ¤ æˆ‘ä¾†å”¸';
                        document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                        document.getElementById('resultMessage').textContent = 'âŒ éº¥å…‹é¢¨ç„¡æ³•ä½¿ç”¨ï¼Œè«‹é»ã€Œâœ…æˆ‘æœƒå”¸ã€æŒ‰éˆ•';
                        document.getElementById('speakBtn').style.display = 'none';
                        document.getElementById('manualSpeakBtn').style.display = 'inline-block';
                        return;
                    }

                    // no-speech æˆ– aborted éŒ¯èª¤æœƒç¹¼çºŒåˆ° onend è™•ç†
                };

                recognition.onend = () => {
                    clearTimeout(recognitionTimeout);
                    const wasListening = isListening;
                    isListening = false;
                    document.getElementById('speakBtn').textContent = 'ğŸ¤ æˆ‘ä¾†å”¸';
                    document.getElementById('speakBtn').style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';

                    // å¦‚æœæœ‰æ”¶åˆ°ä»»ä½•æ–‡å­—ä½†é‚„æ²’è™•ç†ï¼Œç¾åœ¨è™•ç†å®ƒ
                    if (!hasReceivedResult && lastTranscript && wasListening) {
                        hasReceivedResult = true;
                        document.getElementById('resultMessage').textContent = 'è½åˆ°ï¼š' + lastTranscript;
                        checkSpeakResult(lastTranscript);
                    } else if (!hasReceivedResult && wasListening) {
                        // å®Œå…¨æ²’è½åˆ°ä»»ä½•æ±è¥¿
                        document.getElementById('resultMessage').textContent = 'æ²’è½æ¸…æ¥šï¼Œé»ğŸ¤å†è©¦ï¼Œæˆ–é»ã€Œâœ…æˆ‘æœƒå”¸ã€';
                    }
                };
            }
        }

        function manualSpeakConfirm() {
            speak(currentNumber.text, () => {
                if (confirm('ä½ æœƒå”¸ã€Œ' + currentNumber.text + 'ã€å—ï¼Ÿ\n\né»ã€Œç¢ºå®šã€è¡¨ç¤ºæœƒå”¸')) {
                    handleSpeakCorrect();
                } else {
                    document.getElementById('resultMessage').textContent = 'æ²’é—œä¿‚ï¼Œå†è½ä¸€æ¬¡ï¼';
                    speak('æ²’é—œä¿‚ï¼Œå†è½ä¸€æ¬¡ï¼');
                }
            });
        }

        function startSpeaking() {
            if (!recognition) {
                if (confirm(`ä½ èªªçš„æ˜¯ã€Œ${currentNumber.text}ã€å—ï¼Ÿ`)) {
                    handleSpeakCorrect();
                }
                return;
            }

            if (isListening) return;

            try {
                recognition.start();
            } catch (error) {
                console.error('å•Ÿå‹•è¾¨è­˜å¤±æ•—:', error);
            }
        }

        function checkSpeakResult(transcript) {
            const hasSound = transcript && transcript.trim().length > 0;

            // è¨ˆç®—ç›¸ä¼¼åº¦ï¼ˆä½¿ç”¨ config.js çš„å‡½æ•¸ï¼‰
            const similarity = hasSound ? calculateSimilarity(transcript, currentNumber.text) : 0;

            // è¨˜éŒ„ç™¼éŸ³ï¼ˆç”¨æ–¼è¿½è¹¤é€²åº¦ï¼‰
            if (hasSound) {
                recordPronunciation('number', currentNumber.text, transcript, similarity);
            }

            // æª¢æŸ¥æ˜¯å¦é€šéé–€æª»
            const passes = hasSound && passesSimilarityThreshold(similarity);

            // é¡¯ç¤ºç›¸ä¼¼åº¦è³‡è¨Šï¼ˆå¦‚æœé–€æª»ä¸æ˜¯0ï¼‰
            if (getSimilarityThreshold() > 0 && hasSound) {
                const level = getSimilarityLevel(similarity);
                document.getElementById('resultMessage').textContent = `${level.emoji} ${similarity}% - ${level.label}`;
            }

            if (passes) {
                handleSpeakCorrect(similarity);
            } else if (hasSound) {
                // æœ‰è²éŸ³ä½†æœªé”é–€æª»ï¼Œé¡¯ç¤ºæç¤ºï¼ˆä¸è‡ªå‹•é‡è©¦ï¼‰
                document.getElementById('resultMessage').textContent = `è½åˆ°äº†ï¼é»ğŸ¤å†è©¦ä¸€æ¬¡ï¼Œæˆ–é»ã€Œâœ…æˆ‘æœƒå”¸ã€`;
            } else {
                // æ²’è½åˆ°è²éŸ³ï¼Œé¡¯ç¤ºæç¤ºï¼ˆä¸è‡ªå‹•é‡è©¦ï¼‰
                document.getElementById('resultMessage').textContent = 'æ²’è½æ¸…æ¥šï¼Œé»ğŸ¤å†è©¦ï¼Œæˆ–é»ã€Œâœ…æˆ‘æœƒå”¸ã€';
            }
        }

        function handleSpeakCorrect(similarity = 100) {
            score += 10;
            updateScore();
            saveMastered(currentNumber.num);

            // éœ‡å‹•å›é¥‹
            if (navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }

            const encouragement = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
            document.getElementById('resultMessage').textContent = 'ğŸ‰ ' + encouragement + ' ğŸ‰';

            // ç«‹å³æ’­æ”¾é¼“å‹µèªï¼Œä¸è¦å»¶é²
            speak(encouragement);
            createFireworks(20);

            // ç¸®çŸ­ç­‰å¾…æ™‚é–“
            setTimeout(nextSpeakQuestion, 2000);
        }

        // å·¥å…·å‡½æ•¸
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function saveMastered(num) {
            masteredNumbers.add(num);
            localStorage.setItem('masteredNumbers_0_9', JSON.stringify([...masteredNumbers]));
            renderNumberGrid();
        }

        function endGame() {
            document.getElementById('completeScore').textContent = `å¾—åˆ†ï¼š${score} åˆ†`;
            document.getElementById('completeOverlay').classList.add('show');
            createFireworks(50);
            speak(`å¤ªæ£’äº†ï¼ä½ å¾—äº†${score}åˆ†ï¼`);
        }

        function restartGame() {
            document.getElementById('completeOverlay').classList.remove('show');
            setMode(currentMode);
        }

        function createFireworks(count) {
            const container = document.getElementById('fireworks');
            const emojis = ['âœ¨', 'ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'ğŸŒŸ'];

            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.fontSize = (2 + Math.random() * 2) + 'rem';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
            }
            setTimeout(() => { container.innerHTML = ''; }, 2000);
        }

        // åˆå§‹åŒ–
        function init() {
            renderNumberGrid();
            currentNumber = NUMBERS[0];
            displayNumber();
            setTimeout(() => {
                speak('æ­¡è¿ä¾†åˆ°æ•¸å­—ç·´ç¿’ï¼é€™è£¡ç·´ç¿’æ•¸å­—é›¶åˆ°ä¹çš„ç™¼éŸ³ã€‚', () => {
                    setTimeout(() => speak('é»æ“Šä¸‹æ–¹çš„æ•¸å­—ï¼Œè½ç™¼éŸ³è·Ÿè‘—å”¸ï¼'), 1000);
                });
            }, 500);
        }

        init();
    </script>
</body>
</html>
