<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="../../manifest.json">
    <title>è²èª¿ç·´ç¿’</title>
    <script src="../../js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }

        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
        }
        .mode-display {
            font-size: 0.9rem;
            color: #667eea;
            font-weight: bold;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            gap: 12px;
            overflow: hidden;
        }

        /* æ¨¡å¼é¸æ“‡ */
        .mode-selector {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 400px;
        }
        .mode-selector h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .mode-btn {
            background: #f5f5f5;
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mode-btn:hover {
            background: #e8e3ff;
            border-color: #667eea;
        }
        .mode-btn .icon { font-size: 2rem; margin-bottom: 8px; }
        .mode-btn .name { font-size: 1rem; color: #333; font-weight: bold; }
        .mode-btn .desc { font-size: 0.75rem; color: #666; margin-top: 4px; }

        /* è²èª¿å­¸ç¿’å€ */
        .tone-learn-section {
            display: none;
            width: 100%;
            max-width: 500px;
        }
        .tone-learn-section.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .tone-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            width: 100%;
        }
        .tone-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .tone-symbol {
            font-size: 3.5rem;
            color: #667eea;
            font-weight: bold;
        }
        .tone-mark {
            font-size: 3rem;
            color: #f5576c;
        }
        .tone-name {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 6px;
        }
        .tone-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }
        .tone-example {
            margin-top: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .tone-example-title {
            font-size: 0.8rem;
            color: #667eea;
            margin-bottom: 6px;
        }
        .tone-example-word {
            font-size: 1.5rem;
            color: #333;
        }
        .tone-example-zhuyin {
            font-size: 1rem;
            color: #667eea;
            margin-top: 4px;
        }

        /* æŒ‰éˆ•å€ */
        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .action-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            font-weight: bold;
        }
        .action-btn:active { transform: scale(0.95); }
        .action-btn.speak { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .action-btn.next { background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); }

        /* è²èª¿åˆ—è¡¨ */
        .tone-list {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
        }
        .tone-item {
            background: white;
            border-radius: 12px;
            padding: 10px 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .tone-item:hover { transform: scale(1.05); }
        .tone-item.current {
            border: 3px solid #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }
        .tone-item .mark { font-size: 1.5rem; }
        .tone-item .label { font-size: 0.7rem; color: #666; margin-top: 3px; }

        /* è²èª¿æ¸¬é©—å€ */
        .tone-quiz-section {
            display: none;
            width: 100%;
            max-width: 500px;
        }
        .tone-quiz-section.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .progress-section {
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 10px;
            width: 100%;
        }
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s;
        }
        .progress-text {
            color: white;
            text-align: center;
            margin-top: 6px;
            font-size: 0.85rem;
        }

        .quiz-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            width: 100%;
        }
        .quiz-word {
            font-size: 3.5rem;
            color: #333;
            margin-bottom: 5px;
        }
        .quiz-zhuyin {
            font-size: 1.5rem;
            color: #667eea;
        }
        .quiz-hint {
            font-size: 1rem;
            color: #666;
            margin-top: 10px;
        }

        .quiz-choices {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
        }
        .quiz-choice {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 12px 5px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        .quiz-choice:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .quiz-choice .mark { font-size: 1.8rem; display: block; }
        .quiz-choice .name { font-size: 0.75rem; color: #333; margin-top: 3px; }
        .quiz-choice.correct {
            background: #4caf50;
            border-color: #4caf50;
        }
        .quiz-choice.correct .mark, .quiz-choice.correct .name { color: white; }
        .quiz-choice.wrong {
            background: #f44336;
            border-color: #f44336;
        }
        .quiz-choice.wrong .mark, .quiz-choice.wrong .name { color: white; }
        .quiz-choice:disabled { cursor: not-allowed; }

        .result-message {
            text-align: center;
            font-size: 1.3rem;
            color: white;
            min-height: 30px;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .fireworks {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .firework {
            position: absolute;
            animation: firework-explode 1s ease-out forwards;
        }
        @keyframes firework-explode {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .complete-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .complete-overlay.show { display: flex; }
        .complete-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            max-width: 350px;
            margin: 15px;
        }
        .complete-icon { font-size: 4rem; margin-bottom: 15px; }
        .complete-title { font-size: 1.5rem; color: #667eea; margin-bottom: 10px; }
        .complete-score { font-size: 1.2rem; color: #666; margin-bottom: 20px; }
        .complete-btn {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            color: white;
            cursor: pointer;
            margin: 5px;
        }

        @media (max-width: 480px) {
            .game-area { padding: 10px; gap: 8px; }
            .mode-selector { padding: 15px; }
            .mode-selector h2 { font-size: 1.1rem; margin-bottom: 10px; }
            .mode-btn { padding: 12px; }
            .mode-btn .icon { font-size: 1.6rem; margin-bottom: 5px; }
            .mode-btn .name { font-size: 0.9rem; }
            .tone-card, .quiz-card { padding: 15px; }
            .tone-symbol { font-size: 2.8rem; }
            .tone-mark { font-size: 2.3rem; }
            .tone-name { font-size: 1rem; }
            .tone-desc { font-size: 0.8rem; }
            .tone-example { padding: 8px; margin-top: 8px; }
            .tone-example-word { font-size: 1.3rem; }
            .tone-example-zhuyin { font-size: 0.9rem; }
            .action-btn { padding: 10px 18px; font-size: 0.9rem; }
            .tone-item { padding: 8px 3px; }
            .tone-item .mark { font-size: 1.2rem; }
            .tone-item .label { font-size: 0.6rem; }
            .quiz-word { font-size: 2.8rem; }
            .quiz-zhuyin { font-size: 1.2rem; }
            .quiz-hint { font-size: 0.9rem; margin-top: 8px; }
            .quiz-choice { padding: 10px 3px; }
            .quiz-choice .mark { font-size: 1.4rem; }
            .quiz-choice .name { font-size: 0.65rem; }
            .result-message { font-size: 1.1rem; }
        }

        @media (max-height: 600px) {
            .nav-bar { padding: 8px 12px; }
            .game-area { padding: 8px; gap: 6px; }
            .tone-card, .quiz-card { padding: 12px; border-radius: 15px; }
            .tone-display { gap: 10px; margin-bottom: 6px; }
            .tone-symbol { font-size: 2.5rem; }
            .tone-mark { font-size: 2rem; }
            .tone-name { font-size: 0.95rem; margin-bottom: 4px; }
            .tone-desc { font-size: 0.75rem; }
            .tone-example { padding: 6px; margin-top: 6px; }
            .buttons { gap: 8px; }
            .action-btn { padding: 8px 16px; font-size: 0.85rem; }
            .quiz-word { font-size: 2.5rem; }
            .quiz-zhuyin { font-size: 1.1rem; }
            .progress-section { padding: 8px; }
        }
    </style>
</head>
<body>
    <nav class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="mode-display" id="modeDisplay">é¸æ“‡æ¨¡å¼</div>
    </nav>

    <div class="game-area">
        <!-- æ¨¡å¼é¸æ“‡ -->
        <div class="mode-selector" id="modeSelector">
            <h2>è²èª¿ç·´ç¿’</h2>
            <div class="mode-buttons">
                <div class="mode-btn" onclick="startLearnMode()">
                    <div class="icon">ğŸ“–</div>
                    <div class="name">å­¸ç¿’æ¨¡å¼</div>
                    <div class="desc">èªè­˜äº”ç¨®è²èª¿</div>
                </div>
                <div class="mode-btn" onclick="startQuizMode()">
                    <div class="icon">ğŸ¯</div>
                    <div class="name">æ¸¬é©—æ¨¡å¼</div>
                    <div class="desc">è½éŸ³è¾¨è­˜è²èª¿</div>
                </div>
            </div>
        </div>

        <!-- å­¸ç¿’æ¨¡å¼ -->
        <div class="tone-learn-section" id="learnSection">
            <div class="tone-card">
                <div class="tone-display">
                    <span class="tone-symbol" id="toneSymbol">ã„‡ã„š</span>
                    <span class="tone-mark" id="toneMark">Ë‰</span>
                </div>
                <div class="tone-name" id="toneName">ç¬¬ä¸€è²ï¼ˆé™°å¹³ï¼‰</div>
                <div class="tone-desc" id="toneDesc">è²éŸ³ä¿æŒé«˜è€Œå¹³ç©©ï¼Œåƒå”±æ­Œæ™‚çš„é«˜éŸ³ã€‚</div>
                <div class="tone-example">
                    <div class="tone-example-title">ä¾‹è©</div>
                    <div class="tone-example-word" id="toneExampleWord">åª½åª½</div>
                    <div class="tone-example-zhuyin" id="toneExampleZhuyin">ã„‡ã„š ã„‡ã„š</div>
                </div>
            </div>

            <div class="buttons">
                <button class="action-btn" onclick="playToneSound()">ğŸ”Š è½ç™¼éŸ³</button>
                <button class="action-btn next" onclick="nextTone()">ä¸‹ä¸€å€‹ â†’</button>
            </div>

            <div class="tone-list" id="toneList"></div>
        </div>

        <!-- æ¸¬é©—æ¨¡å¼ -->
        <div class="tone-quiz-section" id="quizSection">
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text">ç¬¬ <span id="currentRound">1</span> / <span id="totalRounds">10</span> é¡Œ</div>
            </div>

            <div class="quiz-card">
                <div class="quiz-word" id="quizWord">åª½</div>
                <div class="quiz-zhuyin" id="quizZhuyin">ã„‡ã„š</div>
                <div class="quiz-hint">é€™å€‹å­—æ˜¯ç¬¬å¹¾è²ï¼Ÿ</div>
            </div>

            <button class="action-btn" onclick="playQuizSound()">ğŸ”Š å†è½ä¸€æ¬¡</button>

            <div class="quiz-choices" id="quizChoices"></div>

            <div class="result-message" id="resultMessage"></div>
        </div>
    </div>

    <div class="fireworks" id="fireworks"></div>

    <div class="complete-overlay" id="completeOverlay">
        <div class="complete-content">
            <div class="complete-icon">ğŸ‰</div>
            <div class="complete-title">å¤ªæ£’äº†ï¼</div>
            <div class="complete-score" id="completeScore">å¾—åˆ†ï¼š100 åˆ†</div>
            <button class="complete-btn" onclick="restartQuiz()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
            <button class="complete-btn" onclick="backToMenu()" style="background: linear-gradient(135deg, #667eea, #764ba2);">ğŸ  è¿”å›é¸å–®</button>
        </div>
    </div>

    <script>
        // è²èª¿è³‡æ–™
        const TONES = [
            {
                id: 1,
                name: 'ç¬¬ä¸€è²ï¼ˆé™°å¹³ï¼‰',
                mark: 'Ë‰',
                markAlt: 'âˆ’',
                desc: 'è²éŸ³ä¿æŒé«˜è€Œå¹³ç©©ï¼Œåƒå”±æ­Œæ™‚çš„é«˜éŸ³ã€‚éŸ³èª¿å¾é ­åˆ°å°¾éƒ½æ˜¯é«˜çš„ã€‚',
                example: { word: 'åª½åª½', zhuyin: 'ã„‡ã„š ã„‡ã„š' },
                sample: 'ã„‡ã„š',
                words: [
                    { word: 'åª½', zhuyin: 'ã„‡ã„š' },
                    { word: 'ä»–', zhuyin: 'ã„Šã„š' },
                    { word: 'æ›¸', zhuyin: 'ã„•ã„¨' },
                    { word: 'é£›', zhuyin: 'ã„ˆã„Ÿ' },
                    { word: 'å¤©', zhuyin: 'ã„Šã„§ã„¢' }
                ]
            },
            {
                id: 2,
                name: 'ç¬¬äºŒè²ï¼ˆé™½å¹³ï¼‰',
                mark: 'ËŠ',
                desc: 'è²éŸ³å¾ä¸­é–“å¾€ä¸Šæšï¼Œåƒåœ¨å•å•é¡Œæ™‚çš„èªèª¿ã€‚éŸ³èª¿ç”±ä½å‡åˆ°é«˜ã€‚',
                example: { word: 'éº»ç…©', zhuyin: 'ã„‡ã„šËŠ ã„ˆã„¢ËŠ' },
                sample: 'ã„‡ã„šËŠ',
                words: [
                    { word: 'éº»', zhuyin: 'ã„‡ã„šËŠ' },
                    { word: 'äºº', zhuyin: 'ã„–ã„£ËŠ' },
                    { word: 'ä¾†', zhuyin: 'ã„Œã„ËŠ' },
                    { word: 'ç´…', zhuyin: 'ã„ã„¨ã„¥ËŠ' },
                    { word: 'å¹´', zhuyin: 'ã„‹ã„§ã„¢ËŠ' }
                ]
            },
            {
                id: 3,
                name: 'ç¬¬ä¸‰è²ï¼ˆä¸Šè²ï¼‰',
                mark: 'Ë‡',
                desc: 'è²éŸ³å…ˆä¸‹é™å†ä¸Šæšï¼Œåƒåœ¨çŒ¶è±«æˆ–æ€è€ƒæ™‚çš„ã€Œå—¯...ã€ã€‚éŸ³èª¿å…ˆä½å¾Œé«˜ã€‚',
                example: { word: 'é¦¬ä¸Š', zhuyin: 'ã„‡ã„šË‡ ã„•ã„¤Ë‹' },
                sample: 'ã„‡ã„šË‡',
                words: [
                    { word: 'é¦¬', zhuyin: 'ã„‡ã„šË‡' },
                    { word: 'ä½ ', zhuyin: 'ã„‹ã„§Ë‡' },
                    { word: 'å¥½', zhuyin: 'ã„ã„ Ë‡' },
                    { word: 'å°', zhuyin: 'ã„’ã„§ã„ Ë‡' },
                    { word: 'æ°´', zhuyin: 'ã„•ã„¨ã„ŸË‡' }
                ]
            },
            {
                id: 4,
                name: 'ç¬¬å››è²ï¼ˆå»è²ï¼‰',
                mark: 'Ë‹',
                desc: 'è²éŸ³å¾é«˜è™•å¿«é€Ÿå¾€ä¸‹é™ï¼Œåƒåœ¨å‘½ä»¤æˆ–å¼·èª¿æ™‚çš„èªæ°£ã€‚éŸ³èª¿ç”±é«˜é™åˆ°ä½ã€‚',
                example: { word: 'ç½µäºº', zhuyin: 'ã„‡ã„šË‹ ã„–ã„£ËŠ' },
                sample: 'ã„‡ã„šË‹',
                words: [
                    { word: 'ç½µ', zhuyin: 'ã„‡ã„šË‹' },
                    { word: 'å¤§', zhuyin: 'ã„‰ã„šË‹' },
                    { word: 'æ˜¯', zhuyin: 'ã„•Ë‹' },
                    { word: 'å»', zhuyin: 'ã„‘ã„©Ë‹' },
                    { word: 'å¿«', zhuyin: 'ã„ã„¨ã„Ë‹' }
                ]
            },
            {
                id: 0,
                name: 'è¼•è²',
                mark: 'Ë™',
                desc: 'è²éŸ³è¼•è¼•çš„ã€çŸ­çŸ­çš„ï¼Œæ²’æœ‰æ˜é¡¯çš„éŸ³èª¿è®ŠåŒ–ã€‚é€šå¸¸å‡ºç¾åœ¨è©å°¾æˆ–åŠ©è©ã€‚',
                example: { word: 'åª½åª½', zhuyin: 'ã„‡ã„š Ë™ã„‡ã„š' },
                sample: 'Ë™ã„‡ã„š',
                words: [
                    { word: 'å—', zhuyin: 'Ë™ã„‡ã„š' },
                    { word: 'çš„', zhuyin: 'Ë™ã„‰ã„œ' },
                    { word: 'äº†', zhuyin: 'Ë™ã„Œã„œ' },
                    { word: 'å‘¢', zhuyin: 'Ë™ã„‹ã„œ' },
                    { word: 'å§', zhuyin: 'Ë™ã„…ã„š' }
                ]
            }
        ];

        let currentMode = 'menu'; // menu, learn, quiz
        let currentToneIndex = 0;
        let quizRound = 0;
        let totalRounds = 10;
        let score = 0;
        let quizQuestions = [];
        let currentQuestion = null;
        let answered = false;

        // åˆå§‹åŒ–
        function init() {
            renderToneList();
        }

        function renderToneList() {
            const list = document.getElementById('toneList');
            list.innerHTML = '';

            TONES.forEach((tone, index) => {
                const item = document.createElement('div');
                item.className = 'tone-item' + (index === currentToneIndex ? ' current' : '');
                item.innerHTML = `
                    <div class="mark">${tone.mark}</div>
                    <div class="label">${tone.id === 0 ? 'è¼•è²' : 'ç¬¬' + tone.id + 'è²'}</div>
                `;
                item.onclick = () => selectTone(index);
                list.appendChild(item);
            });
        }

        function selectTone(index) {
            currentToneIndex = index;
            displayCurrentTone();
            renderToneList();
            playToneSound();
        }

        function displayCurrentTone() {
            const tone = TONES[currentToneIndex];
            document.getElementById('toneSymbol').textContent = tone.sample.replace(/[Ë‰ËŠË‡Ë‹Ë™]/g, '');
            document.getElementById('toneMark').textContent = tone.mark;
            document.getElementById('toneName').textContent = tone.name;
            document.getElementById('toneDesc').textContent = tone.desc;
            document.getElementById('toneExampleWord').textContent = tone.example.word;
            document.getElementById('toneExampleZhuyin').textContent = tone.example.zhuyin;
        }

        function playToneSound() {
            const tone = TONES[currentToneIndex];
            speak(tone.sample);
        }

        function nextTone() {
            currentToneIndex = (currentToneIndex + 1) % TONES.length;
            displayCurrentTone();
            renderToneList();
            playToneSound();
        }

        // å­¸ç¿’æ¨¡å¼
        function startLearnMode() {
            currentMode = 'learn';
            document.getElementById('modeSelector').style.display = 'none';
            document.getElementById('learnSection').classList.add('active');
            document.getElementById('modeDisplay').textContent = 'å­¸ç¿’æ¨¡å¼';

            currentToneIndex = 0;
            displayCurrentTone();
            renderToneList();

            speak('é–‹å§‹å­¸ç¿’è²èª¿ï¼åœ‹èªæœ‰äº”ç¨®è²èª¿ï¼Œåˆ†åˆ¥æ˜¯ä¸€è²ã€äºŒè²ã€ä¸‰è²ã€å››è²å’Œè¼•è²ã€‚', () => {
                setTimeout(playToneSound, 500);
            });
        }

        // æ¸¬é©—æ¨¡å¼
        function startQuizMode() {
            currentMode = 'quiz';
            document.getElementById('modeSelector').style.display = 'none';
            document.getElementById('quizSection').classList.add('active');
            document.getElementById('modeDisplay').textContent = 'æ¸¬é©—æ¨¡å¼';

            initQuiz();
        }

        function initQuiz() {
            quizRound = 0;
            score = 0;
            quizQuestions = generateQuizQuestions();
            renderQuizChoices();
            nextQuizRound();
        }

        function generateQuizQuestions() {
            let questions = [];
            // å¾æ¯å€‹è²èª¿ä¸­æŠ½å–å–®å­—
            TONES.forEach(tone => {
                tone.words.forEach(word => {
                    questions.push({
                        word: word.word,
                        zhuyin: word.zhuyin,
                        toneId: tone.id,
                        toneMark: tone.mark,
                        toneName: tone.name
                    });
                });
            });
            // æ‰“äº‚é †åºä¸¦å–å‰ totalRounds é¡Œ
            return shuffle(questions).slice(0, totalRounds);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderQuizChoices() {
            const container = document.getElementById('quizChoices');
            container.innerHTML = '';

            TONES.forEach((tone, index) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-choice';
                btn.dataset.toneId = tone.id;
                btn.innerHTML = `
                    <span class="mark">${tone.mark}</span>
                    <span class="name">${tone.id === 0 ? 'è¼•è²' : tone.id + 'è²'}</span>
                `;
                btn.onclick = () => checkQuizAnswer(tone.id);
                container.appendChild(btn);
            });
        }

        function nextQuizRound() {
            if (quizRound >= totalRounds) {
                endQuiz();
                return;
            }

            answered = false;
            currentQuestion = quizQuestions[quizRound];
            quizRound++;

            document.getElementById('currentRound').textContent = quizRound;
            document.getElementById('progressFill').style.width = ((quizRound - 1) / totalRounds * 100) + '%';
            document.getElementById('quizWord').textContent = currentQuestion.word;
            document.getElementById('quizZhuyin').textContent = currentQuestion.zhuyin;
            document.getElementById('resultMessage').textContent = '';

            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            const buttons = document.querySelectorAll('.quiz-choice');
            buttons.forEach(btn => {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = false;
            });

            // æ’­æ”¾ç™¼éŸ³
            setTimeout(() => playQuizSound(), 500);
        }

        function playQuizSound() {
            speak(currentQuestion.word);
        }

        function checkQuizAnswer(selectedToneId) {
            if (answered) return;
            answered = true;

            const buttons = document.querySelectorAll('.quiz-choice');
            buttons.forEach(btn => btn.disabled = true);

            const selectedBtn = document.querySelector(`.quiz-choice[data-tone-id="${selectedToneId}"]`);
            const correctBtn = document.querySelector(`.quiz-choice[data-tone-id="${currentQuestion.toneId}"]`);

            if (selectedToneId === currentQuestion.toneId) {
                selectedBtn.classList.add('correct');
                score += 10;
                const encouragement = ['å¤ªæ£’äº†ï¼', 'ç­”å°äº†ï¼', 'å¥½å²å®³ï¼', 'çœŸè°æ˜ï¼'][Math.floor(Math.random() * 4)];
                document.getElementById('resultMessage').textContent = encouragement;
                speak(encouragement);
                createFireworks(20);
            } else {
                selectedBtn.classList.add('wrong');
                correctBtn.classList.add('correct');
                document.getElementById('resultMessage').textContent = `æ˜¯${currentQuestion.toneName}å–”ï¼`;
                speak('æ˜¯' + currentQuestion.toneName);
            }

            setTimeout(nextQuizRound, 2000);
        }

        function endQuiz() {
            document.getElementById('completeScore').textContent = `å¾—åˆ†ï¼š${score} åˆ†`;
            document.getElementById('completeOverlay').classList.add('show');
            createFireworks(50);
            speak(`å¤ªæ£’äº†ï¼ä½ å¾—äº†${score}åˆ†ï¼`);
        }

        function restartQuiz() {
            document.getElementById('completeOverlay').classList.remove('show');
            initQuiz();
        }

        function backToMenu() {
            document.getElementById('completeOverlay').classList.remove('show');
            document.getElementById('learnSection').classList.remove('active');
            document.getElementById('quizSection').classList.remove('active');
            document.getElementById('modeSelector').style.display = 'block';
            document.getElementById('modeDisplay').textContent = 'é¸æ“‡æ¨¡å¼';
            currentMode = 'menu';
        }

        // èªéŸ³åˆæˆ
        function speak(text, callback) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.8;
                utterance.pitch = 1.1;
                if (callback) {
                    utterance.onend = callback;
                }
                window.speechSynthesis.speak(utterance);
            }
        }

        // ç…™ç«æ•ˆæœ
        function createFireworks(count) {
            const container = document.getElementById('fireworks');
            const emojis = ['âœ¨', 'ğŸ‰', 'ğŸŠ', 'â­', 'ğŸ’«', 'ğŸŒŸ'];

            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                firework.style.left = Math.random() * 100 + '%';
                firework.style.top = Math.random() * 100 + '%';
                firework.style.fontSize = (2 + Math.random() * 2) + 'rem';
                firework.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(firework);
            }
            setTimeout(() => { container.innerHTML = ''; }, 2000);
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
