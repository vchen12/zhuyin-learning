<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#87CEEB">
    <link rel="manifest" href="../../manifest.json">
    <title>ğŸ¦… å°„æ“ŠæŒ‘æˆ°</title>
    <script src="../../js/config.js"></script>
    <script src="../../js/prevent-zoom.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
        }

        /* å¤©ç©ºèƒŒæ™¯ */
        .sky {
            flex: 1;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            position: relative;
            overflow: hidden;
        }

        /* é›²æœµ */
        .cloud {
            position: absolute;
            font-size: 3rem;
            opacity: 0.7;
            animation: cloud-float 20s linear infinite;
        }
        @keyframes cloud-float {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100px); }
        }

        /* åœ°é¢ */
        .ground {
            height: 120px;
            background: linear-gradient(180deg, #7CBA5F 0%, #5A9A3F 100%);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 10px;
        }

        /* å°æœ‹å‹ */
        .child {
            font-size: 4rem;
            animation: child-bounce 0.5s ease-in-out infinite;
        }
        .child.happy {
            animation: child-jump 0.5s ease-out;
        }
        @keyframes child-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes child-jump {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.2); }
            100% { transform: translateY(0) scale(1); }
        }

        /* ç¦®ç‰©ç±ƒ */
        .gift-basket {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
        }

        /* è€é·¹å’Œç¦®ç‰©è¢‹ */
        .eagle-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: eagle-fly linear forwards;
            cursor: pointer;
        }
        .eagle {
            font-size: 4rem;
            animation: eagle-flap 0.3s ease-in-out infinite;
        }
        .gift-bag {
            font-size: 2rem;
            background: white;
            border-radius: 15px;
            padding: 10px 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: -10px;
        }
        .gift-symbol {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
        }
        .gift-icon {
            font-size: 1.5rem;
        }
        @keyframes eagle-flap {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        @keyframes eagle-fly {
            from { right: -150px; }
            to { right: calc(100% + 150px); }
        }

        /* æ‰è½çš„ç¦®ç‰© */
        .falling-gift {
            position: absolute;
            font-size: 2rem;
            animation: gift-fall 1s ease-in forwards;
        }
        @keyframes gift-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(200px) rotate(360deg); opacity: 0; }
        }

        /* å°èˆªåˆ— */
        .nav-bar {
            flex-shrink: 0;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .back-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
        }
        .nav-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .score-display {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        /* éº¥å…‹é¢¨æŒ‡ç¤º */
        .mic-indicator {
            position: fixed;
            bottom: 140px;
            right: 20px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 100;
        }
        .mic-indicator.listening {
            animation: mic-pulse 0.6s ease-in-out infinite;
            border-color: #ffd700;
        }
        @keyframes mic-pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); }
        }

        /* æç¤ºè¨Šæ¯ */
        .hint-message {
            position: fixed;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            z-index: 100;
            white-space: nowrap;
        }

        /* é–‹å§‹/çµæŸç•«é¢ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 20px;
        }
        .overlay.hidden {
            display: none;
        }
        .overlay-content {
            background: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            max-width: 450px;
            width: 100%;
        }
        .overlay h1 {
            color: #667eea;
            font-size: 2rem;
            margin-bottom: 15px;
        }
        .overlay p {
            color: #666;
            font-size: 1.1rem;
            margin: 12px 0;
        }
        .start-btn {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            border: none;
            padding: 18px 40px;
            border-radius: 25px;
            font-size: 1.3rem;
            color: white;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
        }
        .end-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* æ”¶é›†åˆ°çš„ç¦®ç‰©é¡¯ç¤º */
        .collected-gifts {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 50;
        }
        .collected-gift {
            font-size: 1.5rem;
            animation: gift-pop 0.3s ease-out;
        }
        @keyframes gift-pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 480px) {
            .eagle { font-size: 3rem; }
            .gift-symbol { font-size: 2.5rem; }
            .child { font-size: 3rem; }
            .ground { height: 100px; }
            .mic-indicator { width: 60px; height: 60px; font-size: 1.5rem; bottom: 110px; }
            .hint-message { font-size: 1rem; bottom: 180px; }
        }
    </style>
</head>
<body>
    <!-- é–‹å§‹ç•«é¢ -->
    <div class="overlay" id="startOverlay">
        <div class="overlay-content">
            <h1>ğŸ¦… å°„æ“ŠæŒ‘æˆ°</h1>
            <p>è€é·¹æŠ“è‘—æ³¨éŸ³ç¦®ç‰©è¢‹é£›éå¤©ç©ºï¼</p>
            <p>å¤§è²å”¸å‡ºæ­£ç¢ºçš„æ³¨éŸ³ç¬¦è™Ÿï¼Œ<br>å°±èƒ½æ‰“ä¸‹ç¦®ç‰©çµ¦å°æœ‹å‹ï¼</p>
            <p style="font-size: 0.95rem; color: #888;">æç¤ºï¼šå”¸ 2~3 æ¬¡æ•ˆæœæ›´å¥½</p>
            <button class="start-btn" onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
        </div>
    </div>

    <!-- çµæŸç•«é¢ -->
    <div class="overlay hidden" id="endOverlay">
        <div class="overlay-content">
            <h1>ğŸ‰ éŠæˆ²çµæŸï¼</h1>
            <p id="finalScore">å¾—åˆ†ï¼š0 åˆ†</p>
            <p id="finalGifts">æ”¶é›†äº† 0 å€‹ç¦®ç‰©</p>
            <div class="end-buttons">
                <button class="start-btn" onclick="restartGame()">ğŸ”„ å†ç©ä¸€æ¬¡</button>
                <button class="start-btn" onclick="location.href='../index.html'" style="background: linear-gradient(135deg, #667eea, #764ba2);">ğŸ  è¿”å›é¸å–®</button>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²ç•«é¢ -->
    <div class="nav-bar">
        <a href="../index.html" class="back-btn">â† è¿”å›</a>
        <div class="nav-info">
            <div class="score-display">å¾—åˆ†ï¼š<span id="score">0</span></div>
            <div class="score-display">ğŸ <span id="giftCount">0</span></div>
        </div>
    </div>

    <div class="sky" id="sky">
        <!-- é›²æœµæœƒå‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div class="ground">
        <div class="gift-basket">ğŸ§º</div>
        <div class="child" id="child">ğŸ§’</div>
    </div>

    <div class="collected-gifts" id="collectedGifts"></div>
    <div class="mic-indicator" id="micIndicator">ğŸ¤</div>
    <div class="hint-message" id="hintMessage">æº–å‚™ä¸­...</div>

    <script>
        // æ³¨éŸ³ç¬¦è™Ÿ
        const ALL_SYMBOLS = [
            'ã„…', 'ã„†', 'ã„‡', 'ã„ˆ', 'ã„‰', 'ã„Š', 'ã„‹', 'ã„Œ', 'ã„', 'ã„', 'ã„',
            'ã„', 'ã„‘', 'ã„’', 'ã„“', 'ã„”', 'ã„•', 'ã„–', 'ã„—', 'ã„˜', 'ã„™',
            'ã„š', 'ã„›', 'ã„œ', 'ã„', 'ã„', 'ã„Ÿ', 'ã„ ', 'ã„¡', 'ã„¢', 'ã„£', 'ã„¤', 'ã„¥', 'ã„¦', 'ã„§', 'ã„¨', 'ã„©'
        ];

        const SOUND_MAP = {
            'ã„…': 'F1', 'ã„†': 'F2', 'ã„‡': 'F3', 'ã„ˆ': 'F4', 'ã„‰': 'F5', 'ã„Š': 'F6', 'ã„‹': 'F7', 'ã„Œ': 'F8',
            'ã„': 'F9', 'ã„': 'F10', 'ã„': 'F11', 'ã„': 'F12', 'ã„‘': 'F13', 'ã„’': 'F14', 'ã„“': 'F15', 'ã„”': 'F16',
            'ã„•': 'F17', 'ã„–': 'F18', 'ã„—': 'F19', 'ã„˜': 'F20', 'ã„™': 'F21',
            'ã„š': 'F22', 'ã„›': 'F23', 'ã„œ': 'F24', 'ã„': 'F25', 'ã„': 'F26', 'ã„Ÿ': 'F27', 'ã„ ': 'F28', 'ã„¡': 'F29',
            'ã„¢': 'F30', 'ã„£': 'F31', 'ã„¤': 'F32', 'ã„¥': 'F33', 'ã„¦': 'F34', 'ã„§': 'F35', 'ã„¨': 'F36', 'ã„©': 'F37'
        };

        const GIFT_EMOJIS = ['ğŸ¬', 'ğŸ­', 'ğŸ«', 'ğŸˆ', 'â­', 'ğŸŒŸ', 'ğŸ’', 'ğŸ†'];

        // éŠæˆ²ç‹€æ…‹
        let score = 0;
        let giftCount = 0;
        let currentSymbol = '';
        let currentEagle = null;
        let isListening = false;
        let gameActive = false;
        let eagleTimeout = null;
        let recognition = null;
        let recognitionTimeout = null;

        // VAD ç›¸é—œ
        let audioContext = null;
        let analyser = null;
        let vadInterval = null;
        let hasDetectedVoice = false;
        const VAD_THRESHOLD = 50;

        // åˆå§‹åŒ–é›²æœµ
        function initClouds() {
            const sky = document.getElementById('sky');
            for (let i = 0; i < 5; i++) {
                const cloud = document.createElement('div');
                cloud.className = 'cloud';
                cloud.textContent = 'â˜ï¸';
                cloud.style.top = (Math.random() * 60) + '%';
                cloud.style.animationDelay = (Math.random() * 20) + 's';
                cloud.style.fontSize = (2 + Math.random() * 2) + 'rem';
                sky.appendChild(cloud);
            }
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            document.getElementById('startOverlay').classList.add('hidden');
            gameActive = true;
            score = 0;
            giftCount = 0;
            updateUI();

            initRecognition();
            initVAD();

            const userName = getUserName();
            const greeting = userName ? `${userName}ï¼Œ` : '';
            speak(`${greeting}å°„æ“ŠæŒ‘æˆ°é–‹å§‹ï¼å¤§è²å”¸å‡ºæ³¨éŸ³ç¬¦è™Ÿï¼Œæ‰“ä¸‹ç¦®ç‰©å§ï¼`, () => {
                setTimeout(spawnEagle, 1000);
            });
        }

        // åˆå§‹åŒ– VAD
        async function initVAD() {
            if (audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                microphone.connect(analyser);
            } catch (e) {
                console.error('VAD åˆå§‹åŒ–å¤±æ•—:', e);
            }
        }

        // é–‹å§‹ VAD
        function startVAD() {
            if (!analyser) return;
            hasDetectedVoice = false;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            vadInterval = setInterval(() => {
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                if (average > VAD_THRESHOLD && !hasDetectedVoice) {
                    hasDetectedVoice = true;
                    showHint('ğŸ¤ è½åˆ°ä½ çš„è²éŸ³äº†ï¼æ­£åœ¨è¾¨è­˜...');
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                }
            }, 50);
        }

        function stopVAD() {
            if (vadInterval) {
                clearInterval(vadInterval);
                vadInterval = null;
            }
        }

        // åˆå§‹åŒ–èªéŸ³è¾¨è­˜
        function initRecognition() {
            if (recognition) return;

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œå»ºè­°ä½¿ç”¨ Chromeã€‚');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 5;

            let lastTranscript = '';
            let hasResult = false;

            recognition.onstart = () => {
                isListening = true;
                hasResult = false;
                lastTranscript = '';
                document.getElementById('micIndicator').classList.add('listening');
            };

            recognition.onresult = (event) => {
                if (hasResult) return;

                const result = event.results[event.results.length - 1];
                const transcript = result[0].transcript.trim();

                // éæ¿¾ç³»çµ±èªéŸ³
                if (transcript.includes('è«‹å”¸') || transcript.includes('å…©åˆ°ä¸‰æ¬¡')) return;

                if (transcript) {
                    lastTranscript = transcript;
                    showHint('ğŸ¤ è½åˆ°ï¼š' + transcript);
                    processResult(transcript);
                    hasResult = true;
                }
            };

            recognition.onend = () => {
                isListening = false;
                stopVAD();
                document.getElementById('micIndicator').classList.remove('listening');

                if (!hasResult && lastTranscript) {
                    processResult(lastTranscript);
                } else if (!hasResult && !lastTranscript) {
                    if (hasDetectedVoice) {
                        showHint('è½åˆ°è²éŸ³äº†ï¼Œä½†è¾¨è­˜ä¸æ¸…æ¥šï¼Œè«‹å†è©¦ä¸€æ¬¡ï¼');
                    }
                }

                // å¦‚æœéŠæˆ²é‚„åœ¨é€²è¡Œä¸”æœ‰è€é·¹åœ¨é£›ï¼Œç¹¼çºŒè†è½
                if (gameActive && currentEagle) {
                    setTimeout(() => {
                        if (gameActive && currentEagle) {
                            startListening();
                        }
                    }, 300);
                }
            };

            recognition.onerror = (event) => {
                console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
                isListening = false;
                document.getElementById('micIndicator').classList.remove('listening');
            };
        }

        // é–‹å§‹è†è½
        function startListening() {
            if (isListening || !recognition) return;

            startVAD();
            try {
                recognition.start();
            } catch (e) {
                console.error('å•Ÿå‹•è¾¨è­˜å¤±æ•—:', e);
            }

            // 8 ç§’è¶…æ™‚
            clearTimeout(recognitionTimeout);
            recognitionTimeout = setTimeout(() => {
                if (isListening) {
                    try { recognition.stop(); } catch (e) {}
                }
            }, 8000);
        }

        // è™•ç†è¾¨è­˜çµæœ
        function processResult(transcript) {
            if (!currentEagle || !currentSymbol) return;

            // è¨ˆç®—ç›¸ä¼¼åº¦
            const similarity = calculateSimilarity(transcript, currentSymbol);
            const passes = passesSimilarityThreshold(similarity);

            // è¨˜éŒ„ç™¼éŸ³
            recordPronunciation('zhuyin', currentSymbol, transcript, similarity);

            if (passes) {
                hitEagle();
            }
        }

        // ç”Ÿæˆè€é·¹
        function spawnEagle() {
            if (!gameActive) return;

            // éš¨æ©Ÿé¸æ“‡ç¬¦è™Ÿ
            currentSymbol = ALL_SYMBOLS[Math.floor(Math.random() * ALL_SYMBOLS.length)];

            // å‰µå»ºè€é·¹å®¹å™¨
            const sky = document.getElementById('sky');
            const eagle = document.createElement('div');
            eagle.className = 'eagle-container';
            eagle.id = 'currentEagle';

            // éš¨æ©Ÿé«˜åº¦
            const topPosition = 10 + Math.random() * 40;
            eagle.style.top = topPosition + '%';

            // é£›è¡Œæ™‚é–“ï¼ˆè¼ƒæ…¢è®“ç©å®¶æœ‰æ™‚é–“åæ‡‰ï¼‰
            const flyDuration = 8 + Math.random() * 4;
            eagle.style.animationDuration = flyDuration + 's';

            // éš¨æ©Ÿç¦®ç‰©
            const giftEmoji = GIFT_EMOJIS[Math.floor(Math.random() * GIFT_EMOJIS.length)];

            eagle.innerHTML = `
                <div class="eagle">ğŸ¦…</div>
                <div class="gift-bag">
                    <div class="gift-symbol">${currentSymbol}</div>
                    <div class="gift-icon">${giftEmoji}</div>
                </div>
            `;

            eagle.onclick = () => playSound(currentSymbol);

            sky.appendChild(eagle);
            currentEagle = eagle;

            // æ’­æ”¾ç™¼éŸ³ä¸¦é–‹å§‹è†è½
            showHint(`å¤§è²å”¸ã€Œ${currentSymbol}ã€ï¼`);
            playSound(currentSymbol);

            setTimeout(() => {
                speakShort('è«‹å”¸å…©åˆ°ä¸‰æ¬¡');
                startListening();
            }, 500);

            // è€é·¹é£›èµ°æ™‚
            eagle.addEventListener('animationend', () => {
                if (currentEagle === eagle) {
                    eagleMissed();
                }
            });
        }

        // æ“Šä¸­è€é·¹
        function hitEagle() {
            if (!currentEagle) return;

            const eagle = currentEagle;
            const rect = eagle.getBoundingClientRect();

            // åœæ­¢è†è½
            clearTimeout(recognitionTimeout);
            if (isListening) {
                try { recognition.stop(); } catch (e) {}
            }
            stopVAD();

            // ç§»é™¤è€é·¹
            eagle.remove();
            currentEagle = null;

            // æ‰è½ç¦®ç‰©å‹•ç•«
            const sky = document.getElementById('sky');
            const fallingGift = document.createElement('div');
            fallingGift.className = 'falling-gift';
            fallingGift.textContent = GIFT_EMOJIS[Math.floor(Math.random() * GIFT_EMOJIS.length)];
            fallingGift.style.left = rect.left + rect.width / 2 + 'px';
            fallingGift.style.top = rect.top + 'px';
            sky.appendChild(fallingGift);

            setTimeout(() => fallingGift.remove(), 1000);

            // æ›´æ–°åˆ†æ•¸
            score += 10;
            giftCount++;
            updateUI();

            // å°æœ‹å‹é–‹å¿ƒ
            const child = document.getElementById('child');
            child.classList.add('happy');
            setTimeout(() => child.classList.remove('happy'), 500);

            // åŠ å…¥æ”¶é›†çš„ç¦®ç‰©
            addCollectedGift();

            // é¼“å‹µèª
            const encouragement = getEncouragement('correct');
            showHint('ğŸ‰ ' + encouragement);
            speak(encouragement);

            // ç”Ÿæˆä¸‹ä¸€éš»è€é·¹
            setTimeout(spawnEagle, 2500);
        }

        // è€é·¹é£›èµ°
        function eagleMissed() {
            if (!currentEagle) return;

            currentEagle.remove();
            currentEagle = null;

            clearTimeout(recognitionTimeout);
            if (isListening) {
                try { recognition.stop(); } catch (e) {}
            }
            stopVAD();

            showHint('è€é·¹é£›èµ°äº†ï¼Œå†è©¦ä¸€æ¬¡ï¼');

            // ç”Ÿæˆä¸‹ä¸€éš»è€é·¹
            setTimeout(spawnEagle, 1500);

            // æª¢æŸ¥æ˜¯å¦çµæŸï¼ˆæ”¶é›† 10 å€‹ç¦®ç‰©æˆ–ç©äº†ä¸€æ®µæ™‚é–“ï¼‰
            if (giftCount >= 10) {
                setTimeout(endGame, 1000);
            }
        }

        // åŠ å…¥æ”¶é›†çš„ç¦®ç‰©
        function addCollectedGift() {
            const container = document.getElementById('collectedGifts');
            const gift = document.createElement('span');
            gift.className = 'collected-gift';
            gift.textContent = GIFT_EMOJIS[Math.floor(Math.random() * GIFT_EMOJIS.length)];
            container.appendChild(gift);

            // æœ€å¤šé¡¯ç¤º 10 å€‹
            if (container.children.length > 10) {
                container.removeChild(container.firstChild);
            }
        }

        // æ’­æ”¾éŸ³æª”
        function playSound(symbol) {
            const fileNum = SOUND_MAP[symbol];
            if (!fileNum) return;
            const audio = new Audio(`../../sounds/${fileNum}.mp3`);
            audio.play().catch(e => console.error('æ’­æ”¾å¤±æ•—:', e));
        }

        // èªéŸ³åˆæˆ
        function speak(text, callback) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                if (callback) utterance.onend = callback;
                window.speechSynthesis.speak(utterance);
            } else if (callback) {
                callback();
            }
        }

        function speakShort(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                utterance.volume = 0.8;
                window.speechSynthesis.speak(utterance);
            }
        }

        // é¡¯ç¤ºæç¤º
        function showHint(message) {
            document.getElementById('hintMessage').textContent = message;
        }

        // æ›´æ–° UI
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('giftCount').textContent = giftCount;
        }

        // çµæŸéŠæˆ²
        function endGame() {
            gameActive = false;

            clearTimeout(recognitionTimeout);
            if (isListening) {
                try { recognition.stop(); } catch (e) {}
            }
            stopVAD();

            if (currentEagle) {
                currentEagle.remove();
                currentEagle = null;
            }

            document.getElementById('endOverlay').classList.remove('hidden');
            document.getElementById('finalScore').textContent = 'å¾—åˆ†ï¼š' + score + ' åˆ†';
            document.getElementById('finalGifts').textContent = 'æ”¶é›†äº† ' + giftCount + ' å€‹ç¦®ç‰©';

            const userName = getUserName();
            const msg = userName ? `${userName}ï¼Œå¤ªæ£’äº†ï¼ä½ æ”¶é›†äº†${giftCount}å€‹ç¦®ç‰©ï¼` : `å¤ªæ£’äº†ï¼ä½ æ”¶é›†äº†${giftCount}å€‹ç¦®ç‰©ï¼`;
            speak(msg);
        }

        // é‡æ–°é–‹å§‹
        function restartGame() {
            document.getElementById('endOverlay').classList.add('hidden');
            document.getElementById('collectedGifts').innerHTML = '';
            startGame();
        }

        // åˆå§‹åŒ–
        initClouds();
    </script>
</body>
</html>
